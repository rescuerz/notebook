
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="rescuerz's notebook">
      
      
      
      
        <link rel="prev" href="../2.%20Relational%20Model/">
      
      
        <link rel="next" href="../6.%20Entity-Relationship%20Model/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>3. SQL - rescuerz's notebook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeline.css">
    
      <link rel="stylesheet" href="../../supports/css/base.css">
    
      <link rel="stylesheet" href="../../supports/css/theme.css">
    
      <link rel="stylesheet" href="../../supports/css/admonitions.css">
    
      <link rel="stylesheet" href="https://jsd.cdn.zzko.cn/npm/katex@0.16.4/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#三-introduction-to-sql" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="rescuerz&#39;s notebook" class="md-header__button md-logo" aria-label="rescuerz's notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            rescuerz's notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3. SQL
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/rescuerz/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    rescuerz/notebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ADS/" class="md-tabs__link">
          
  
    
  
  Computer Science

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  System

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../CV/" class="md-tabs__link">
          
  
    
  
  Artificial Intelligence

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="rescuerz&#39;s notebook" class="md-nav__button md-logo" aria-label="rescuerz's notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    rescuerz's notebook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rescuerz/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    rescuerz/notebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Home
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    更新记录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../link/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    友链
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Computer Science
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Computer Science
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../ADS/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    高级数据结构与算法分析
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            高级数据结构与算法分析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/1.%20AVL_tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. AVL Tree &amp; Splay Tree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/2.%20Red%20Black%20Tree%20%26%20B%2B%20Tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Red Black Tree &amp; B+ Tree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/3.%20Inverted%20File%20Index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Inverted File Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/4.%20Leftist%20Heaps%20and%20Skew%20Heaps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Leftist Heap &amp; Skew Heap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/5.%20Binomial%20Queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Binomial Queue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/6.%20backtracking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Backtracking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/7.%20Divide%20%26%20Conquer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Divide &amp; Conquer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/8.%20Dynamic%20Programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Dynamic Programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/9.%20Greedy%20Algorithms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. Greedy Algorithms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/10.%20NP-Completeness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. NP-Completeness
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/11.%20Approximation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. Approximation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/12.%20Local%20Search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. Local Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/13.%20Randomized%20Algorithms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. Randomized Algorithms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/14.%20Parallel%20Algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. Parallel Algorithm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/15.%20External%20Sorting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. External Sorting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    System
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    数据库系统
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            数据库系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.%20Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.%20Relational%20Model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Relational Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    3. SQL
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    3. SQL
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-data-definition" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Data Definition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Data Definition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-domain-types-in-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 Domain Types in SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-built-in-data-types-in-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 Built-in Data Types in SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-create-table-construct" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 Create Table Construct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314-drop-and-alter-table-constructs" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 Drop and Alter Table Constructs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-basic-query-structure" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Basic Query Structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 Basic Query Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-the-select-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 The select Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-the-where-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 The where Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-the-from-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 The from clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-natural-join" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 Natural Join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-the-rename-operation" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.5 The Rename Operation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#326-string-operations" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.6 String Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#327-ordering-the-display-of-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.7 Ordering the Display of Tuples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#328-the-limit-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.8 The limit Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#329-set-operations" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.9 Set Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3210-null-values" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.10 Null Values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3211-aggregate-functions" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11 Aggregate Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.11 Aggregate Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#32111-having-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11.1 Having Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32112-null-values-and-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11.2 Null Values and Aggregates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3212-nested-subqueries" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.12 Nested Subqueries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.12 Nested Subqueries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-membership" class="md-nav__link">
    <span class="md-ellipsis">
      Set Membership
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      Set Comparison
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalar-subquery" class="md-nav__link">
    <span class="md-ellipsis">
      Scalar Subquery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-for-empty-relations" class="md-nav__link">
    <span class="md-ellipsis">
      Test for Empty Relations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-for-absence-of-duplicate-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      Test for Absence of Duplicate Tuples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3213-with-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.13 With Clause
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3214-modification-of-the-database" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.14 Modification of the Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.14 Modification of the Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deletion" class="md-nav__link">
    <span class="md-ellipsis">
      Deletion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insertion" class="md-nav__link">
    <span class="md-ellipsis">
      Insertion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updates" class="md-nav__link">
    <span class="md-ellipsis">
      Updates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.%20Entity-Relationship%20Model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    六.Entity-Relationship Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7.%20Relational%20Database%20Design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    七. Relational Database Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8.%20Physical%20Storage%20Systems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    八. Physical Storage Systems
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../9.%20Data%20Storage%20Structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    九. Data Storage Structures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10.%20Indexing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十. Indexing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11.%20Query%20Processing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十一. Query Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12.%20Query%20Optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十二. Query Optimization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13.%20Transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十三. Transactions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14.%20Concurrency%20Control/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十四. Concurrency Control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15.%20Recovery%20System/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    十五. Recovery System
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Artificial Intelligence
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Artificial Intelligence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../CV/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Computer Vision
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Computer Vision
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture1_Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture2_Image_Classification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Image_Classification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture3_Linear_Classifiers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linear_Classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture4_Optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture5_Neural_Networks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neural Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture6_Backpropagation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backpropagation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture7_ConvolutionalNetworks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convolutional Neural Networks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture8_CNN_Architectures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CNN Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture9_Hardware_and_Software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware and Software
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-data-definition" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Data Definition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Data Definition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-domain-types-in-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 Domain Types in SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-built-in-data-types-in-sql" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 Built-in Data Types in SQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-create-table-construct" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 Create Table Construct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314-drop-and-alter-table-constructs" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 Drop and Alter Table Constructs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-basic-query-structure" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Basic Query Structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 Basic Query Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-the-select-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 The select Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-the-where-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 The where Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-the-from-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 The from clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-natural-join" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 Natural Join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-the-rename-operation" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.5 The Rename Operation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#326-string-operations" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.6 String Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#327-ordering-the-display-of-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.7 Ordering the Display of Tuples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#328-the-limit-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.8 The limit Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#329-set-operations" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.9 Set Operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3210-null-values" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.10 Null Values
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3211-aggregate-functions" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11 Aggregate Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.11 Aggregate Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#32111-having-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11.1 Having Clause
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32112-null-values-and-aggregates" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.11.2 Null Values and Aggregates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3212-nested-subqueries" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.12 Nested Subqueries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.12 Nested Subqueries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-membership" class="md-nav__link">
    <span class="md-ellipsis">
      Set Membership
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      Set Comparison
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalar-subquery" class="md-nav__link">
    <span class="md-ellipsis">
      Scalar Subquery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-for-empty-relations" class="md-nav__link">
    <span class="md-ellipsis">
      Test for Empty Relations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-for-absence-of-duplicate-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      Test for Absence of Duplicate Tuples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3213-with-clause" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.13 With Clause
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3214-modification-of-the-database" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.14 Modification of the Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.14 Modification of the Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deletion" class="md-nav__link">
    <span class="md-ellipsis">
      Deletion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#insertion" class="md-nav__link">
    <span class="md-ellipsis">
      Insertion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updates" class="md-nav__link">
    <span class="md-ellipsis">
      Updates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/rescuerz/notebook/blob/main/docs/DB/3. SQL.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/rescuerz/notebook/raw/main/docs/DB/3. SQL.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


<hr />
<h1 id="三-introduction-to-sql">三. Introduction to SQL<a class="headerlink" href="#三-introduction-to-sql" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 10289 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span> 496 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13Z"/></svg></span> 预计阅读时间 58 分钟</p>
</div>
<h2 id="31-data-definition">3.1 Data Definition<a class="headerlink" href="#31-data-definition" title="Permanent link">&para;</a></h2>
<h3 id="311-domain-types-in-sql">3.1.1 Domain Types in SQL<a class="headerlink" href="#311-domain-types-in-sql" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>char(n).</code> Fixed length character string, with user-specified length n.   </p>
<p><strong>定长</strong>字符串. C 语言里字符串结尾有 <code>\0</code>, 但数据库里没有，长度由定义而得。  </p>
</li>
<li>
<p><code>varchar(n).</code> Variable length character strings, with user-specified <strong>maximum</strong> length n. 
    <strong>不定长</strong>字符串。不同的数据类型比较可能有问题（比如定长和不定长的字符串）</p>
<p>设定一个<strong>最长</strong>的长度，小于则按真实长度存储</p>
</li>
<li>
<p><code>int.</code> Integer (a finite subset of the integers that is machine-dependent).</p>
</li>
<li>
<p><code>smallint.</code> Small integer (a machine-dependent subset of the integer domain type).</p>
</li>
<li>
<p><code>numeric(p,d).</code> Fixed point number, with user-specified precision of p digits, with d digits to the right of decimal point.     </p>
<p><strong>p 表示有效数字位数, d 表示小数点后多少位。</strong>
<strong><em>e.g.</em></strong> <code>numeric(3,1)</code> allows 44.5 to be store exactly,  but neither 444.5 or 0.32</p>
</li>
<li>
<p><code>real, double precision.</code>  Floating point and double-precision floating point numbers, with machine-dependent precision.</p>
</li>
<li>
<p><code>float(n).</code> Floating point number, with user-specified precision of at least n digits.</p>
</li>
</ul>
<h3 id="312-built-in-data-types-in-sql">3.1.2 Built-in Data Types in SQL<a class="headerlink" href="#312-built-in-data-types-in-sql" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>系统自带的数据类型</strong></p>
</blockquote>
<ul>
<li><strong>date</strong>: Dates, containing a (4 digit) year, month and date<br />
<strong><em>e.g.</em></strong> date ‘2005-7-27’ 日期（年月日）</li>
<li><strong>time</strong>: Time of day, in hours, minutes and seconds.
<strong><em>e.g.</em></strong> time ‘09:00:30’         time ‘09:00:30.75’ 时间（时分秒）</li>
<li><strong>timestamp: date plus time of day</strong>
<strong><em>e.g.</em></strong> timestamp  ‘2005-7-27 09:00:30.75’ 日期+时间</li>
<li><strong>interval</strong>: period of time
  <strong><em>e.g.</em></strong> interval  ‘1’ day  <ul>
<li><strong>Subtracting</strong> a date/time/timestamp value from another gives an interval value.  </li>
<li>Interval values can be added to date/time/timestamp values</li>
<li>built-in date, time <strong>functions</strong>: <code>current_date(), current_time(), year(x), month(x), day(x), hour(x), minute(x), second(x)</code></li>
</ul>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403170954368.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240317095445211" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403170954368.png" /></a></p>
<h3 id="313-create-table-construct">3.1.3 Create Table Construct<a class="headerlink" href="#313-create-table-construct" title="Permanent link">&para;</a></h3>
<p>An SQL relation is defined using the create table command:
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="n">A1</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">A2</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">An</span><span class="w"> </span><span class="n">Dn</span><span class="p">,</span><span class="w">           </span><span class="p">(</span><span class="n">integrity</span><span class="o">-</span><span class="n">constraint_1</span><span class="p">),</span><span class="w">           </span>
<span class="p">..,</span><span class="w">         </span>
<span class="p">(</span><span class="n">integrity</span><span class="o">-</span><span class="n">constraint_k</span><span class="p">))</span>

<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">instructor</span><span class="p">(</span>
<span class="w">    </span><span class="n">ID</span><span class="w">          </span><span class="nb">char</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="w">    </span><span class="n">name</span><span class="w">        </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="w">    </span><span class="n">dept_name</span><span class="w">   </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="n">salary</span><span class="w">      </span><span class="nb">numeric</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">ID</span><span class="p">),</span>
<span class="w">    </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">dept_name</span><span class="p">)</span><span class="n">reference</span><span class="w"> </span><span class="n">department</span>
<span class="p">);</span>
</code></pre></div></p>
<ul>
<li><span class="arithmatex">\(r\)</span> is the name of the relation</li>
<li>each <span class="arithmatex">\(Ai\)</span> is an <em>attribute name</em> in the schema of relation <span class="arithmatex">\(r\)</span></li>
<li><span class="arithmatex">\(Di\)</span> is the <em>data type</em> of values in the domain of attribute <span class="arithmatex">\(Ai\)</span>  </li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111347371.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240311134757294" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111347371.png" /></a></p>
<p><strong>Integrity Constraints in Create Table 完整性约束</strong></p>
<ul>
<li>
<p><code>not null 要求插入的数据非空</code></p>
</li>
<li>
<p>primary key <span class="arithmatex">\((A_1,\ldots,A_n)\)</span>  </p>
<p>不能为空; 表内不能有相同的 keys. 否则这样的数据是插入不进去的。</p>
</li>
<li>
<p>foreign key <span class="arithmatex">\((A_m,\ldots,A_n)\)</span> references r  </p>
<p>隐含：引用对应表的主键。    </p>
<p>如果不符合完整性约束条件，插入可能会失败。
   <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328581.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328581.png" width /></a></p>
</li>
</ul>
<p>dept_name 指向department表中的Primary key。<strong>在instructor表中所有的dept_name的值，都要存在与department这个表的dept_name列中</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301441660.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330144105588" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301441660.png" /></a></p>
<p><strong>缺省值default</strong>。如果插入学生的时候，没有给tot_cred一个给定的值，那么<strong>该值为default给定的值</strong>。</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111350551.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240311135049451" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111350551.png" /></a></p>
<blockquote>
<p><code>sec_id</code> can be dropped from primary key above, to ensure a student cannot be registered for two sections of the same course in the same semester</p>
<p>sec_id 可以从上面的主键中删除，以<strong>确保学生不能在同一学期上同一门课程的两个班级</strong></p>
</blockquote>
<p>如果引用的表中有条目被删除，可能会破坏完整性约束条件。有下面的方法：  </p>
<ul>
<li>
<p><em>restrict</em>: <strong>如果有条目是被引用的，那么不允许删除。</strong></p>
</li>
<li>
<p><em>cascade</em>: <strong>引用的条目被删了之后，引用者也一并删除</strong></p>
</li>
<li>
<p><em>set null</em>: 引用者的指针设为 <code>null</code>. </p>
<p><strong>如果即将要被置为null的元素，在完整性约束条件下已经被约束为“not null“，这样做就是不合法的。</strong></p>
</li>
<li>
<p><em>set default</em> ： 引用者的指针<strong>设为默认值</strong></p>
</li>
</ul>
<p>如果引用的表中有更新，也有类似上面的<strong>四种方法</strong>。 
<strong>在 <code>create table</code> 中定义</strong>  </p>
<ul>
<li>
<p><code>on delete cascade  |set null |restrict |set default</code></p>
<p>被引用的表发生删除</p>
<p>cascade可能会造成连锁反应，多次foreign key 引用</p>
</li>
<li>
<p><code>on update cascade  |set null |restrict |set default</code></p>
<p>被引用的表发生更改</p>
</li>
</ul>
<blockquote>
<p><strong>实现方式：在create table中完成完整性约束定义</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301450986.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330145057927" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301450986.png" /></a></p>
</blockquote>
<h3 id="314-drop-and-alter-table-constructs">3.1.4 Drop and Alter Table Constructs<a class="headerlink" href="#314-drop-and-alter-table-constructs" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>删除和更改表的结构</strong></p>
</blockquote>
<ul>
<li>
<p>drop table student
  Deletes the table and its contents   </p>
<p><strong>把内容和表全删了</strong>，之后不能再往表里插入。表都没了</p>
</li>
<li>
<p>delete from student  </p>
<p>Deletes all contents of table, but retains table</p>
<p>删除表的所有内容，但保留表</p>
</li>
<li>
<p>alter table   </p>
</li>
</ul>
<blockquote>
<p><strong>可以用于更改表中的列（添加或者删除）</strong></p>
</blockquote>
<ul>
<li>
<p><code>alter table r add A D</code></p>
<ul>
<li>
<p>where A is the name of the attribute to be added to relation r  and D is the domain of A.</p>
<p>A 是属性， D是A的域</p>
<p><strong><em>e.g.</em></strong> <code>alter table student add resume varchar(256);</code></p>
</li>
<li>
<p>All tuples in the relation are assigned null as the value for the new attribute.  </p>
<p>对于新添加的列，所有的元素都设为NULL</p>
</li>
<li>
<p>还可以增加外键约束条件，也可以删掉</p>
</li>
</ul>
</li>
<li>
<p><code>alter table r drop A</code>     </p>
<ul>
<li>
<p>where A is the name of an <strong>attribute</strong> of relation r</p>
</li>
<li>
<p><em>Dropping of attributes not supported by many databases</em>   </p>
<p>可以生成一个新的表，然后把除了要删的列以外的列搬移过去。  </p>
</li>
</ul>
</li>
</ul>
<p>"关系数据库的三层抽象"  </p>
<ul>
<li>用户层：由 DML 定义操作, 如 <code>select</code> 语句。</li>
<li>逻辑层：由 <code>create table</code> 决定，我们定义了表的元素，以及各种键，构成了模式图。</li>
</ul>
<h2 id="32-basic-query-structure">3.2 Basic Query Structure<a class="headerlink" href="#32-basic-query-structure" title="Permanent link">&para;</a></h2>
<h3 id="321-the-select-clause">3.2.1 The <code>select</code> Clause<a class="headerlink" href="#321-the-select-clause" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111416323.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240311141642241" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111416323.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111417863.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240311141723794" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111417863.png" /></a></p>
<p>The <strong><code>select</code></strong> clause list the attributes desired in the result of a query.  </p>
<p><strong><code>SQL names are case insensitive 大小写不敏感。（属性名字、表的名字等）</code></strong></p>
<ul>
<li>
<p>To force the elimination of duplicates, insert the keyword <strong><code>distinct</code></strong> after select.</p>
<p><strong><em>e.g.</em></strong> <code>select distinct dept_name from instructor</code>  </p>
<p><strong>加 distinct能够去重</strong></p>
<p>可以加 <strong>all</strong> 表示不去重，<del>加不加无所谓</del></p>
</li>
<li>
<p>An asterisk in the select clause denotes “all attributes”<br />
<strong><em>e.g.</em></strong> <code>select * from instructor</code></p>
</li>
<li>
<p>The select clause can contain arithmetic expressions involving the operation, +, –, <span class="arithmatex">\(\div\)</span>, and /, and operating on constants or attributes of tuples.  </p>
<p>可以有加减乘除运算 <strong><em>e.g.</em></strong> <code>select ID, name, salary/12 from instructor</code></p>
</li>
</ul>
<h3 id="322-the-where-clause">3.2.2 The <code>where</code> Clause<a class="headerlink" href="#322-the-where-clause" title="Permanent link">&para;</a></h3>
<p>The <strong><code>where</code></strong> clause specifies conditions that the result must satisfy. </p>
<p>该 <code>where</code> 子句指定结果必须满足的条件。  </p>
<p>Corresponds to the selection predicate of the relational algebra.  </p>
<ul>
<li>
<p>SQL includes a <strong><code>between</code></strong> comparison operator</p>
</li>
<li>
<p>Tuple comparison  </p>
<p>元组相等等价于各个元素都相等。</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">90000</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">100000</span>

<span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">course_id</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="p">,</span><span class="w"> </span><span class="n">teaches</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">instructor</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">dept_name</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">teaches</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="err">’</span><span class="n">Biology</span><span class="err">’</span><span class="p">)</span>
</code></pre></div>
<h3 id="323-the-from-clause">3.2.3 The <code>from</code> clause<a class="headerlink" href="#323-the-from-clause" title="Permanent link">&para;</a></h3>
<p>The <strong><code>from</code></strong> clause lists the relations involved in the query.  </p>
<p>Corresponds to the <strong>Cartesian product</strong> operation of the relational algebra.  </p>
<p><strong>from 多个 table 表示 笛卡尔积</strong></p>
<h3 id="324-natural-join">3.2.4 Natural Join<a class="headerlink" href="#324-natural-join" title="Permanent link">&para;</a></h3>
<p><strong><em>e.g.</em></strong> <code>select * from instructor natural join teaches;</code></p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">course_id</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="p">,</span><span class="w"> </span><span class="n">teaches</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">teaches</span><span class="p">.</span><span class="n">ID</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">course_id</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">teaches</span><span class="p">;</span>
</code></pre></div>
<p>上面两条语句是等价的。</p>
<p>自然联接将所有<strong>公共属性</strong>的元组与<strong>相同值</strong>进行匹配，并且仅保留每个公共列的一个<strong>副本</strong></p>
<blockquote>
<p><strong>natural join 可以使用 using 规定匹配的是哪个公共属性</strong></p>
</blockquote>
<p><code>course(course_id,title, dept_name,credits）</code>, </p>
<p><code>teaches(ID, course_id,sec_id,semester, year)</code>, </p>
<p><code>instructor(ID, name, dept_name,salary）</code> </p>
<p>这里的 department 含义各有不同，<strong>不能直接自然连接</strong>。 </p>
<p>instructor dept_name 表示老师所在的系</p>
<p>course dept_name 表示开课的系</p>
<p>可以写成 `` 即规定连接的属性，对应于 <span class="arithmatex">\(\sigma_\theta\)</span>   </p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="n">instructor</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">teaches</span><span class="p">)</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">course_id</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="p">,</span><span class="w"> </span><span class="n">teaches</span><span class="p">,</span><span class="w"> </span><span class="n">course</span>
<span class="k">where</span><span class="w"> </span><span class="n">instructor</span><span class="p">.</span><span class="n">id</span><span class="w">  </span><span class="n">teaches</span><span class="p">.</span><span class="n">id</span><span class="w"> </span>
<span class="n">adn</span><span class="w"> </span><span class="n">teaches</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">course_id</span><span class="p">;</span>
</code></pre></div>
<p>Find students who takes courses across his/her department.  </p>
<p>寻找跨系选课</p>
<p>student(id, name, <strong>dept_name</strong>, tot_cred)</p>
<p>takes(id, course_id, sec_id, semester, year, grade)</p>
<p>course(course_id, title, <strong>dept_name</strong>, credits)</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">student</span><span class="p">.</span><span class="n">id</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="n">student</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">takes</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">join</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">course_id</span><span class="err">）</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">student</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">dept_name</span>
</code></pre></div>
<blockquote>
<p><strong>请注意此处，第二个是使用join，附带条件使用course_id,这是因为第一处natural join之后得到的表，与course表的共有属性有course_id, dept_name。而我们要找的是dept_name不同的，所以不能使用natural join</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301519881.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330151918795" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301519881.png" /></a></p>
<h3 id="325-the-rename-operation">3.2.5 The Rename Operation<a class="headerlink" href="#325-the-rename-operation" title="Permanent link">&para;</a></h3>
<p>The SQL allows renaming relations and attributes using the <strong><code>as</code></strong> clause.  </p>
<p><code>old-name as new-name</code></p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="o">/</span><span class="mi">12</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">monthly_salary</span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span>

<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="w"> </span><span class="n">name</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">‘</span><span class="n">Comp</span><span class="p">.</span><span class="w"> </span><span class="n">Sci</span><span class="p">.</span><span class="err">’</span><span class="o">`</span>
</code></pre></div>
<ul>
<li>
<p>Keyword <strong><code>as</code></strong> is optional and may be omitted.  </p>
<p>as可以省略</p>
</li>
</ul>
<h3 id="326-string-operations">3.2.6 String Operations<a class="headerlink" href="#326-string-operations" title="Permanent link">&para;</a></h3>
<p>SQL includes a <strong>string-matching operator</strong> for comparisons on character strings.  The operator <strong><code>like</code></strong> uses patterns that are described using two special characters. </p>
<p>注意单引号表示字符串。</p>
<ul>
<li>
<p><strong>percent (%)</strong>.  The % character matches any substring.  </p>
<p><strong><em>e.g.</em></strong> <code>select name from instructor where name like '%dar%';</code></p>
<p>找名字里面含有 <code>dar</code> 的字符串。 </p>
</li>
<li>
<p><strong>underscore (_)</strong>.  The _ character matches any character.  </p>
<p>匹配字符串 <code>'100 %'</code> 但是 <code>%</code> 符号被我们作为了通配符，这里我们需要用到转义符 <code>\</code>. <code>\%</code> 即将 <code>%</code> 作为正常字符匹配。  </p>
<p><code>\</code> 也可以是一个基本符号，我们需要在后面写出 <code>escape</code> 表示其在这里作为<strong>转义符</strong>。类似地我们还可以将转义符定义为 <code>#</code>. </p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">like</span><span class="w"> </span><span class="err">‘</span><span class="mi">100</span><span class="w"> </span><span class="err">\</span><span class="o">%</span><span class="s1">&#39;  escape  &#39;</span><span class="err">\</span><span class="s1">&#39;</span>
<span class="s1">like ‘100 #%&#39;</span><span class="w">  </span><span class="k">escape</span><span class="w">  </span><span class="err">‘</span><span class="o">#</span><span class="err">&#39;</span><span class="w"> </span>
</code></pre></div>
<p>SQL supports a variety of string operations such as</p>
<ul>
<li>concatenation (using <code>||</code>)</li>
<li>converting from upper to lower case (and vice versa)</li>
<li>finding string length, extracting substrings, etc.  </li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301609419.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330160938364" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403301609419.png" /></a></p>
<h3 id="327-ordering-the-display-of-tuples">3.2.7 Ordering the Display of Tuples<a class="headerlink" href="#327-ordering-the-display-of-tuples" title="Permanent link">&para;</a></h3>
<p>关系是无序的，但我们可能规定显示出来的顺序。</p>
<ul>
<li>
<p>We may specify <strong>desc for descending order</strong> or <strong>asc for ascending order,</strong> for each attribute; ascending order is the default.  </p>
<p><strong>desc——descending 降序， asc——ascendin 升序。不指定默认升序</strong></p>
<p><strong><em>e.g.</em></strong> <code>order by name desc</code>  可以排序的类型，如字符串、数字。</p>
</li>
<li>
<p>Can sort on multiple attributes  </p>
<p><strong><em>e.g.</em></strong> <code>order by  dept_name, name</code> 先按第一个排，如果第一个元素相同再按第二个排。</p>
</li>
</ul>
<h3 id="328-the-limit-clause">3.2.8 The limit Clause<a class="headerlink" href="#328-the-limit-clause" title="Permanent link">&para;</a></h3>
<p>The <strong><code>limit</code></strong> clause can be used to constrain the number of rows returned by the select statement.   </p>
<p><strong>限制 select 语句返回的行数。</strong></p>
<p>limit clause takes one or two numeric arguments, which must both be nonnegative integer constants: </p>
<p><strong>limit 子句采用一个或两个数值参数，这两个参数都必须是非负整数常量：</strong></p>
<ul>
<li>
<p><code>limit offset, row_count</code></p>
<p><strong>表示从下标为offset的地方开始，保留row_count个</strong></p>
</li>
<li>
<p><code>limit row_count == limit 0, row_count</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w">  </span><span class="n">name</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span>
<span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="err">；</span><span class="w">   </span><span class="o">//</span><span class="w">  </span><span class="k">limit</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span>
</code></pre></div>
<h3 id="329-set-operations">3.2.9 Set Operations<a class="headerlink" href="#329-set-operations" title="Permanent link">&para;</a></h3>
<p><code>union, intersect, except</code> 是严格的集合操作，会对结果去重.</p>
<ul>
<li>如果不想去除重复的元素，可以使用<code>union all</code>, <code>intersect all</code> and <code>except all</code>. 保持多重集。 <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328610.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328610.png" ></a></li>
</ul>
<h3 id="3210-null-values">3.2.10 Null Values<a class="headerlink" href="#3210-null-values" title="Permanent link">&para;</a></h3>
<p><strong>null</strong> signifies <em>an unknown value</em> or that <em>a value does not exist</em>.</p>
<ul>
<li>
<p>The result of any arithmetic expression involving null is null.  </p>
<p><strong>任何涉及 null 的算术表达式的结果都是 null。</strong></p>
<p><strong><em>e.g.</em></strong> <code>5 + null</code> returns null</p>
</li>
<li>
<p>The predicate <code>is null</code>can be used to check for null values.  </p>
<p>谓词 is null 可用于检查 null 值。</p>
<p><strong><em>e.g.</em></strong> Find all instructors whose salary is null.   </p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span>
</code></pre></div>
</li>
<li>
<p>Comparisons with null values return the <strong>special truth value:</strong> <strong>unknown</strong>.  </p>
</li>
</ul>
<div align=center> <a class="glightbox" href="http://cdn.hobbitqia.cc/202303131118989.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="http://cdn.hobbitqia.cc/202303131118989.png" ></a> </div>

<ul>
<li>Result of select predicate is treated as false if it evaluates to unknown</li>
</ul>
<h3 id="3211-aggregate-functions">3.2.11 Aggregate Functions<a class="headerlink" href="#3211-aggregate-functions" title="Permanent link">&para;</a></h3>
<p>聚合函数：常见的包括：avg，min，max，sum，count</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">average</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">instructors</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Computer</span><span class="w"> </span><span class="n">Science</span><span class="w"> </span><span class="n">department</span>
<span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="n">wher</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Comp.Sci&quot;</span>

<span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">instructors</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">teach</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Spring</span><span class="w"> </span><span class="mi">2010</span><span class="w"> </span><span class="n">semester</span>
<span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">teaches</span>
<span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Spring</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2010</span>

<span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">tuples</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="n">relation</span>
<span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="p">;</span>
</code></pre></div>
<p>在select挑选出来的属性中，除了聚合函数计算得到的属性以外，<strong>其余的属性必须在分组属性group by后面出现</strong></p>
<div class="highlight"><pre><span></span><code><span class="err"></span><span class="cm">/* erroneous query */</span>
<span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="k">avg</span><span class="w"> </span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="err">此处的</span><span class="n">ID不合规</span>
</code></pre></div>
<h4 id="32111-having-clause">3.2.11.1 Having Clause<a class="headerlink" href="#32111-having-clause" title="Permanent link">&para;</a></h4>
<p>对分组后的组进行筛选。  </p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="k">where</span><span class="w">  </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">100000</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">having</span><span class="w">  </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="err">先对每个系中工资大于</span><span class="mi">100000</span><span class="err">的选出来，再计算数量，再按照数量将</span><span class="n">cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="err">留下来，</span><span class="w"> </span><span class="err">最后按照</span><span class="n">cnt</span><span class="w"> </span><span class="err">排序</span>

<span class="k">select</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">from</span><span class="w"> </span><span class="n">student</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">having</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
<span class="o">#</span><span class="w"> </span><span class="err">找出没有重名学生的系</span>

<span class="k">select</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">from</span><span class="w"> </span><span class="n">student</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">having</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span>
<span class="o">#</span><span class="w"> </span><span class="err">找出重名率小于</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="w"> </span><span class="err">的系得名字</span>
</code></pre></div>
<blockquote>
<p><strong>关于having 和 where的区别</strong></p>
</blockquote>
<p>predicates in the <strong><code>having</code></strong> clause are applied <em>after the formation of groups</em> whereas predicates in the <strong><code>where</code></strong> clause are applied <em>before forming groups</em>.  </p>
<p><strong>having是在分组之后，对分好的组进行筛选</strong></p>
<p><strong>where是在分组之前，对表中的行进行筛选，筛掉的行不参与分组</strong></p>
<h4 id="32112-null-values-and-aggregates">3.2.11.2 Null Values and Aggregates<a class="headerlink" href="#32112-null-values-and-aggregates" title="Permanent link">&para;</a></h4>
<p><code>select sum (salary) from instructor</code>  </p>
<ul>
<li>
<p>Above statement <strong>ignores null amounts</strong></p>
</li>
<li>
<p>Result is null if there is no non-null amount</p>
<p>如果没有非 null 金额，则结果为 null</p>
</li>
<li>
<p>All aggregate operations except <code>count(*)</code> ignore tuples with null values on the aggregated attributes</p>
</li>
</ul>
<p>如果使用count(*),输出的是非空值的个数</p>
<h3 id="3212-nested-subqueries">3.2.12 Nested Subqueries<a class="headerlink" href="#3212-nested-subqueries" title="Permanent link">&para;</a></h3>
<p>A <strong>subquery</strong> is a <strong>select-from-where</strong> expression that is nested within another query.</p>
<h4 id="set-membership">Set Membership<a class="headerlink" href="#set-membership" title="Permanent link">&para;</a></h4>
<p><code>in, not in</code></p>
<p>in 是 集合成员的判断</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">courses</span><span class="w"> </span><span class="n">offered</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">Fall</span><span class="w"> </span><span class="mi">2009</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">Spring</span><span class="w"> </span><span class="mi">2010</span>
<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">section</span>
<span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Fall</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="w"> </span><span class="k">and</span>
<span class="w">    </span><span class="n">course_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">course_id</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">section</span>
<span class="w">            </span><span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Spring</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2010</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">courses</span><span class="w"> </span><span class="n">offered</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">Fall</span><span class="w"> </span><span class="mi">2009</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">Spring</span><span class="w"> </span><span class="mi">2010</span>
<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">section</span>
<span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Fall</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="w"> </span><span class="k">and</span>
<span class="w">    </span><span class="n">course_id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">course_id</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">section</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Spring</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2010</span><span class="p">);</span>
</code></pre></div>
<p>in或not in语句也可以判断<strong>一个元组</strong>是否在给定表的行当中：</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">(</span><span class="k">distinct</span><span class="p">)</span><span class="w"> </span><span class="n">students</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">taken</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="n">sections</span><span class="w"> </span><span class="n">taught</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="mi">10101</span>
<span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">ID</span><span class="p">)</span>
<span class="k">from</span><span class="w"> </span><span class="n">takes</span>
<span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">sec_id</span><span class="p">,</span><span class="w"> </span><span class="n">semester</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">)</span><span class="w"> </span><span class="k">in</span>
<span class="w">            </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">sec_id</span><span class="p">,</span><span class="w"> </span><span class="n">semester</span><span class="p">,</span><span class="w"> </span><span class="k">year</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">teaches</span>
<span class="w">            </span><span class="k">where</span><span class="w"> </span><span class="n">teaches</span><span class="p">.</span><span class="n">ID</span><span class="o">=</span><span class="w"> </span><span class="err">‘</span><span class="mi">10101</span><span class="err">’</span><span class="p">);</span>
</code></pre></div>
<h4 id="set-comparison">Set Comparison<a class="headerlink" href="#set-comparison" title="Permanent link">&para;</a></h4>
<ul>
<li><code>some</code> 某些成员   </li>
<li><code>all</code> 所有成员</li>
</ul>
<p>​    工资大于生物系中的某些老师的老师.  </p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">some</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">salary</span>
<span class="w">                         </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">                         </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Biology</span><span class="err">’</span><span class="p">);</span>

<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">salary</span>
<span class="w">                        </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">                        </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Biology</span><span class="err">’</span><span class="p">);</span>
</code></pre></div>
<h4 id="scalar-subquery">Scalar Subquery<a class="headerlink" href="#scalar-subquery" title="Permanent link">&para;</a></h4>
<p><strong>Scalar (标量) subquery</strong> is one which is used where a <strong>single value</strong> is expected.  </p>
<p>​    <strong>此处由于department.dept_name 定下来了，所以budget也唯一确定，保证了嵌套查询的子查询中仅仅返回一个数值。</strong></p>
<p>如果不能保证子查询返回的值只有一个，需要使用some或者all</p>
<div class="highlight"><pre><span></span><code>select name
from instructor
where  salary * 10 &gt; 
    (select budget  
    from department 
    where department.dept_name = instructor.dept_name)

```

这里 `dept_name` 是这个表的主键，只返回一个元组，这种情况下是可以不用 `some, all` 的。
</code></pre></div>
<p><strong><code>Runtime error if subquery returns more than one result tuple.</code></strong></p>
<h4 id="test-for-empty-relations">Test for Empty Relations<a class="headerlink" href="#test-for-empty-relations" title="Permanent link">&para;</a></h4>
<p>The exists construct returns the value true if the argument subquery is nonempty.</p>
<ul>
<li><code>exists r</code> <span class="arithmatex">\(\Leftrightarrow r \neq \emptyset\)</span></li>
<li><code>not exists r</code> <span class="arithmatex">\(\Leftrightarrow r = \emptyset\)</span></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Fall</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="w"> </span><span class="k">and</span><span class="w"> </span>
<span class="w">   </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w">                            </span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="w">                      </span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Spring</span><span class="err">’</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">year</span><span class="o">=</span><span class="w"> </span><span class="mi">2010</span><span class="w"> </span>
<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">course_id</span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span><span class="p">);</span>
</code></pre></div>
<blockquote>
<p><strong>只要不空，存在就是True</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">students</span><span class="w"> </span><span class="n">who</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">taken</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">courses</span><span class="w"> </span><span class="n">offered</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Biology</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="w">  </span>
<span class="o">#</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="err">语句往往需要逆向考虑，即找到这样的学生，不存在他没选过的生物系的课。</span><span class="w">  </span>
<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">S</span>
<span class="k">where</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">course_id</span>
<span class="w">                    </span><span class="k">from</span><span class="w"> </span><span class="n">course</span>
<span class="w">                    </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Biology</span><span class="err">’</span><span class="p">)</span>
<span class="w">                    </span><span class="k">except</span>
<span class="w">                  </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">                   </span><span class="k">from</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="w">                   </span><span class="k">where</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">ID</span><span class="p">));</span>
</code></pre></div>
<p>不存在学生没选过的生物课。</p>
<p>也就是让生物系所有的课程id 减去 这位同学上过的所有课的id，只要最后的集合为空，那么表明这个学生上过生物系中所有的课程。</p>
<blockquote>
<p><strong>exist 和 in/not in 的区别</strong></p>
<p><strong>exist 测试的是，后面的集合是否为空，只要不为空就返回true</strong></p>
<p><strong>in/not in， 前置会有一个属性，需要检测前置的属性是否在后面的集合中</strong></p>
</blockquote>
<h4 id="test-for-absence-of-duplicate-tuples">Test for Absence of Duplicate Tuples<a class="headerlink" href="#test-for-absence-of-duplicate-tuples" title="Permanent link">&para;</a></h4>
<p>The <strong><code>unique</code></strong> construct tests whether a subquery has any duplicate tuples in its result.  </p>
<p>验证是否是一个集合，而非多重集。  </p>
<ul>
<li>
<p>Evaluates to “true” on an empty set.   </p>
<p>可以将 unique 理解为 <strong>at most once</strong>. </p>
<p><strong>只要unique后面跟的括号中的子查询返回的结果没有重复的元素，返回值就是True。</strong></p>
<p><strong><code>如果返回值为空，unique仍然为True</code></strong></p>
<p>例如下方，假设选择出的课程在2009年没有开过，那么unique后面跟着的子查询返回的结果为null，也同样没有重复的元素，因此结果也是True</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">courses</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">offered</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2009</span>
<span class="k">select</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="k">where</span><span class="w"> </span><span class="k">unique</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">      </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="w">      </span><span class="k">where</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
</code></pre></div>
</li>
</ul>
<p>如果想要查询在2009年恰好开过一次的课程，需要同时使用unique和exist</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="k">where</span><span class="w"> </span><span class="n">exist</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">           </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="w">           </span><span class="k">where</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">           </span><span class="k">and</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="p">)</span>
<span class="k">and</span><span class="w"> </span><span class="k">unique</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">          </span><span class="k">and</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="p">)</span>

<span class="c1">-- exist 和 in 可以等价替换</span>
<span class="k">select</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="k">where</span><span class="w"> </span><span class="n">course_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">           </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="w">           </span><span class="k">where</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">           </span><span class="k">and</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="p">)</span>
<span class="k">and</span><span class="w"> </span><span class="k">unique</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">          </span><span class="k">from</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">R</span>
<span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">          </span><span class="k">and</span><span class="w"> </span><span class="n">R</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2009</span><span class="p">)</span><span class="w">    </span>
</code></pre></div>
<blockquote>
<p><strong>如果不加 exist, 可能有没开过的课也被算进去。我们这里求得是恰好只开过一次的。</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328299.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328299.png" /></a></p>
<p>也可以用 <code>group by count(*) &lt;= 1</code> 实现。</p>
<h3 id="3213-with-clause">3.2.13 With Clause<a class="headerlink" href="#3213-with-clause" title="Permanent link">&para;</a></h3>
<p>The <strong><code>with</code></strong> clause provides a way of defining a temporary view whose definition is available only to the query in which the with clause occurs.  </p>
<p><strong><code>with</code></strong> 子句提供了一种定义<strong>临时视图</strong>的方法，该临时视图的定义仅适用于出现 with 子句的查询。</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">departments</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">budget</span><span class="p">.</span>
<span class="w">    </span><span class="k">with</span><span class="w"> </span><span class="n">max_budget</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>
<span class="w">         </span><span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="p">)</span>
<span class="o">#</span><span class="w"> </span><span class="n">max_budget</span><span class="w"> </span><span class="err">是</span><span class="w"> </span><span class="err">临时表的名字，</span><span class="w"> </span><span class="n">value是表中的属性</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="p">,</span><span class="w"> </span><span class="n">max_budget</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">department</span><span class="p">.</span><span class="n">budget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_budget</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">department</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">budget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>
<span class="w">                   </span><span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="err">查找总工资大于所有部门总工资平均值的所有部门</span>
<span class="k">with</span><span class="w"> </span><span class="n">dept_total</span><span class="w"> </span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span>
<span class="w">  </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span><span class="p">),</span>

<span class="w">  </span><span class="n">dept_total_avg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">as</span>
<span class="w">  </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">dept_total</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">dept_name</span>
<span class="k">from</span><span class="w"> </span><span class="n">dept_total</span><span class="p">,</span><span class="w"> </span><span class="n">dept_total_avg</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept_total</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dept_total_avg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</code></pre></div>
<h2 id="3214-modification-of-the-database">3.2.14 Modification of the Database<a class="headerlink" href="#3214-modification-of-the-database" title="Permanent link">&para;</a></h2>
<h3 id="deletion">Deletion<a class="headerlink" href="#deletion" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328424.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328424.png" ></a></p>
<div class="highlight"><pre><span></span><code><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="k">where</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="p">)</span>

<span class="o">//</span><span class="w"> </span><span class="k">First</span><span class="p">,</span><span class="w"> </span><span class="n">compute</span><span class="w"> </span><span class="k">avg</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">tuples</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">delete</span>
<span class="o">//</span><span class="w"> </span><span class="k">Next</span><span class="p">,</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="n">tuples</span><span class="w"> </span><span class="k">found</span><span class="w"> </span><span class="n">above</span><span class="w"> </span><span class="p">(</span><span class="k">without</span><span class="w"> </span><span class="n">recomputing</span><span class="w"> </span><span class="k">avg</span><span class="w"> </span><span class="k">or</span><span class="w">          </span><span class="n">retesting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">tuples</span><span class="p">)</span>
</code></pre></div>
<h3 id="insertion">Insertion<a class="headerlink" href="#insertion" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328429.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328429.png"></a></p>
<div class="highlight"><pre><span></span><code>第二种写法，可以不用严格按照定义的元素顺序，只要和自己写的对应即可。
</code></pre></div>
<blockquote>
<p><strong>除了基本写法，我们还可以在 <code>insert</code> 后跟查询语句，把查询结果插入到表里去。</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328467.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328467.png" width = /></a></p>
<div class="highlight"><pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tabel</span>
<span class="o">//</span><span class="w"> </span><span class="err">如果没有</span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="err">，则所有元素重复一次</span>
<span class="o">//</span><span class="w"> </span><span class="err">否则，出现错误，重复</span>
</code></pre></div>
<h3 id="updates">Updates<a class="headerlink" href="#updates" title="Permanent link">&para;</a></h3>
<p><code>update ... set ...</code>  <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328700.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403111328700.png" /></a></p>
<p><strong>此处强调顺序，如果对工资小于100000的，先进行×1.05的操作，将会导致运算后的工资大于100000，再×1.03，造成重复计算</strong></p>
<blockquote>
<p><strong><code>order is important,否则会多次运算</code></strong>
<strong><code>进阶： 使用 case 语句</code></strong></p>
</blockquote>
<p><a class="glightbox" href="http://cdn.hobbitqia.cc/202303131648760.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="http://cdn.hobbitqia.cc/202303131648760.png" width/></a></p>
<div class="highlight"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="err">计算总学分且要求该门课的成绩不是</span><span class="n">F</span>
<span class="k">update</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="n">S</span><span class="w"> </span>
<span class="k">set</span><span class="w"> </span><span class="n">tot_cred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">credits</span><span class="p">)</span>
<span class="w">                </span><span class="k">from</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course</span>
<span class="w">                </span><span class="k">where</span><span class="w"> </span><span class="n">S</span><span class="p">.</span><span class="n">ID</span><span class="o">=</span><span class="w"> </span><span class="n">takes</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="k">and</span><span class="w"> </span>
<span class="w">                </span><span class="n">takes</span><span class="p">.</span><span class="n">grade</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="err">’</span><span class="n">F</span><span class="err">’</span><span class="w"> </span><span class="k">and</span>
<span class="w">                </span><span class="n">takes</span><span class="p">.</span><span class="n">grade</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">);</span>
</code></pre></div>
<h1 id="四-intermediate-sql">四. Intermediate SQL<a class="headerlink" href="#四-intermediate-sql" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>中级SQL语言</strong></p>
</blockquote>
<h2 id="41-joined-relations">4.1 Joined Relations<a class="headerlink" href="#41-joined-relations" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Join operations take two relations and return as a result another relation.</p>
<p>连接操作采用两个关系，并返回另一个关系。</p>
</li>
<li>
<p>Join operations are typically used as subquery expressions in the from clause</p>
<p>连接操作通常用作 from 子句中的子查询表达式</p>
</li>
<li>
<p>Join condition – defines which tuples in the two relations match, and what attributes are present in the result of the join.</p>
<p>连接条件 – 定义两个关系中的哪些元组匹配，以及连接结果中存在哪些属性。</p>
</li>
<li>
<p>Join type – defines how tuples in each relation that do not match any tuple in the other relation (based on the join condition) are treated.  </p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181344951.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318134436852" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181344951.png" /></a></p>
<ul>
<li>using 是一个等值连接，类似于自然连接，这些属性相同才能连接</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">table</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">natural</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">b</span>
<span class="err">自然连接，所有的共有属性</span>

<span class="k">table</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="err">某个条件</span>
<span class="err">条件连接，仅保留满足条件的</span><span class="n">tuple</span>

<span class="k">table</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="k">some</span><span class="w"> </span><span class="n">attribute</span>
<span class="err">等值连接，仅仅提到的共有属性</span>
</code></pre></div>
<blockquote>
<p><strong>natural join 包括 natural left outer join， natural right outer join， natural full outer join</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345439.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318134503331" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345439.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345885.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318134515805" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345885.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345238.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318134527156" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345238.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345908.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318134535817" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181345908.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302034819.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330203416707" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302034819.png" /></a></p>
<p><strong>只对on后面的条件说明的属性做条件连接，其他不满足条件的tuple全部舍弃</strong></p>
<h2 id="42-sql-data-types-and-schemas">4.2 SQL Data Types and Schemas<a class="headerlink" href="#42-sql-data-types-and-schemas" title="Permanent link">&para;</a></h2>
<h3 id="421-user-defined-types">4.2.1 User-Defined Types<a class="headerlink" href="#421-user-defined-types" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>自定义数据类型</strong></p>
</blockquote>
<p><strong><code>create type</code></strong> construct in SQL creates user-defined type.  </p>
<p><code>create type Dollars as numeric (12,2) final</code> </p>
<p>定义了 <code>Dollars</code> 这个类型后，我们就可以把它当作元类型使用。  </p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">department</span>
<span class="w">    </span><span class="p">(</span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="n">building</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="w">    </span><span class="n">budget</span><span class="w"> </span><span class="n">Dollars</span><span class="p">);</span>
</code></pre></div>
<p>这样可以支持强类型检查，可以防止如 200 美元 + 300 RMB 得到 500 元的错误。</p>
<h3 id="422-domains">4.2.2 Domains<a class="headerlink" href="#422-domains" title="Permanent link">&para;</a></h3>
<p><code>create domain</code> construct in SQL-92 creates user-defined domain types.  </p>
<blockquote>
<p><strong>自定义值域</strong></p>
<p><strong>Domains can have <code>constraints(约束)</code>, such as <code>not null</code>, specified on them.</strong></p>
</blockquote>
<p>​    <code>create domain person_name char(20) not null</code> </p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">domain</span><span class="w"> </span><span class="n">degree_level</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">degree_level_test</span>
<span class="w">    </span><span class="k">check</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="err">’</span><span class="n">Bachelors</span><span class="err">’</span><span class="p">,</span><span class="w"> </span><span class="err">’</span><span class="n">Masters</span><span class="err">’</span><span class="p">,</span><span class="w"> </span><span class="err">’</span><span class="n">Doctorate</span><span class="err">’</span><span class="p">));</span>
</code></pre></div>
<p>这里的 constraint 可以对 domain 的<strong>取值进行限制</strong>。</p>
<p><strong>不同 type 的变量，即使定义相同，也不能进行运算</strong>。不同 domain 的变量（基础类型相同）可以运算。</p>
<h3 id="423-large-object-types">4.2.3 Large-Object Types<a class="headerlink" href="#423-large-object-types" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>大对象类型</strong></p>
</blockquote>
<p>Large objects (photos, videos, CAD files, etc.) are stored as a large object:  </p>
<ul>
<li>
<p><strong>blob</strong>: <code>binary large object</code>-- object is a large collection of uninterpreted binary data (whose interpretation is left to an application outside of the database system)  </p>
<p>二进制大型对象 -- 对象是大量未解释的二进制数据</p>
<p>存储大对象数据类型，实际上只是存放指针。</p>
<blockquote>
<p>Example "BLOB in MySQL"</p>
</blockquote>
<ul>
<li>TinyBlob ：  0 ~ 255 bytes.</li>
<li>Blob： 0 ~ 64K bytes.</li>
<li>MediumBlob ： 0 ~ 16M bytes.</li>
<li>LargeBlob : 0 ~ 4G  bytes.</li>
</ul>
</li>
<li>
<p><strong>clob</strong>: character large object -- object is a large collection of character data </p>
<p>字符大对象 -- 对象是字符数据的大型集合</p>
</li>
</ul>
<blockquote>
<p><strong>对于大对象类型。当查询操作返回一个大对象类型的结果时，将会返回大对象的指针，而不是大对象本身</strong></p>
</blockquote>
<h2 id="43-integrity-constraints">4.3 Integrity Constraints<a class="headerlink" href="#43-integrity-constraints" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong><code>not null</code></strong></p>
</li>
<li>
<p><strong><code>primary key</code></strong></p>
</li>
<li>
<p><strong><code>unique</code></strong>    </p>
<p><code>unique(A1, A2, ..., Am)</code> The unique specification states that the attributes <code>A1, A2, ..., Am</code> form a <strong>super key</strong> （不一定是 candidate key)  </p>
<p>unique 后面用括号括起来的属性组合，表明这些属性的组合能够唯一确定一个元组。构成一个super key，不一定是最小的主键。</p>
<blockquote>
<p><strong>回忆一下什么是super key， 什么是 candidate key？</strong></p>
<p><strong>super key ： super key 能够唯一确定tuple，但是具有冗余性</strong></p>
<p><strong>candidate key :  candidate key 是最小的super ky</strong></p>
<p><strong>primary key ： candidate key 中的一种</strong></p>
</blockquote>
<p>比如学生个人信息，我们知道 ID 是主键，但实际上邮箱、电话号码等也不能相同的，所以我们要通过语句告诉数据库，数据库会为我们维护这些约束条件。    </p>
<p>Candidate keys are <strong>permitted to be null</strong> (in contrast to primary keys).  </p>
<p>候选键允许为 null（与主键相反）。</p>
</li>
<li>
<p><strong><code>check (P)</code></strong>, where P is a predicate  </p>
<p>检验条件，元组的值需要满足约束条件</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181400790.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181400790.png" alt="image-20240318140013662"  /></a></p>
</li>
<li>
<p><strong><code>foreign key</code></strong> </p>
<p>"Integrity Constraint Violation During Transactions"    </p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181400338.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318140040232" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181400338.png" /></a></p>
<p>在一个人的父母还没插入的时候，无法插入这个人，依次类推。  </p>
<p>可以规定，在这个事务结束时再检查完整性约束条件，中间状态可以不满足。</p>
</li>
<li>
<p><strong><code>assertion（尚未实现）</code></strong>  </p>
<p><code>create assertion &lt;assertion-name&gt; check &lt;predicate&gt;;</code>  </p>
<p>​      <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181402228.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318140237123" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181402228.png" /></a></p>
<p><strong>不存在一个学生的总学分不等于他的学分总和，双重否定</strong></p>
<p>验证一个学生获得的总学分，要等于获得的每门课的学分的总和。</p>
<p>但使用 <code>assert</code> 后，每个元组的每次状态更新时都要进行检查，开销过大，<strong>数据库一般不支持。</strong></p>
</li>
</ul>
<blockquote>
<p><strong>注意：以上条件一般只能用于create table阶段，单独使用</strong></p>
</blockquote>
<h2 id="44-views">4.4 Views<a class="headerlink" href="#44-views" title="Permanent link">&para;</a></h2>
<p>A <strong>view</strong> provides a mechanism to <strong>hide certain data</strong> from the view of certain users.   </p>
<p>视图提供了一种机制，用于从某些用户的视图中<strong>隐藏某些数据</strong>。</p>
<h3 id="441-view-definition">4.4.1 View Definition<a class="headerlink" href="#441-view-definition" title="Permanent link">&para;</a></h3>
<p>A view is defined using the create view statement which has the form <code>create view v as &lt; query expression &gt;</code>  </p>
<div class="highlight"><pre><span></span><code><span class="c1">-- a view of instructor without their salary(学院)</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">faculty</span><span class="w"> </span><span class="k">as</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">dept_name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span><span class="p">;</span>

<span class="c1">-- Find the name of all instructor in the Biology department</span>
<span class="k">select</span><span class="w"> </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="n">faculty</span>
<span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Biology&#39;</span>

<span class="c1">-- create a view of department salary total</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">department_total_salary</span><span class="p">(</span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="n">total_salery</span><span class="p">)</span><span class="w"> </span><span class="k">as</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">dept_name</span>
</code></pre></div>
<blockquote>
<p><strong>create view <view_name>(attribute_name) as</strong></p>
<p><strong>select …..</strong></p>
<p><strong>在创建view之后，如果view名字后面没有添加属性的名字，就按照select语句的属性名来</strong></p>
</blockquote>
<p>view 可以隐掉一些细节，或者加上一些统计数据。<strong>可以把 view 当作表进行查询</strong>。</p>
<ul>
<li>隐藏不必要的细节，简化用户视野</li>
<li>方便查询书写</li>
<li>有利于权限控制（如用户可以看到工资总和，但不能看到每个人的工资）</li>
<li>有独立性，使得数据库应用具有较强的适应性。</li>
</ul>
<blockquote>
<p><strong><code>可以基于视图再定义视图。</code></strong></p>
<p><strong>Example "Views Defined Using Other Views"</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code>```sql
create view physics_fall_2009 as
    select course.course_id, sec_id, building, room_number
    from course,section
    where course.course_id = section.course_id
    and course.dept_name = &#39;Physics&#39;
    and section.semester = &#39;Fall&#39;
    and section.year = &#39;2009&#39;

create view physics_fall_2009_watson as
    select course_id, room_number
    from physics_fall_2009
    where building = &quot;Waston&quot;
```
</code></pre></div>
<p><strong>基于视图再定义视图的执行方式</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">room_number</span>
<span class="k">from</span><span class="w"> </span><span class="n">physics_fall_2009</span>
<span class="k">where</span><span class="w"> </span><span class="n">building</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Waston&#39;</span>
<span class="o">-&gt;</span>
<span class="k">select</span><span class="w"> </span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">room_number</span>
<span class="k">from</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">building</span><span class="p">,</span><span class="w"> </span><span class="n">room_number</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="p">,</span><span class="w"> </span><span class="n">section</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">     </span><span class="k">and</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Physics</span><span class="err">’</span>
<span class="w">     </span><span class="k">and</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Fall</span><span class="err">’</span>
<span class="w">     </span><span class="k">and</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="mi">2009</span><span class="err">’</span><span class="p">)</span>
<span class="k">where</span><span class="w"> </span><span class="n">building</span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Watson</span><span class="err">’</span><span class="p">;</span>
<span class="o">-&gt;</span>
<span class="k">select</span><span class="w"> </span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">room_number</span>
<span class="k">from</span><span class="w"> </span><span class="n">course</span><span class="p">,</span><span class="w"> </span><span class="n">section</span>
<span class="k">where</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">course_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="n">course_id</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">course</span><span class="p">.</span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Physics</span><span class="err">’</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="n">semester</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Fall</span><span class="err">’</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">section</span><span class="p">.</span><span class="k">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="mi">2009</span><span class="err">’</span>
<span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">building</span><span class="o">=</span><span class="w"> </span><span class="err">’</span><span class="n">Watson</span><span class="err">’</span><span class="p">;</span>
</code></pre></div>
<h3 id="442-update-of-a-view">4.4.2 Update of a View<a class="headerlink" href="#442-update-of-a-view" title="Permanent link">&para;</a></h3>
<p><strong><code>对一个 view 进行修改，相当于通过这个窗口对原表继续修改。</code></strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">-- add a new tuple to faculty view </span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">faculty</span><span class="w"> </span><span class="k">as</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">dept_name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">instructor</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">faculty</span><span class="w"> </span><span class="k">values</span><span class="p">(......)</span>
</code></pre></div>
<p><strong>向view中插入一行，相当于向实际的表中插入一行，缺失的属性填写null。但如果实际的表中对应属性有完整性约束not null，则无法插入这一行。</strong></p>
<p><strong><code>如果视图中有统计的属性，那么是不可修改的,聚合函数部分涉及到计算，不能直接插入数据。同理不能使用distinct，group by， having clause</code></strong>  </p>
<p>涉及到单个表，只是选出了部分属性（去掉非主属性）的行列视图是可更新的。</p>
<h3 id="443-materialized-views">4.4.3 *Materialized Views<a class="headerlink" href="#443-materialized-views" title="Permanent link">&para;</a></h3>
<p>物化视图</p>
<p><strong>Materializing a view</strong>: create a physical table containing all the tuples in the result of the query defining the view.  </p>
<p>物化视图：创建一个物理表，其中包含定义视图的查询结果中的所有元组。</p>
<blockquote>
<p><strong>本来的视图是一个虚的表</strong>，为了查询执行效率，我们可以把 view 定义为 Materializing view, 即<strong>生成一张临时表与其对应</strong>。  </p>
</blockquote>
<p>If relations used in the query are updated, the <strong>materialized view</strong> result becomes out of date.  </p>
<p>如果更新了查询中使用的关系，则实例化视图结果将过期。</p>
<p><strong><code>这是因为此时物化视图与原表之间是两个存在，不存在联系</code></strong></p>
<ul>
<li>
<p>Need to maintain the view, by updating the view whenever the underlying relations are updated.  </p>
<p>需要维护视图，每当基础关系更新时，都会更新视图。</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302125151.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330212510077" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302125151.png" /></a></p>
<h3 id="444-view-and-logical-data-indepencence">4.4.4 View and Logical Data Indepencence<a class="headerlink" href="#444-view-and-logical-data-indepencence" title="Permanent link">&para;</a></h3>
<p>If relation <span class="arithmatex">\(S(a, b, c)\)</span> is split into two sub relations <span class="arithmatex">\(S1(a,b)\)</span> and <span class="arithmatex">\(S2(a,c)\)</span></p>
<p>How to realize the logical data independence(<strong>逻辑独立性</strong>)?   </p>
<ol>
<li>create table <span class="arithmatex">\(S1\)</span>...;<code></code>create table <span class="arithmatex">\(S2\)</span>...;</li>
<li>insert into <span class="arithmatex">\(S1\)</span> select a, b from S;<code></code>insert into <span class="arithmatex">\(S2\)</span> select a, c from S;</li>
<li>drop table S;</li>
<li>create view S(a, b, c) as select a, b, c from <span class="arithmatex">\(S1\)</span> natural join <span class="arithmatex">\(S2\)</span>;`   </li>
</ol>
<p><code>select * from S where...</code> 实际上是在做 <code>select * from S1 natural join S2 where ...</code> （系统会帮我这样做，程序不用改，只是执行改变了）</p>
<p><code>insert into S values (1,2,3)</code> 实际上是在做 <code>insert into S1 values (1,2)</code> 和 <code>insert into S2 values (1,3)</code>  </p>
<p>delete 同理</p>
<h2 id="45-indexes">4.5 Indexes<a class="headerlink" href="#45-indexes" title="Permanent link">&para;</a></h2>
<p>Indices are data structures used to <strong>speed up access to records</strong> with specified values for index attributes.  </p>
<p>Index 相当于在数据上建立了 B+ 树索引。（物理层面）</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">student</span><span class="w">    </span>
<span class="p">(</span><span class="w">   </span>
<span class="n">ID</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span>
<span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="n">tot_cred</span><span class="w"> </span><span class="nb">numeric</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">studentID_index</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">student</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>
<span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span>
<span class="k">where</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">‘</span><span class="mi">12345</span>
<span class="c1">-- can be executed by using the index to find the required record, without looking at all records of student</span>
</code></pre></div>
<p>在数据库内不同的物理实现有不同的查找方法。  </p>
<p>如果没有定义索引，只能顺序查找。</p>
<p>如果有索引，系统内会利用索引查找。</p>
<h2 id="46-transactions事务">4.6 Transactions(事务)<a class="headerlink" href="#46-transactions事务" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>原子事务：要么完全被执行，要么向从未发生过一样回退。</strong></p>
</blockquote>
<p>并发事务具有相关性。例如银行转账，一个账户的钱减少，必然伴随另外一个账户钱增加。如果另一个账户的钱还没有增加的时候，就被打断，此时第一个账户的钱必须加回来，就像没有发生转账操作过一样。</p>
<ul>
<li>
<p>Transactions begin implicitly  事务隐式开始</p>
<p>Ended by <strong>commit work</strong> or <strong>rollback work</strong>  </p>
</li>
<li>
<p>By default on most databases: each SQL statement commits automatically  </p>
<p><strong>默认情况下</strong>，在大多数数据库上：每个 SQL 语句都会<strong>自动提交</strong></p>
<ul>
<li>Can <strong>turn off</strong> auto commit for a session 关闭自动提交</li>
</ul>
<p><strong><em>e.g.</em></strong> in MySQL, <code>SET AUTOCOMMIT=0;</code>  </p>
<div class="highlight"><pre><span></span><code><span class="k">SET</span><span class="w"> </span><span class="n">AUTOCOMMIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
<span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">-</span><span class="mi">100</span><span class="w"> </span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ano</span><span class="o">=</span><span class="err">‘</span><span class="mi">1001</span><span class="err">’</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
<span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">+</span><span class="mi">100</span><span class="w"> </span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ano</span><span class="o">=</span><span class="err">‘</span><span class="mi">1002</span><span class="err">’</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="w"> </span><span class="o">-</span><span class="mi">200</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ano</span><span class="o">=</span><span class="err">‘</span><span class="mi">1003</span><span class="err">’</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">+</span><span class="mi">200</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ano</span><span class="o">=</span><span class="err">‘</span><span class="mi">1004</span><span class="err">’</span><span class="p">;</span><span class="w"> </span>
<span class="k">COMMIT</span><span class="p">;</span>

<span class="k">UPDATE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span><span class="o">+</span><span class="n">balance</span><span class="o">*</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="o">%</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>
<blockquote>
<p><strong>commit或者rollback标志着事务的结束</strong></p>
<p><strong>如果没有commit，那么推出数据库重新进入，数据会恢复到没有改变的状态</strong></p>
</blockquote>
</li>
</ul>
<blockquote>
<p>火车票的预定和支付钱，是两个不同的事务，最后利用第三个事务退票来弥补预定事务</p>
</blockquote>
<h3 id="461-acid-properties">4.6.1 ACID Properties<a class="headerlink" href="#461-acid-properties" title="Permanent link">&para;</a></h3>
<p>A  transaction  is a unit of program execution that accesses and possibly updates various data items. To preserve the integrity of data the database system must ensure: (原子性、一致性、独立性、持续性)</p>
<ul>
<li>
<p><strong>Atomicity</strong>. Either all operations of the transaction are properly reflected in the database or none are.</p>
<p>要么同时进行，要么同时不进行</p>
</li>
<li>
<p><strong>Consistency</strong>. Execution of a transaction in isolation preserves the consistency of the database.  </p>
<p>数据库执行事务前后都是一致的。</p>
</li>
<li>
<p><strong>Isolation</strong>. Although multiple transactions may execute concurrently, each transaction must be unaware of other concurrently executing transactions.  Intermediate transaction results must be hidden from other concurrently executed transactions.    </p>
<p>很多事情共同执行，他们不能互相影响，每个事务必须不知道其他并发执行的事务。。</p>
<ul>
<li>That is, for every pair of transactions <span class="arithmatex">\(T_i\)</span> and <span class="arithmatex">\(T_j\)</span>, it appears to <span class="arithmatex">\(T_i\)</span> that either <span class="arithmatex">\(T_j\)</span>, finished execution before <span class="arithmatex">\(T_i\)</span> started, or <span class="arithmatex">\(T_j\)</span> started execution after <span class="arithmatex">\(T_i\)</span> finished.</li>
</ul>
</li>
<li>
<p><strong>Durability（持久性）</strong>. After a transaction completes successfully, the changes it has made to the database persist, even if there are system failures.   </p>
<p>数据库的事务一旦提交，这个修改就要持续地保存到数据库中去，不能丢失。如磁盘出问题了，断电了等会引发这个问题。  </p>
<p>通常使用日志。</p>
</li>
</ul>
<h2 id="47-authorization授权">4.7 Authorization（授权）<a class="headerlink" href="#47-authorization授权" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Forms of authorization on parts of the <em>database</em>  </p>
<p>对数据库各部分的授权形式</p>
<ul>
<li>
<p><em>Select</em> - allows reading, but not modification of data.</p>
<p>选择 - 允许读取数据，但不允许修改数据。</p>
</li>
<li>
<p><em>Insert</em> - allows insertion of new data, but not modification of existing data.</p>
<p>插入 - 允许插入新数据，但不允许修改现有数据。</p>
</li>
<li>
<p><em>Update</em> - allows modification, but not deletion of data.</p>
<p>更新 - 允许修改，但不允许删除数据。</p>
</li>
<li>
<p><em>Delete</em> - allows deletion of data.</p>
<p>删除 - 允许删除数据。</p>
</li>
</ul>
</li>
<li>
<p>Forms of authorization to modify the <em>database schema</em><br />
<strong>修改数据库schema的形式</strong></p>
<ul>
<li>
<p><em>Index</em> - allows creation and deletion of indices.</p>
<p>索引 - 允许创建和删除索引</p>
</li>
<li>
<p><em>Resources（create）</em> - allows creation of new relations.</p>
<p>允许创建新关系</p>
</li>
<li>
<p><em>Drop</em> - allows deletion of relations.</p>
<p>允许删除关系。</p>
</li>
<li>
<p><em>Alteration</em> - allows addition or deletion of attributes in a relation.</p>
<p>允许在关系中添加或删除属性</p>
</li>
<li>
<p><em>create view</em></p>
</li>
</ul>
</li>
</ul>
<h3 id="471-authorization-specification-in-sql">4.7.1 Authorization Specification in SQL<a class="headerlink" href="#471-authorization-specification-in-sql" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>授权规范：</strong></p>
</blockquote>
<p><code>grant &lt;privilege list&gt;</code></p>
<p><code>on &lt;relation name or view name&gt;</code></p>
<p><code>to &lt;user list&gt;</code>  </p>
<p>把某个表或者视图上的权限授权给用户  </p>
<p><code>&lt;user list&gt;</code> is:  </p>
<ul>
<li>
<p>a user-id</p>
</li>
<li>
<p><strong><code>public</code></strong>, which allows all valid users the privilege granted</p>
<p>允许所有有效用户获得授予的权限</p>
</li>
<li>
<p>A role (more on this later)</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181343257.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181343257.png" width = 60%/></a> </p>
<p>精细化控制到某一列（update （budget））</p>
<p>update 可以细化到具体可以对哪列进行修改。  </p>
</li>
</ul>
<h3 id="472-revoking-authorization-in-sql">4.7.2 Revoking Authorization in SQL<a class="headerlink" href="#472-revoking-authorization-in-sql" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>回收权限</strong></p>
</blockquote>
<p>The revoke statement is used to revoke authorization.  </p>
<p><code>revoke &lt;privilege list&gt;</code></p>
<p><code>on &lt;relation name or view name&gt;</code></p>
<p><code>from &lt;user list&gt;</code>  </p>
<div class="highlight"><pre><span></span><code><span class="k">revoke</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">U1</span><span class="p">,</span><span class="n">U2</span><span class="p">,</span><span class="n">U3</span>
</code></pre></div>
<p>grant to——revoke from</p>
<h3 id="473-roles">4.7.3 Roles<a class="headerlink" href="#473-roles" title="Permanent link">&para;</a></h3>
<p><strong>角色role：角色可以看成是一组权限的集合</strong></p>
<p>可以利用<code>create role &lt;role_name&gt;</code>来创造一个角色</p>
<p>可以将权力授予给某个角色<code>grant select on takes to instructor</code></p>
<p>可以将角色授予给某个用户<code>grant role_name to user</code></p>
<p>当然角色还能授予给其他角色，被授予的角色将继承授予角色的一切权力</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181546838.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240318154621739" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181546838.png" /></a></p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">role</span><span class="w"> </span><span class="n">instructor</span><span class="p">;</span>
<span class="k">grant</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">instructor</span><span class="p">;</span><span class="w">  </span><span class="c1">-- 授予权限给角色</span>
<span class="k">grant</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">Amit</span><span class="p">;</span><span class="w">   </span><span class="c1">-- 将角色的权限授予给用户</span>

<span class="c1">-- 角色授予角色</span>
<span class="k">create</span><span class="w"> </span><span class="k">role</span><span class="w"> </span><span class="n">teaching_assistant</span>
<span class="k">grant</span><span class="w"> </span><span class="n">teaching_assistant</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">instructor</span>
<span class="c1">-- instructor 将继承 teaching_assistant 所有的群里</span>

<span class="c1">-- 可以构造角色链</span>
</code></pre></div>
<p>还可以将视图上的权力授予给某个用户</p>
<div class="highlight"><pre><span></span><code>```sql
create view geo_instructor as
(select *
from instructor
where dept_name = ’Geology’);
grant select on geo_instructor  to  geo_staff
```
</code></pre></div>
<h3 id="474-other-authorization-features">4.7.4 Other Authorization Features<a class="headerlink" href="#474-other-authorization-features" title="Permanent link">&para;</a></h3>
<p>引用的权限比较特殊</p>
<p><code>references privilege to create foreign key</code></p>
<p><code>grant reference (dept_name) on department to Mariano;</code>
  <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181343273.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403181343273.png"></a> </p>
<p>如果不作为权限，我们<strong>可以通过间接的外键约束和 cascade 删掉被引用的数据</strong>。（删掉饮用者，则被引用者也要被删除）因此这也是个权限</p>
<p>transfer of privileges <strong>权限的传递</strong>
* <code>grant select on department to Amit with grant option;</code>   </p>
<div class="highlight"><pre><span></span><code>加上 `with grant option` 后，**用户可以把获得的权限传递下去。**
</code></pre></div>
<ul>
<li>
<p><code>revoke select on department from Amit, Satoshi cascade;</code>   </p>
<p><code>cascade</code> <strong>把该用户及其授予的权限全部收回，级联反应。</strong>  </p>
</li>
<li>
<p><code>revoke select on department from Amit, Satoshi restrict;</code>  </p>
<p><code>restrict</code> <strong>只收回该用户的权限，不产生级联反应</strong> </p>
</li>
<li>
<p><code>revoke grant option for select on department from Amit;</code>  </p>
<p><strong>收回Amit传递相应权限的权力，但没有收回Amit在表上查询的权力。</strong></p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202408251501074.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240825150115998" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202408251501074.png" /></a></p>
<div class="arithmatex">\[
\pi_{name}(\sigma_{department= 'CS' \and building = '白沙一幢' \and room = 213} (student))
\]</div>
<div class="arithmatex">\[
a = \pi_{building, room}(\sigma_{name = '王小强'}(student))\\
\pi_{name} (\sigma_{student.building = a.buliding \and student.room = a.room \and student.name != '王小强'}(student \bowtie a))
\]</div>
<div class="arithmatex">\[
\pi_{s1.sid, s2.sid}(\sigma_{s1.sid &lt;&gt; s2.sid \and s1.department &lt;&gt; s2.department \and s1.buliding = s2.building \and s1.room = s2.room}(\rho_{s1}(student) \times \rho_{s2}(student)))
\]</div>
<div class="arithmatex">\[
\rho_{d1(building, room, occupied)(building, room, G_{count(id)}}(student)\\
\pi_{dorm.building,dorm.room}(\sigma_{dorm.capacity = d1.occupied}(dorm \bowtie d1)))
\]</div>
<hr />
<hr />
<h1 id="五-advanced-sql">五. Advanced SQL<a class="headerlink" href="#五-advanced-sql" title="Permanent link">&para;</a></h1>
<h2 id="51-accessing-sql-from-a-programming-language">5.1 Accessing SQL from a Programming Language<a class="headerlink" href="#51-accessing-sql-from-a-programming-language" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>并非所有查询都可以用 SQL 表示，因为 SQL 不提供通用语言的全部表达能力。</p>
</li>
<li>
<p>用户交互是图形界面，语音、图像，数据库不具备这方面的功能。</p>
<p>从高级语言（如 C）访问数据库，主要是下面两种方式：</p>
</li>
<li>
<p><strong>API</strong>(Application Program Interface) -- A general-purpose program can connect to and communicate with a database server using a collection of functions.  </p>
</li>
</ul>
<p><strong>API:用于程序与数据库服务器的交互</strong></p>
<p><strong>应用程序调用数据库的过程：</strong></p>
<p>① 连接数据库服务器。</p>
<p>② 向数据库服务器发送SQL命令。</p>
<p>③ 将结果的元组一个一个提取到程序变量中。</p>
<ul>
<li>
<p><strong>Embedded SQL</strong> -- provides a means by which a program can interact with a database server.   </p>
<p>嵌入式 SQL -- 提供程序与数据库服务器交互的方法。</p>
<ul>
<li>The SQL statements are translated at <em>compile time</em> into function calls.   </li>
</ul>
<p>SQL 语句在编译时转换为函数调用。</p>
<ul>
<li>At runtime,  these function calls connect to the database  using an API that provides dynamic SQL facilities.  </li>
</ul>
<p>在运行时，这些函数调用使用提供动态 SQL 工具的 API 连接到数据库。</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302209183.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330220915090" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302209183.png" /></a></p>
<h3 id="511-jdbc-and-odbc">5.1.1 JDBC and ODBC<a class="headerlink" href="#511-jdbc-and-odbc" title="Permanent link">&para;</a></h3>
<p><strong>API</strong> (application-program interface) for a program to interact with a database server  </p>
<p><strong>API（应用程序-程序接口），用于程序与数据库服务器交互</strong></p>
<p>Application makes calls to</p>
<ul>
<li>
<p><strong>Connect with the database server</strong>  </p>
<p><strong>与数据库服务器连接</strong></p>
</li>
<li>
<p><strong>Send SQL commands to the database server</strong>  </p>
<p><strong>将 SQL 命令发送到数据库服务器</strong></p>
</li>
<li>
<p><strong>Fetch tuples of result one-by-one into program variables</strong>  </p>
<p><strong>将结果的元组逐个提取到程序变量中</strong></p>
</li>
</ul>
<p>SQL 与 C 语言存在鸿沟（如 select 得到的是集合，但是 C 语言没有这种类型）会返回指针/迭代器</p>
<ul>
<li>
<p><strong>ODBC</strong> <code>(Open Database Connectivity) works with C, C++, C#</code></p>
<p>ODBC（开放式数据库连接）适用于 C、C++、C#</p>
</li>
<li>
<p><strong>JDBC</strong> <code>(Java Database Connectivity) works with Java</code></p>
<p>通过类定义，将数据库操作封装到 Java 内</p>
</li>
<li>
<p>Embedded SQL in C <strong>C语言中的嵌入式SQL</strong></p>
</li>
<li>
<p><strong>SQLJ</strong> - embedded SQL in Java  <strong>Java语言中的嵌入式SQL</strong></p>
</li>
<li>
<p><strong>JPA</strong>(Java Persistence API)  - OR mapping of Java  </p>
</li>
</ul>
<h4 id="5111-jdbc">5.1.1.1 JDBC<a class="headerlink" href="#5111-jdbc" title="Permanent link">&para;</a></h4>
<p><strong>JDBC</strong> is a Java API for communicating with database systems supporting SQL.  </p>
<p>JDBC 是一个 Java API，用于与支持 SQL 的数据库系统进行通信。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">JDBCexample</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dbid</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">passwd</span><span class="p">)</span><span class="w"> </span>
<span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="s">&quot;jdbc:oracle:thin:@db.yale.edu:2000:univdb&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userid</span><span class="p">,</span><span class="w"> </span><span class="n">passwd</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="n">Statement</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">();</span><span class="w"> </span>
<span class="w">              </span><span class="p">...</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">Actual</span><span class="w"> </span><span class="n">Work</span><span class="w"> </span><span class="p">...</span>
<span class="w">        </span><span class="n">stmt</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">   </span>
<span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">   </span>
<span class="w">     </span><span class="p">}</span><span class="w">      </span>
<span class="w">     </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">sqle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">        </span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SQLException : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqle</span><span class="p">);</span><span class="w">     </span>
<span class="w">     </span><span class="p">}</span><span class="w">      </span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>Open a connection</p>
<p>上述程序中，Connection是一个类，conn是一个类中的对象，<strong>获得一个Java程序与数据库之间的连接</strong>。</p>
</li>
<li>
<p>Create a “statement” object</p>
<p>statement 也是一个类，stmt是一个类中的对象，<strong>程序真正要做的事情在Do Actual Work处</strong></p>
</li>
<li>
<p>Execute queries using the Statement object to send queries and fetch results</p>
<p>做完后，要<strong>先将对象stmt关闭掉，再将对象conn关闭掉</strong>。</p>
</li>
<li>
<p>Exception mechanism to handle errors</p>
<p>try……catch语句是一种<strong>异常处理的机制</strong>，在try部分中所有的函数与方法的<strong>错误，都会抛出到catch中被捕获</strong>。</p>
</li>
</ul>
<blockquote>
<p><strong>Update to database</strong>  更新数据库</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">Update</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">database</span><span class="w"> </span>
<span class="k">try</span><span class="w"> </span>
<span class="p">{</span>
<span class="w">    </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;insert into instructor values(’77987’, ’Kim’, ’Physics’, 98000)&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span>
<span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">sqle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not insert tuple. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqle</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p><strong>Execute query and fetch and print results  执行查询以及获取和打印结果</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;select dept_name, avg (salary)</span>
<span class="s">            from instructor</span>
<span class="s">            group by dept_name&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rset</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rset</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;dept_name&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rset</span><span class="p">.</span><span class="na">getFloat</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p><code>ResultSet</code> 是一个类，里面有一个对象 <code>rset</code>，用来获得select的结果。</p>
<p><span class="arithmatex">\(while(rset.next())\)</span>循环中，指针最开始指向第一个元组的上一个，<span class="arithmatex">\(rset.next()\)</span>让指针指向下一个元组。</p>
<p><code>rset.getstring（“dept_name”）</code>表示拿到字符串类型的列名为dept_name的一个元素；</p>
<p><code>System.out.printin</code> 是用来打印的函数</p>
<blockquote>
<p><strong>Getting result fields 获取结果字段</strong></p>
</blockquote>
<p><code>rset.getString(“dept_name”)</code></p>
<p><code>rset.getString(1)</code></p>
<p>两者等价如果dept_name是结果的第一个变量</p>
<blockquote>
<p><strong>Dealing with Null values 处理 Null 值</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rset</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="err">“</span><span class="n">a</span><span class="err">”</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rset</span><span class="p">.</span><span class="na">wasNull</span><span class="p">())</span><span class="w"> </span><span class="n">Systems</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="err">“</span><span class="n">Got</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="n">value</span><span class="err">”</span><span class="p">);</span>
</code></pre></div>
<p>如果返回值是空的（<code>rset.wasNull</code>），那么就打印出一行：Got Null value。</p>
<p><strong>Prepared Statement</strong>  预编译声明</p>
<div class="highlight"><pre><span></span><code><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">pStmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;insert into instructor values(?,?,?,?)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;88877&quot;</span><span class="p">);</span><span class="w">      </span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Perry&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Finance&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">125000</span><span class="p">);</span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">();</span><span class="w">    </span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;88878&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">pStmt</span><span class="p">.</span><span class="na">executeUpdate</span><span class="p">();</span>
</code></pre></div>
<blockquote>
<p><strong>这里问号是占位符，表示执行时需要提供四个参数</strong>。 </p>
<p><code>setString, setInt</code> 就是把第几个占位符设置为参数，并 <code>executeUpdate</code> 进行插入。</p>
</blockquote>
<p>预编译的时候开始留出占位符，在实际使用的时候，利用setString函数，直接在相应的位置上填入值。</p>
<p><code>pStmt.setString(1,“88877”)</code>表示，给第一个参数的位置放上88877。</p>
<p><code>pStmt.executeUpdate（）</code>表示运行，插入四个参数。</p>
<p>Always use prepared statements when taking an input from the user and adding it to a query. <strong>NEVER</strong> create a query by concatenating strings which you get as inputs.  </p>
<p>在从用户那里获取输入并将其添加到查询时，始终使用预准备语句。切勿通过连接作为输入获取的字符串来创建查询。  </p>
<blockquote>
<p><strong>SQL Injection(SQL 注入攻击)</strong></p>
<p><strong>通过用户的输入来构造一条完整的SQL语句，可能会对数据库造成攻击</strong></p>
</blockquote>
<ol>
<li>
<p>Suppose query is constructed using
   select * from instructor where name = <code>‘  ” + name + “  ’</code> 
    表示要求name = <code>‘  ” + name + “  ’</code></p>
</li>
<li>
<p>Suppose the user, instead of entering a name, enters:</p>
<p>X’ or ’Y’ = ’Y</p>
</li>
<li>
<p>then the resulting string of the statement becomes:</p>
<p><code>select * from instructor where name = ’" + "X’ or ’Y’ = ’Y" + “’</code>
、
which is:
<code>select * from instructor where name = ’X’ or ’Y’ = ’Y’</code></p>
<p><strong>这样就会造成对Y选择出错</strong></p>
</li>
<li>
<p>User could have even used
   X’; update instructor set salary = salary + 10000; </p>
<p>从而使字符串变为：</p>
<p>select * from instructor where name = ’X’;</p>
<p>update instructor set salary = salary + 10000;</p>
<p><strong>这样就会造成，额外执行指令</strong></p>
</li>
</ol>
<blockquote>
<p><strong>解决方法：</strong></p>
<p><strong>Always use prepared statements, with user inputs as parameters</strong></p>
<p><strong>始终使用预处理语句，并将用户输入作为参数</strong></p>
</blockquote>
<p><strong>Metadata Features</strong>  </p>
<blockquote>
<ul>
<li><strong>finding all the relations in the database and</strong>
  <strong>查找数据库中的所有关系，并</strong></li>
<li><strong>finding the names and types of columns of a query result or a relation in the database.</strong>
  <strong>查找数据库中查询结果或关系的列的名称和类型。</strong></li>
</ul>
</blockquote>
<ul>
<li>
<p><strong>ResultSet metadata</strong> </p>
<p>after executing query to get a ResultSet rs:</p>
<p>在运行一条语句，得到了一个<strong>ResultSet类中的对象rs</strong>，</p>
<p>可以通过调用<code>rs.getMetaData（）</code>函数，来获取元数据。</p>
<div class="highlight"><pre><span></span><code><span class="n">ResultSetMetaData</span><span class="w"> </span><span class="n">rsmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">getMetaData</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rsmd</span><span class="p">.</span><span class="na">getColumnCount</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rsmd</span><span class="p">.</span><span class="na">getColumnName</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rsmd</span><span class="p">.</span><span class="na">getColumnTypeName</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p><strong>利用上述的代码，可以实现返回属性名和属性的类型（不知道有多少列，用getColumnCount（））</strong></p>
<p>getColumnCount()表示获取结果集合中列的数目；</p>
<p>getColumnName(i)表示获取第i列的列名；</p>
<p>getColumnTypeName(i)表示获取第i列的列类型。</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302339190.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240330233913096" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403302339190.png" /></a></p>
<p><strong>这个的前提是，已知属性和类型，得到对应的数据</strong></p>
</li>
<li>
<p><strong>Database metadata</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">DatabaseMetaData</span><span class="w"> </span><span class="n">dbmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">getMetaData</span><span class="p">();</span>
<span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbmd</span><span class="p">.</span><span class="na">getColumns</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;univdb&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;department&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="p">);</span>
<span class="c1">// Arguments to getColumns: Catalog, Schema-pattern, Table-pattern,</span>
<span class="c1">// and Column-Pattern</span>
<span class="c1">// Returns: One row for each column; row has a number of attributes</span>
<span class="c1">// such as COLUMN_NAME, TYPE_NAME</span>
<span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">rs</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;COLUMN_NAME&quot;</span><span class="p">),</span>
<span class="w">                       </span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;TYPE_NAME&quot;</span><span class="p">);</span>
</code></pre></div>
<p><code>dbmd.getColumns</code>中，先是<strong>目录</strong>的名字（<code>null</code>），再是<strong>Schema</strong>的名字“<code>univdb</code>”，再是<strong>表</strong>的名字“<code>department</code>”，“%”表示<strong>返回这个表的全部列</strong>。最后将结果保存在类ResultSet的对象rs中。</p>
<p>如果要遍历结果表中所有的行元组，仍然可以用<code>ResultSet</code>类中rs对象的next（）函数遍历：</p>
</li>
</ul>
<blockquote>
<p>前面我们获得的是ResultSet的元数据，这里我们获得的是数据库detabase的元数据</p>
<p>对于ResultSet的元数据，可以使用<code>ResultSetMetadata rsmd = rs.getMetadata</code>获取。我们将得到，ResultSet所有的属性名和属性的类型</p>
<p>对于Database的元数据，可以使用<code>ResultSet rs = dbmd.getColumns(目录名， 视图名， 表名， %)获取表的全部列保存在rs中</code>，</p>
</blockquote>
<p><strong>Transaction Control in JDBC</strong>  </p>
<p><strong>JDBC 中的事务控制</strong></p>
<ul>
<li>Can <strong>turn off</strong> automatic commit on a connection <code>conn.setAutoCommit(false);</code></li>
<li>Transactions must then <strong>be committed or rolled back</strong> <em>explicitly</em> <code>conn.commit();</code> or <code>conn.rollback();</code></li>
<li><code>conn.setAutoCommit(true)</code> <strong>turns on</strong> automatic commit.</li>
</ul>
<p>所有的数据库功能都是通过 Java 封装好的类来实现的。</p>
<h4 id="5112-sqlj">5.1.1.2 SQLJ<a class="headerlink" href="#5112-sqlj" title="Permanent link">&para;</a></h4>
<blockquote>
<p><strong>SQLJ : embedded SQL in Java</strong></p>
</blockquote>
<p><div class="highlight"><pre><span></span><code><span class="w">    </span><span class="err">#</span><span class="n">sql</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="nf">deptInfoIter</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">avgSal</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 定义一个类</span>
<span class="w">    </span><span class="n">deptInfoIter</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 类的实例</span>
<span class="w">    </span><span class="err">#</span><span class="n">sql</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="n">dept_name</span><span class="p">,</span><span class="w"> </span><span class="n">avg</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">avgSal</span><span class="w"> </span>
<span class="w">                    </span><span class="n">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span>
<span class="w">                    </span><span class="n">group</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">String</span><span class="w"> </span><span class="n">deptName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="na">dept_name</span><span class="p">();</span>
<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">avgSal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="na">avgSal</span><span class="p">();</span>
<span class="w">          </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">deptName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">avgSal</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">iter</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</code></pre></div>
在执行SQL相关语句时，要带上<code>#sql</code>，最后会被编译器转化为 Java 的类。</p>
<h4 id="5113-odbc">5.1.1.3 ODBC<a class="headerlink" href="#5113-odbc" title="Permanent link">&para;</a></h4>
<blockquote>
<p><strong>Open DataBase Connectivity</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251401889.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240325140130758" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251401889.png" /></a></p>
<p>Each database system supporting ODBC provides a <strong>"driver" library</strong> that must be linked with the client program.</p>
<p>每个支持 ODBC 的数据库系统都提供了一个必须与客户端程序链接的“<strong>驱动程序</strong>”<strong>库</strong>
    <div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">ODBCexample</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">RETCODE</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">        </span><span class="n">HENV</span><span class="w">    </span><span class="n">env</span><span class="p">;</span><span class="w">     </span><span class="cm">/* environment */</span><span class="w"> </span>
<span class="w">        </span><span class="n">HDBC</span><span class="w">    </span><span class="n">conn</span><span class="p">;</span><span class="w">  </span><span class="cm">/* database connection */</span><span class="w"> </span>
<span class="w">        </span><span class="n">SQLAllocEnv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">env</span><span class="p">);</span>
<span class="w">        </span><span class="n">SQLAllocConnect</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">conn</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// NTS null terminate string</span>
<span class="w">        </span><span class="n">SQLConnect</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="err">“</span><span class="n">db</span><span class="p">.</span><span class="n">yale</span><span class="p">.</span><span class="n">edu</span><span class="s">&quot;, SQL_NTS, &quot;</span><span class="n">avi</span><span class="s">&quot;, SQL_NTS, &quot;</span><span class="n">avipasswd</span><span class="s">&quot;, SQL_NTS); </span>
<span class="w">        </span><span class="err">…</span><span class="p">.</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="err">…</span><span class="w">  </span>
<span class="w">        </span><span class="n">SQLDisconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="n">SQLFreeConnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="n">SQLFreeEnv</span><span class="p">(</span><span class="n">env</span><span class="p">);</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div></p>
<p>首先，调用<code>SQLAllocEnv（&amp;env）</code>,获得一个环境。然后，调用<code>SQLAllocConnect（env，&amp;conn）</code>;在这个环境中，生成一个连接。</p>
<p>同一个数据库可能服务于多个用户，而且使用的编程语言可能不同，如字符串的结束标志可能也不同，因此需要用 <code>SQL_NTS</code> 标识。</p>
<blockquote>
<p><strong>SEL_NTS 表示 null terminate string，用null来终止字符串</strong></p>
</blockquote>
<p>当实际的工作做完以后，要将conn关闭掉、回收掉,要将env回收掉。</p>
<ul>
<li>
<p>Program sends SQL commands to database by using <code>SQLExecDirect</code></p>
<p>程序向数据库发送SQL指令</p>
</li>
<li>
<p>Result tuples are fetched using <code>SQLFetch()</code></p>
<p>结果元组的获取方式</p>
</li>
<li>
<p><code>SQLBindCol()</code> binds C language variables to attributes of the query result </p>
<p>将 C 语言变量绑定到查询结果的属性</p>
<ul>
<li>
<p>When a tuple is fetched, its attribute values are automatically stored in corresponding C variables.  </p>
<p>当提取元组时，其属性值会自动存储在相应的 C 变量中。</p>
</li>
<li>
<p>Arguments to SQLBindCol() </p>
<p>SQLBindCol（） 的<strong>参数</strong></p>
</li>
<li>
<p>ODBC stmt variable, attribute position in query result</p>
<p>ODBC stmt 变量</p>
</li>
<li>
<p>The type conversion from SQL to C.  </p>
<p>从 SQL 到 C 的<strong>类型转换</strong></p>
</li>
<li>
<p>The address of the variable. </p>
<p>变量的地址</p>
</li>
<li>
<p>For variable-length types like character arrays,   </p>
<ul>
<li>
<p>The <strong>maximum length</strong> of the variable   变量的最大长度</p>
</li>
<li>
<p><strong>Location to store</strong> actual length when a tuple is fetched. </p>
<p>获取元组时存储<strong>实际长度</strong>的<strong>位置</strong></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Note: A negative value returned for the length field indicates null value</strong></p>
<p><strong>当传入到C变量的值为空时，存储实际长度的位置置为-1</strong></p>
<p>如果结果为空，则 <code>lenOut</code> 为 -1. </p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="n">deptname</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
<span class="kt">float</span><span class="w"> </span><span class="n">salary</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">lenOut1</span><span class="p">,</span><span class="w"> </span><span class="n">lenOut2</span><span class="p">;</span>
<span class="n">HSTMT</span><span class="w"> </span><span class="n">stmt</span><span class="p">;</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqlquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;select dept_name, sum (salary) </span>
<span class="w">                    </span><span class="n">from</span><span class="w"> </span><span class="n">instructor</span><span class="w"> </span>
<span class="w">                    </span><span class="n">group</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">dept_name</span><span class="s">&quot;;</span>
<span class="c1">// stmt statement</span>
<span class="n">SQLAllocStmt</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stmt</span><span class="p">);</span>
<span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SQLExecDirect</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="n">sqlquery</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_NTS</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// bindcol 绑定列</span>
<span class="w">    </span><span class="c1">// 1 表示第一列， 80表示字符数组长度， &amp;lenout1表示实际长度</span>
<span class="w">    </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_C_CHAR</span><span class="p">,</span><span class="w"> </span><span class="n">deptname</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut1</span><span class="p">);</span>
<span class="w">    </span><span class="n">SQLBindCol</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_C_FLOAT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lenOut2</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">SQLFetch</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SQL_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot; %s %g</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">deptname</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">SQLFreeStmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span><span class="w"> </span><span class="n">SQL_DROP</span><span class="p">);</span>
</code></pre></div>
<p><code>SQLAllocStmt(conn, &amp;stmt)</code>表示在conn这个连接中，分配一个代表语句的对象</p>
<p><code>SQLExecDirect</code>用来执行<strong>sqlquery字符串</strong>表达的语句，其中的<strong>参数SQL_NTS</strong>表明，这个字符串是以‘\0’结尾结束的。<code>SQLExecDirect</code>的<strong>返回值</strong>保存在变量error中</p>
<p>如果error为<code>SQL SUCCESS</code>，表示上述<strong>语句已经执行成功</strong>了，返回的两列dept_name与sum(salary)已经存在了</p>
<p>然后，<code>SQLBindCol</code>函数将C语言的变量绑定到查询返回的结果。</p>
<ul>
<li>
<p>SQLBindCol(stmt, 1, SQL_C_CHAR, deptname, 80, &amp;lenOut1);</p>
<p>把语句stmt的第一列，传到变量deptname，变量deptname的最大长度是80，实际长度填写到 lenOut1中</p>
</li>
<li>
<p>SQLBindCol(stmt, 2, SQL_C_FLOAT, &amp;salary, 0 , &amp;lenOut2);</p>
<p>把语句stmt中的第二列，传到变量salary中，将变量salary的长度传到lenOut2中。</p>
<p><strong>如果变量salary为空，那么lenOut2中置为-1，否则置为它实际的长度。</strong></p>
</li>
</ul>
<p>然后，利用<strong><code>SQLFetch</code></strong>函数，将返回结果stmt利用循环，<strong>将一行一行的元组依次抓取</strong>，如果抓取成功，那么就打印出这一行的deptname、salary的值。</p>
<p><strong>ODBC Prepared Statements</strong></p>
<p><strong>预编译的时候可以留出占位符</strong></p>
<ul>
<li>
<p>SQL statement prepared: compiled at the database</p>
<ul>
<li>
<p>To prepare a statement  准备声明</p>
<p><code>SQLPrepare(stmt, &lt;SQL String&gt;);</code>  </p>
</li>
<li>
<p>To bind parameters  绑定参数</p>
<p><code>SQLBindParameter(stmt, &lt;parameter#&gt;,  ... type information and value omitted for simplicity..)</code></p>
</li>
<li>
<p>To execute the statement 执行语句</p>
<p><code>retcode = SQLExecute(stmt);</code></p>
</li>
</ul>
</li>
<li>
<p>Can have <strong>placeholders（占位符）</strong>: <strong><em>e.g.</em></strong> <code>insert into account values(?,?,?)</code></p>
</li>
<li>
<p>Repeatedly executed with actual values for the placeholders</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403311112317.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240331111228180" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403311112317.png" /></a></p>
<p><strong>More ODBC Features</strong>  </p>
<ul>
<li>
<p>Metadata features  </p>
<ul>
<li>
<p>finding all the relations in the database and</p>
<p><strong>查找数据库中的所有关系 （Database Metadata）</strong></p>
</li>
<li>
<p>finding the names and types of columns of a query result or a relation in the database.</p>
<p><strong>查找数据库中查询结果或关系的列的名称和类型 (ResultSet Metadata)</strong></p>
</li>
</ul>
</li>
<li>
<p>By default, each SQL statement is treated as a separate transaction that is committed automatically.</p>
<p>默认情况下，每个 SQL 语句都被视为自动提交的单独事务。</p>
<ul>
<li>
<p>Can turn off automatic commit on a connection <code>SQLSetConnectOption(conn, SQL_AUTOCOMMIT, 0)</code></p>
<p>可以关闭连接的自动提交 SQLSetConnectOption（conn, SQL_AUTOCOMMIT, 0)</p>
</li>
<li>
<p>Transactions must then be committed or rolled back explicitly by <code>SQLTransact(conn, SQL_COMMIT)</code> or <code>SQLTransact(conn, SQL_ROLLBACK)</code></p>
<p>事务必须由 <code>SQLTransact(conn, SQL_COMMIT)</code> 或 <code>SQLTransact(conn, SQL_ROLLBACK)</code> <strong>显式提交或回滚</strong></p>
</li>
</ul>
</li>
</ul>
<h4 id="5114-embedded-sql">5.1.1.4 Embedded SQL<a class="headerlink" href="#5114-embedded-sql" title="Permanent link">&para;</a></h4>
<p>A language to which SQL queries are embedded is referred to as a <strong>host language</strong>, and the SQL structures permitted in the host language comprise embedded SQL.  </p>
<p>如把 SQL 嵌入到 C 语言，那么 C 语言是 host.  </p>
<p>在编译前，有一个预编译器，将 SQL 语句翻译。</p>
<p><strong>EXEC SQL</strong> statement is used in the host language to identify embedded SQL request to the preprocessor (in Java, <code># SQL { ... };</code>)</p>
<p><strong>Issues with Embedded SQL</strong></p>
<ul>
<li>Mark the start point and end point of Embedded SQL <code>EXEC  SQL  &lt;statement&gt;；  //C</code></li>
</ul>
<p><strong>Before executing any SQL statements</strong>, the program must first connect to the database. This is done using: <code>EXEC-SQL connect to server user user-name using password;</code></p>
<p>在执行任何SQL指令之前，需要先连接数据库</p>
<p><strong>Variables of the host language can be used within embedded SQL statements</strong>. They are preceded by a colon (:) to distinguish from SQL variables (e.g., :<em>credit_amount )</em></p>
<p>host语言的变量可以在嵌入式 SQL 语句中使用。 它们前面有一个<strong>冒号 (:)</strong> 以区别于 SQL 变量（例如 :<em>credit_amount ）</em></p>
<p>要使用host语言的变量，需要先进行申明DECLARE</p>
<div class="highlight"><pre><span></span><code><span class="n">EXEC</span><span class="o">-</span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="n">credit</span><span class="o">-</span><span class="n">amount</span><span class="w"> </span><span class="p">;</span>
<span class="n">EXEC</span><span class="o">-</span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
</code></pre></div>
<blockquote>
<p><strong>insert、delete、update、select(single record)</strong></p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="n">main</span><span class="p">(</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">INCLUDE</span><span class="w"> </span><span class="n">SQLCA</span><span class="p">;</span><span class="w"> </span><span class="c1">//声明段开始</span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">BEGIN</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">account_no</span><span class="w"> </span><span class="p">[</span><span class="mi">11</span><span class="p">];</span><span class="w">    </span><span class="c1">//host variables(宿主变量)声明</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">branch_name</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="n">balance</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">END</span><span class="w"> </span><span class="n">DECLARE</span><span class="w"> </span><span class="n">SECTION</span><span class="p">;</span><span class="c1">//声明段结束</span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">CONNECT</span><span class="w">  </span><span class="n">TO</span><span class="w">  </span><span class="n">bank_db</span><span class="w">  </span><span class="n">USER</span><span class="w"> </span><span class="n">Adam</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">Eve</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// EXEC SQL CONNECT TO语句连接上了数据库</span>
<span class="w">    </span><span class="n">scanf</span><span class="w"> </span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span><span class="w">  </span><span class="o">%</span><span class="n">s</span><span class="w">  </span><span class="o">%</span><span class="n">d</span><span class="err">”</span><span class="p">,</span><span class="w"> </span><span class="n">account_no</span><span class="p">,</span><span class="w"> </span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// EXEC SQL 语句后面直接接上SQL语句即可</span>

<span class="w">    </span><span class="c1">// 插入</span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">insert</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
<span class="w">        </span><span class="n">values</span><span class="w"> </span><span class="p">(</span><span class="o">:</span><span class="n">account_no</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">branch_name</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="n">balance</span><span class="p">);</span>
<span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">SQLCA</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">“</span><span class="n">Error</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w">       </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="err">“</span><span class="n">Success</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 删除</span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">delete</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">account</span><span class="w"> </span>
<span class="w">        </span><span class="n">where</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">:</span><span class="n">account_no</span><span class="p">;</span>
<span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">SQLCA</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">“</span><span class="n">Error</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w">       </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="err">“</span><span class="n">Success</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 更新</span>
<span class="w">    </span><span class="n">EXEC</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">account</span>
<span class="w">        </span><span class="n">set</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">:</span><span class="n">balance</span>
<span class="w">        </span><span class="n">where</span><span class="w"> </span><span class="n">account_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">:</span><span class="n">account_no</span><span class="p">;</span>
<span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">SQLCA</span><span class="p">.</span><span class="n">sqlcode</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="err">“</span><span class="n">Error</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w">       </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="err">“</span><span class="n">Success</span><span class="o">!</span><span class="err">\</span><span class="n">n</span><span class="err">”</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><code>SQLCA.sqlcode</code><strong>表达的是运行上述语句时是否发生错误，如果不为0则发生错误</strong></p>
<h2 id="52-procedural-constructs-in-sql">5.2 Procedural Constructs in SQL<a class="headerlink" href="#52-procedural-constructs-in-sql" title="Permanent link">&para;</a></h2>
<p>SQL provides a <strong>module</strong> language   </p>
<p>Permits definition of procedures in SQL, with <em>if-then-else</em> statements, <em>for</em> and <em>while</em> loops, etc.</p>
<p>允许在 SQL 中定义过程，包括 if-then-else 语句、for 和 while 循环等</p>
<p>Stored Procedures  </p>
<ul>
<li>
<p>Can store procedures in the database</p>
<p>将过程存储在数据库中</p>
</li>
<li>
<p>then execute them using the <em>call</em> statement</p>
<p><strong>使用 call 语句执行它们</strong></p>
</li>
<li>
<p>permit external applications to operate on the database without knowing about internal details</p>
<p>允许外部应用程序在不了解内部详细信息的情况下对数据库进行操作</p>
</li>
</ul>
<h3 id="521-sql-functions">5.2.1 SQL Functions<a class="headerlink" href="#521-sql-functions" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326648.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326648.png" width = 80%></a></p>
<p>dept_count的作用是：上传一个系的名字，返回该系的老师的数量</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326633.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326633.png" width = 80% /></a></p>
<p><strong>SQL 函数的返回值可以是一个 table.</strong> </p>
<h3 id="522-sql-procedures">5.2.2 SQL Procedures<a class="headerlink" href="#522-sql-procedures" title="Permanent link">&para;</a></h3>
<p>有输入参数(<code>in</code>)和输出参数(<code>out</code>)</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326625.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326625.png" width = 80%/></a></p>
<p>输入的是 dept_name, 输出的是d_count</p>
<p>调用过程使用<strong>call</strong></p>
<h3 id="523-procedural-constructs">5.2.3 Procedural Constructs<a class="headerlink" href="#523-procedural-constructs" title="Permanent link">&para;</a></h3>
<p>Compound statement: <code>begin ... end</code>, </p>
<ul>
<li>
<p>May contain multiple SQL statements between <code>begin</code> and <code>end</code>.</p>
<p>begin  end之间可以有多个SQL语句</p>
</li>
<li>
<p>Local variables can be declared within a compound statements</p>
<p>局部变量可以在复合语句中声明</p>
</li>
<li>
<p><strong><code>While</code></strong> and <strong><code>repeat</code></strong> statements<br />
<div class="highlight"><pre><span></span><code><span class="k">declare</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">while</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="k">end</span><span class="w"> </span><span class="n">while</span><span class="w">                           </span>
<span class="n">repeat</span>
<span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="err">–</span><span class="w"> </span><span class="mi">1</span>
<span class="k">until</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">end</span><span class="w"> </span><span class="n">repeat</span>
</code></pre></div></p>
<blockquote>
<p><strong>while 和 repeat能够达到相同的效果，一个条件在前，一个条件在后</strong></p>
</blockquote>
</li>
<li>
<p><strong><code>For</code></strong> loop
    Permits iteration over all results of a query</p>
<p>允许遍历查询的所有结果</p>
<p><div class="highlight"><pre><span></span><code><span class="k">declare</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="nb">integer</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="k">as</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">budget</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">department</span><span class="w"> </span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">‘</span><span class="n">Music</span><span class="err">’</span><span class="w"> </span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span>
<span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">budget</span><span class="w"> </span>
<span class="k">end</span><span class="w"> </span><span class="k">for</span>
</code></pre></div>
r 表示返回的每一行，对返回结果的每一行执行指令</p>
</li>
<li>
<p><code>条件判断语句</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span>
<span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<span class="n">elseif</span><span class="w"> </span><span class="nb">boolean</span><span class="w"> </span><span class="n">expression</span>
<span class="w">  </span><span class="k">then</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<span class="k">else</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">compound</span><span class="w"> </span><span class="k">statement</span>
<span class="k">end</span><span class="w"> </span><span class="k">if</span>
</code></pre></div>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326713.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326713.png" /></a></p>
<h3 id="524-external-language-functionsprocedures">5.2.4 External Language Functions/Procedures<a class="headerlink" href="#524-external-language-functionsprocedures" title="Permanent link">&para;</a></h3>
<p>SQL 可以访问由 C 语言定义的函数（过程）
    <div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">dept_count_proc</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="w">  </span><span class="k">count</span><span class="w"> </span><span class="nb">integer</span><span class="p">)</span>
<span class="k">language</span><span class="w"> </span><span class="k">C</span><span class="w"> </span>
<span class="k">external</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="err">’</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">avi</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dept_count_proc</span><span class="err">’</span><span class="w"> </span>


<span class="k">create</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">dept_count</span><span class="p">(</span><span class="n">dept_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">returns</span><span class="w"> </span><span class="nb">integer</span>
<span class="k">language</span><span class="w"> </span><span class="k">C</span>
<span class="k">external</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="err">‘</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">avi</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dept_count</span><span class="err">’</span>
</code></pre></div></p>
<p>缺点：</p>
<p>实现功能的代码可能需要加载到数据库系统中并在数据库系统的地址空间中执行。</p>
<ul>
<li>数据库结构意外损坏的风险</li>
<li>安全风险，允许用户访问未经授权的数据</li>
</ul>
<h2 id="53-triggers">5.3 Triggers<a class="headerlink" href="#53-triggers" title="Permanent link">&para;</a></h2>
<p>A <strong><code>trigger</code></strong> is a statement that is executed automatically by the system as a side effect of a modification to the database.  </p>
<p>A <code>trigger</code> 是系统自动执行的语句，作为修改数据库的副作用。</p>
<p>Trigger -  <strong>ECA rule</strong></p>
<ul>
<li><strong><em>E</em></strong>: Event （ insert, delete ，update）</li>
<li><strong><em>C</em></strong>: Condition  </li>
<li><strong><em>A</em></strong>: Action</li>
</ul>
<p>To design a trigger mechanism, we must:  设计触发机制</p>
<ul>
<li>
<p>Specify the conditions under which the trigger is to be executed.</p>
<p>指定执行触发器的条件</p>
</li>
<li>
<p>Specify the actions to be taken when the trigger executes.</p>
<p>指定触发器执行时要执行的操作。</p>
</li>
</ul>
<p>​    <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326599.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326599.png" width = 80%/></a> </p>
<p>定义了一个触发器，触发发生在我们对account表的balance属性做更新后。</p>
<p>如果存款金额超过200000元，或者取款金额超过50000元，那么就要<strong>在account_log表中插入一行数据，记录下这次存款/取款操作。</strong></p>
<blockquote>
<p><strong>for each row</strong>表示针对每一行发生的变化</p>
<p><strong>for each statement</strong> 表示针对每一条指令</p>
</blockquote>
<p>​    <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326619.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326619.png" width = 80%/></a></p>
<p>属性time_slot_id不是表time_slot的主键</p>
<p>我们不能利用属性time_slot_id创造一个从课程section表指向time_slot的表的外键</p>
<p>课程表中的time_slot_id又必须存在于表time_slot中，这属于<strong>参照完整性。</strong></p>
<p>我们可以利用触发器，在进行不符合参照完整性的操作发生后进行回退，从而维护这一点。</p>
<hr />
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251521317.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240325152122184" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251521317.png" /></a></p>
<p>如果旧的这一行的time_slot_id不能在表timeslot中找到，说明被删除的一个time_slot_id是最后的一个。如果此时并且旧的这一行的time_slot_id同时在课程表section中，那么就会引发参照完整性的问题。</p>
<p>因此，触发器在对表timeslot做删除操作后触发，如果出现了上述的情况，就会回退，不让这个删除操作发生。 </p>
<blockquote>
<p>等价于 on delete restrict，由于不是主键（外键），不能用on delete cascade / restrict/ default</p>
</blockquote>
<ul>
<li>
<p>Triggering event can be insert, delete or update</p>
</li>
<li>
<p>Triggers on update can be restricted to specific attributes<br />
<strong><em>e.g.</em></strong> after(before) update of  takes on grade</p>
</li>
<li>
<p>Values of attributes before and after an update can be referenced</p>
<p>可以引用更新前后的属性值</p>
<ul>
<li>
<p>referencing old row as:  for deletes and updates</p>
<p>将旧行引用为：用于删除和更新</p>
</li>
<li>
<p>referencing new row as: for inserts and updates</p>
<p>将新行引用为：用于插入和更新</p>
</li>
</ul>
</li>
</ul>
<p>​    <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326367.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251326367.png" width = 80%/></a></p>
<p>如果本来挂科，或者没有成绩，更新后不再挂科而且有成绩，就把学分加上去。</p>
<p>要慎用触发器，用在刀刃上，可能会引发连锁反应。</p>
<p>Instead of executing a separate action for each affected row, a single action can be executed for all rows affected by a transaction</p>
<ul>
<li>
<p>Use <strong><code>for each statement</code></strong>  instead of <strong><code>for each row</code></strong></p>
<p>假设是for each row，那么更新表account的每一行的balance值时，都会触发一次触发器，做相应的操作。</p>
<p>假设时for each statement，那么尽管一次update语句能够更新多行的balance值，但是执行这一个语句，触发器只会在语句执行完毕后触发一次</p>
</li>
<li>
<p>Use <strong><code>referencing old table</code></strong> or <strong><code>referencing new table</code></strong> to refer to temporary tables (called transition tables) containing the affected rows</p>
<p>如果使用for each statement，那么就没有old row与new row的概念了，而是old table与new table</p>
</li>
<li>
<p>Can be more efficient when dealing with SQL statements that update a large number of rows</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251534292.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240325153435160" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403251534292.png" /></a></p>
<p>每次对表takes的属性grade做更新后（不管更新了几条数据），如果有平均成绩小于六十分的教学班，那么就回退。这个触发器在执行完update语句后，触发一次。</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403311257682.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240331125715584" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202403311257682.png" /></a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy 2024 rescuerz
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.expand", "navigation.top", "search.highlight", "search.share", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../supports/js/xlink.js"></script>
      
        <script src="../../supports/js/katex.js"></script>
      
        <script src="https://jsd.cdn.zzko.cn/npm/katex@0.16.4/dist/katex.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>