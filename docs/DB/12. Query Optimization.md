---
counter: True  
---

# åäºŒ. Query Optimization

```
Abstract
    * Introduction 
    * Transformation of Relational Expressions
    * Statistical Information for Cost Estimation
    * Cost-based Optimization
    * Dynamic Programming for Choosing Evaluation Plans
    * Nested Subqueries
    * Materialized Views 
    * Advanced Topics in Query Optimization
```



## 12.1 Introduction

<div align=center> <img src="http://cdn.hobbitqia.cc/202305241431386.png" width = 60%/> </div>

Alternative ways of evaluating a given query

* Equivalent expressions  

  é€»è¾‘ä¼˜åŒ–ï¼š**å…³ç³»ä»£æ•°è¡¨è¾¾å¼ï¼ˆå°½é‡å…ˆåšé€‰æ‹©ï¼ŒæŠ•å½±ï¼‰`Transformation Base Optimization`**

* Different algorithms for each operation  

  ç‰©ç†å±‚é¢ï¼š**æ¯ä¸ªç®—å­é€‰æ‹©ä¸åŒçš„ç®—æ³• `Cost Based Optimization`**

    <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327156.png" width = 60%/> </div>
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271119807.png" width = 100%/> </div>

**Estimation of plan cost based on: è®¡åˆ’æˆæœ¬ä¼°ç®—**

* *`Statistical information about relations`*. Examples:
  number of tuples, number of distinct values for an attribute

  **æœ‰å…³å…³ç³»çš„ç»Ÿè®¡ä¿¡æ¯**ã€‚ç¤ºä¾‹ï¼šå…ƒç»„æ•°ã€å±æ€§çš„éé‡å¤å€¼æ•°

* *`Statistics estimation for intermediate results`*ï¼ˆCardinality Estimationï¼‰
  to compute cost of complex expressions  

  **ä¸­é—´ç»“æœçš„ç»Ÿè®¡ä¼°è®¡**ï¼ˆåŸºæ•°ä¼°è®¡ï¼‰ç”¨äºè®¡ç®—å¤æ‚è¡¨è¾¾å¼çš„æˆæœ¬

  ä¼°è®¡ä¸­é—´ç»“æœçš„å¤§å°  ç°åœ¨æœ‰åŸºäºæ·±åº¦å­¦ä¹ çš„ä¼°è®¡æ–¹æ³•

* *`Cost formulae for algorithms`*, computed using statistics

  **ç®—æ³•çš„æˆæœ¬å…¬å¼**ï¼Œä½¿ç”¨ç»Ÿè®¡æ•°æ®è®¡ç®—





å…³ç³»æ•°æ®åº“é‡Œå¯ä»¥ç”¨æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ã€‚ï¼ˆview query evaluation planï¼‰
<div align=center> <img src="http://cdn.hobbitqia.cc/202305271131380.png" width = 80%/> </div>

## 12.2 Generating Equivalent Expressions

Two relational algebra expressions are said to be **equivalent** if the two expressions generate the same set of tuples on every legal database instance  

**ç­‰ä»·å…³ç³»ä»£æ•°è¡¨è¾¾å¼**ï¼š

ä¸¤ä¸ªå…³ç³»ä»£æ•°è¡¨è¾¾å¼ç­‰ä»·æ˜¯æŒ‡ï¼šå½¢å¼ä¸åŒï¼Œä½†äº§ç”Ÿçš„OUTPUTæ˜¯å®Œå…¨ç›¸åŒçš„ã€‚  

### 12.2.1 Equivalence Rules

> **An equivalence rule says that expressions of two forms are equivalent**
>
> **ç­‰ä»·è§„åˆ™è¡¨ç¤ºä¸¤ç§å½¢å¼çš„è¡¨è¾¾å¼æ˜¯ç­‰ä»·çš„**
>
> **Can replace expression of first form by second, or vice versa**
>
> **å¯ä»¥ç”¨ç¬¬äºŒç§å½¢å¼æ›¿æ¢ç¬¬ä¸€ç§å½¢å¼çš„è¡¨è¾¾ï¼Œåä¹‹äº¦ç„¶**

* selection
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271134503.png" width = 80%/> </div>

    1. å¯ä»¥æŠŠç®—å­æ‹†åˆ†  
    
       **å¦‚æœæŸäº›å±æ€§æœ‰ç´¢å¼•**ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆæ‹†åˆ†ï¼Œåœ¨ç´¢å¼• select ä¹‹åå†æ‰§è¡Œå…¶ä»–ç®—å­.
    
       **å¦‚æœæœ‰å¤åˆç´¢å¼•ï¼Œå¯ä»¥é€†å‘è¿›è¡Œ**
    
    2. ç®—å­å¯äº¤æ¢  å…ˆæ‰§è¡Œæœ‰ç´¢å¼•çš„ç®—å­ã€‚  
    
    3. æŠ•å½±çš„å±æ€§å¯ä»¥åªä¿ç•™æœ€åä¸€æ¬¡çš„  
    
    4. é€‰æ‹©ç®—å­å¯ä»¥å’Œï¼ˆç¬›å¡å°”ç§¯å’Œè¿æ¥ï¼‰ç»“åˆ  
    
* join  
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271145166.png" width = 100%/> </div>
    
    > **`è‡ªç„¶è¿æ¥æ˜¯ç»“åˆçš„ï¼ˆå…ˆè¿æ¥ä¸­é—´ç»“æœå°çš„ï¼‰`**  
    
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271200739.png" width = 100%/> </div>
    
    > **`å¦‚æœé€‰æ‹©ç®—å­åªå’Œä¸€ä¸ªå…³ç³»æœ‰å…³ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆæ‰§è¡Œé€‰æ‹©ã€‚ï¼ˆé€‰æ‹©ç®—å­è¦æ—©è¿›è¡Œï¼Œæ¨åˆ°å¶å­ä¸Šï¼‰`**  
    
* projection
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271202229.png" width = 100%/> </div>

    > **è¿™ä½“ç°çš„æ˜¯ï¼šæŠ•å½±è¿ç®—ä¹Ÿåº”è¯¥å°½é‡å…ˆåšã€‚æŠ•å½±è¿ç®—ä¸é€‰æ‹©è¿ç®—éƒ½èƒ½é™ä½ç»“æœçš„è§„æ¨¡ã€‚** 
    
    - å…ˆåšæŠ•å½±å†è¿›è¡Œè¿æ¥ï¼ˆ**æœ‰å‰ææ¡ä»¶ï¼Œ$\theta$ä¸èƒ½æ¶‰åŠåˆ°L1å’ŒL2ä¹‹å¤–çš„å±æ€§**ï¼‰ã€‚
    
    - **å¦‚æœè¿æ¥è¦ç”¨åˆ°æŠ•å½±åä¸ä¿ç•™çš„å±æ€§ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡æŠ•å½±æ—¶è¦æŠŠè¿æ¥ç”¨çš„å±æ€§ä¹Ÿä¿ç•™ä¸‹æ¥ã€‚**
    
* set operation
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271205746.png" width = 100%/> </div>
    
    **é’ˆå¯¹é›†åˆçš„é€‰æ‹©æ“ä½œæ˜¯å¯åˆ†é…çš„**
    $$
    \sigma_\theta(E1- E2) = \sigma_\theta(E1) - \sigma_\theta(E2)\\
    \sigma_\theta(E1 \cap E2) = \sigma_\theta(E1) \cap \sigma_\theta(E2)\\
    \sigma_\theta(E1 \cup  E2) = \sigma_\theta(E1) \cup \sigma_\theta(E2)\\
    $$
    å¯¹äºå‡æ³•ï¼š$E1-E2$è¡¨ç¤ºE1æœ‰ä½†æ˜¯E2æ²¡æœ‰çš„éƒ¨åˆ†ï¼Œç„¶åå†å¯¹è¿™ä¸€éƒ¨åˆ†è¿›è¡Œ$\theta$æ¡ä»¶çš„é€‰æ‹©ï¼Œå¾—åˆ°ç»“æœã€‚å‡è®¾E1å’ŒE2å­˜åœ¨åŒæ—¶æ»¡è¶³$\theta$æ¡ä»¶çš„å…ƒç´ ï¼Œåœ¨å·¦è¾¹æ˜¾ç„¶E1-E2å°±å·²ç»åˆ é™¤è¯¥å…ƒç´ ï¼Œå³è¾¹åŒç†ï¼Œå…±æœ‰å…ƒç´ åˆ é™¤ã€‚
    $$
    \sigma_\theta(E1- E2) = \sigma_\theta(E1) - E2 \\
    \sigma_\theta(E1 \cap E2) = \sigma_\theta(E1) \cap E2 \\
    \sigma_\theta(E1 \cup E2) != \sigma_\theta(E1) \cup E2\\
    $$
    **`æ³¨æ„æ­¤å¤„çš„å‡æ³•å·®é›†ï¼Œå¯ä»¥ç†è§£ä¸ºæ”¾ç¼©ä¸ºæ¡ä»¶æ›´å¼ºçš„å¼å­ï¼Œ`$\sigma_\theta(E1)$æœ‰ä½†æ˜¯E2æ²¡æœ‰çš„å…ƒç´ ä¸€å®šå±äº$\sigma_\theta(E1)$æœ‰ï¼Œ$\sigma_\theta(E2)$æ²¡æœ‰çš„é›†åˆ**
    
    **é›†åˆçš„å¹¶å¯¹æŠ•å½±æ“ä½œå¯åˆ†é…**
    
* other
    <div align=center> <img src="http://cdn.hobbitqia.cc/202305271209973.png" width = 100%/> </div>
    
    **åˆ†ç»„æ“ä½œå’Œé€‰æ‹©æ“ä½œå¯äº¤æ¢**
    
    **å…¨è¿æ¥çš„æ“ä½œçš„å¯äº¤æ¢æ€§**
    
    **é€‰æ‹©æ“ä½œå¯¹å·¦å³å¤–éƒ¨è¿æ¥å¯åˆ†é…**

### 12.2.2 Enumeration of Equivalent Expressions

* Repeat
    * apply all applicable *equivalence rules* on every subexpression of every equivalent expression found so far
    
      å¯¹ç›®å‰æ‰¾åˆ°çš„æ¯ä¸ªç­‰ä»·è¡¨è¾¾å¼çš„æ¯ä¸ªå­è¡¨è¾¾å¼åº”ç”¨æ‰€æœ‰é€‚ç”¨çš„â€œç­‰ä»·è§„åˆ™â€
    
    * add newly generated expressions to the set of equivalent expressions 
    
      å°†æ–°ç”Ÿæˆçš„è¡¨è¾¾å¼æ·»åŠ åˆ°ç­‰æ•ˆè¡¨è¾¾å¼é›†ä¸­
    
* Until no new equivalent expressions are generated above

å¯ä»¥è¿™æ ·æ‰¾åˆ°æ‰€æœ‰çš„ç­‰ä»·è¡¨è¾¾å¼ã€‚

ä½†æ˜¯å®é™…ä¸­æˆ‘ä»¬åŸºäºä¸€äº›ç»éªŒè§„åˆ™è¿›è¡Œå¯å‘å¼çš„ä¼˜åŒ–

![image-20240516094442590](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405160944683.png)

- å‡å°‘ç©ºé—´éœ€æ±‚ï¼šå…±äº«ç›¸åŒçš„å­è¡¨è¾¾å¼

  ä¾‹å¦‚ï¼šè¿æ¥çš„äº¤æ¢å¾‹

- å‡å°‘æ—¶é—´éœ€æ±‚ï¼šä½¿ç”¨åŠ¨æ€è§„åˆ’

  æ¯ä¸€æ¬¡åªè€ƒè™‘æœ€ä¼˜å­åºåˆ—çš„ç»„åˆï¼ˆé•¿åºåˆ—åˆ†ä¸ºä¸¤ä¸ªå­åºåˆ—ï¼‰

## 12.3 Statistics for Cost Estimation

ä»£ä»·ä¼°ç®—éœ€è¦ç»Ÿè®¡ä¿¡æ¯

* $n_r$: number of tuples in a relation r. 

  å…³ç³» r ä¸­çš„å…ƒç»„æ•°

* $b_r$: number of blocks containing tuples of r. 

  å…³ç³»rçš„blockå—æ•°

* $l_r$: size of a tuple of r. 

  å…³ç³»rä¸€ä¸ªå…ƒç»„çš„å¤§å°

* $f_r$: blocking factor of r â€” i.e., the number of tuples of r that fit into one block.  

  ä¸€ä¸ªå—å¯ä»¥æ”¾å¤šå°‘ä¸ªå…ƒç»„

* $V(A, r)$: number of *distinct* values that appear in r for attribute A; same as the size of $\Pi(r)$.

  å…³ç³» r ä¸­æŸä¸ªå±æ€§Aä¸åŒçš„å€¼çš„ä¸ªæ•°ã€‚**è¿™ä¹Ÿç­‰ä»·äºå¯¹å…³ç³»rä¸­å±æ€§Aè¿›è¡ŒæŠ•å½±ï¼Œå¾—åˆ°çš„ç»“æœé›†åˆå¤§å°ã€‚**

* If tuples of r are **stored together physicallyï¼ˆ`å­˜æ”¾æ˜¯è¿ç»­çš„`ï¼‰** in a file, then: $b_r = \lceil \dfrac{n_r}{f_r}\rceil$

* Histograms

> **Example "attribute age of relation person"**

**Equi-Width**  **Equi-Depth**

<div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327208.png" width = 60%/> </div>

**ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºä¸€ä¸ªå…³ç³» r ä¸­çš„å±æ€§Aï¼Œå®ƒåˆV(A,r)ä¸ªä¸åŒçš„å€¼ï¼Œå¸Œæœ›èƒ½ç”¨ç›´æ–¹å›¾è¡¨ç¤ºè¿™äº›ä¸åŒçš„å€¼åˆ†åˆ«æœ‰å¤šå°‘ä¸ªå…ƒç»„ã€‚è¿™æ ·æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®æŸ¥è¯¢çš„èŒƒå›´ï¼Œèƒ½å¤ŸçŸ¥é“æŸ¥è¯¢çš„ç»“æœçš„è§„æ¨¡æœ‰å¤šå¤§ã€‚**

ä½†æ˜¯æˆ‘ä»¬**å¾€å¾€æ²¡æœ‰ç›´æ–¹å›¾**ï¼Œå¯¹äºæ¯ä¸€ä¸ªä¸åŒçš„å€¼ï¼Œé‡‡å–**å¹³å‡åˆ†é…çš„ä¼°è®¡æ–¹å¼**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªå€¼ï¼Œ**ä¼°è®¡è¡¨ä¸­å­˜åœ¨$n_r/V(A,r)$ä¸ªå…ƒç»„å¯¹åº”**

### 12.3.1 Selection Size Estimation

ä¸­é—´ç»“æœ

* $\sigma_{A=v}(r)$  

  $n_r / V(A,r)$ : number of records that will satisfy the selection.   

  **è¿™æ ·çš„ä¼°ç®—åŸºäºå€¼æ˜¯å¹³å‡åˆ†å¸ƒçš„**  

  - **è‹¥é€‰æ‹©çš„è¿™ä¸ªå±æ€§Açš„è¿™ä¸ªå€¼vä¸æ˜¯keyï¼Œé‚£ä¹ˆå°±ç”¨æ€»å…ƒç»„æ•°é™¤ä»¥è¿™ä¸ªå±æ€§çš„ä¸åŒå€¼çš„ä¸ªæ•°è¿›è¡Œä¼°è®¡ï¼›**

  - **å¦‚æœé€‰æ‹©çš„è¿™ä¸ªå±æ€§Aæ˜¯keyï¼Œé‚£ä¹ˆä¼°ç®—ä¸º1ã€‚**

* $\sigma_{A\leq v}(r)$   
    * Let $c$ denote the estimated number of tuples satisfying the condition.   
    
    * $c = 0$ if $v < \min(A,r)$  
    
    * $c = n_r\cdot \dfrac{v-\min(A,r)}{\max(A,r) - \min (A,r)}$ recordæ€»æ•° * æ¯”ä¾‹  
    
    * In absence of statistical information c is assumed to be $n_r / 2$(
    
      **å‡å¦‚æ•°æ®åº“æ²¡æœ‰ç»´æŠ¤maxæˆ–è€…minè¿™äº›ä¿¡æ¯ï¼Œåªèƒ½å°†æ‰€æœ‰çš„å°äºç­‰äºæ“ä½œæˆ–è€…å¤§äºç­‰äºæ“ä½œå¾—åˆ°çš„ç»“æœï¼Œä¼°ç®—ä¸º$n_r/2$äº†ã€‚**

<div align=center> <img src="http://cdn.hobbitqia.cc/202305272301381.png" width = 80%/> </div>

**æ³¨æ„æ­¤å¤„çš„ORè¿ç®—(æå–)ï¼Œè½¬åŒ–ä¸ºANDæ“ä½œï¼ˆåˆå–ï¼‰ï¼Œè¦æ±‚å„æ¡ä»¶ç‹¬ç«‹äº’ä¸å¹²æ‰°ã€‚**

**è‡³å°‘æ»¡è¶³ä¸€ä¸ªæ¡ä»¶è½¬åŒ–ä¸ºä¸€ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³**
$$
\theta_1 \ or  \ \theta_2 = \neg((\neg \theta_1) and (\neg \theta_2))
$$

### 12.3.2 **Estimation of the Size of Joins**

**The Cartesian product $r  \times s$ contains $n_r\cdot n_s$ tuples; each tuple occupies $s_r + s_s$ bytes.**

* $R \cap S = \emptyset$  

  æ²¡æœ‰å…¬å…±å±æ€§ï¼Œè‡ªç„¶è¿æ¥$r \bowtie s$ç­‰ä»·äº $r\times s$

* $R \cap S$ is a **`key`** for $R$, then a tuple of $s$ will join with at most one tuple from $r$
  
    **(`the number of tuples in` $r \bowtie s) \leq n_s$**  
    
    **ä»å…³ç³»Sçš„è§’åº¦è¿›è¡Œç†è§£ï¼Œè¿æ¥ç”¨çš„å±æ€§ä¸ºRçš„keyï¼Œæ˜¾ç„¶è¯¥å±æ€§ä¸åŒçš„å€¼åœ¨å…³ç³»Rä¸­ä»…èƒ½å‡ºç°ä¸€æ¬¡ï¼Œåˆå› ä¸ºè¯¥å±æ€§ä¸ä¸€å®šæ˜¯Sçš„keyï¼Œæ‰€ä»¥Sä¸­ä¼šå‡ºç°å¤šä¸ªç›¸åŒçš„å€¼ï¼Œä»è€Œå¯¼è‡´è¿æ¥ä¹‹åçš„å…ƒç»„ä¸ªæ•°$\leq n_s$**
  
    <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327222.png" width = 80%/> </div>
  
* If $R \cap S$ in S is a **`foreign key`** in S referencing R, **then the number of tuples in $r\bowtie s$ = `the number of tuples in` s.**

    **foreignå…³ç³»ï¼Œ a foreign key in S referencing Rï¼Œè¯´æ˜è¿æ¥ç”¨çš„å±æ€§ä¸ä»…æ˜¯Rçš„keyï¼ŒåŒæ—¶ä»»ä½•å‡ºç°åœ¨Sä¸­è¯¥å±æ€§çš„å€¼éƒ½å‡ºç°åœ¨Rä¸­ï¼Œæ‰€ä»¥è¿æ¥ä¹‹åçš„å…ƒç»„æ•°é‡ä¸º$n_s$**

* If $R \cap S = \{A\}$ is not a key for R or S.  
  
  > **`å‡å¦‚è¿æ¥çš„å±æ€§ä¸æ˜¯æŸä¸€ä¸ªè¡¨çš„key`**
  
  $n_r * \dfrac{n_s}{V(A,s)}, n_s * \dfrac{n_r}{V(A,r)}$.   
  
  ä»¥ç¬¬äºŒä¸ªä¸ºä¾‹å­ï¼Œç«™åœ¨ s çš„è§’åº¦ï¼Œ$\dfrac{n_r}{V(A,r)}$è¡¨ç¤ºå…³ç³» r ä¸­å±æ€§Açš„æ¯ä¸€ä¸ªå€¼å¯¹åº”æœ‰å¤šå°‘å„è®°å½•ï¼Œæ¯ä¸€ä¸ª s å¯ä»¥å’Œå±æ€§Aä¸­æ¯ä¸€ä¸ªvalueå¯¹åº”çš„è®°å½•çš„å¹³å‡å€¼è¿æ¥ã€‚  
  
  **å› ä¸ºæœ‰æ—¶å€™å…³ç³»rä¸­çš„ä¸€ä¸ªå…ƒç»„å¯¹åº”å±æ€§å€¼åœ¨sä¸­æ²¡æœ‰å‡ºç°ï¼Œå°±ä¼šå¯¼è‡´è¿æ¥ä¸ä¸Šçš„æƒ…å†µï¼Œä¼šå¯¼è‡´`ä¼°ç®—ç»“æœåå¤§`ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬å–äºŒè€…ä¸­çš„è¾ƒå°å€¼ã€‚**  
  
    <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327267.png" width = 80%/> </div>
  
  ![image-20240515231853077](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152318146.png)
  
  > **`æ­¤å¤„V(ID,takes) = 2500ï¼Œ è¡¨ç¤ºåœ¨takeå…³ç³»ä¸­IDä¸åŒçš„valueå€¼çš„æ•°é‡ä¸º2500ï¼ŒåŒæ—¶takeså…³ç³»è¡¨ä¸­ä¸€å…±æœ‰10000ä¸ªå…ƒç»„ï¼Œè¯´æ˜ä¸Šè¯¾çš„åŒå­¦ä¸­å¹³å‡æ¯ä¸ªåŒå­¦ä¸Šå››é—¨è¯¾`**
  >
  > **`IDæ˜¯studentå…³ç³»ä¸­çš„primary keyï¼Œæ‰€ä»¥studentå…³ç³»è¡¨ä¸­æœ‰å¤šå°‘å…ƒç»„ï¼ŒIDçš„valueæ•°é‡å°±æœ‰å¤šå°‘ã€‚å› æ­¤V(ID,student) = n_student = 5000`**
  
  ![image-20240515232058264](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152320307.png)

### 12.2.3 Size Estimation for Other Operations

1. æŠ•å½±ï¼šestimated size of $\prod_A(r) = V(A,r)$

2. åˆ†ç»„ï¼š**`åœ¨é€‰å®šåˆ†ç»„çš„åŸºç¡€ä¸Šæ‰§è¡Œèšåˆå‡½æ•°ï¼Œæ˜¾ç„¶èšåˆå‡½æ•°æ ¹æ®è¾“å…¥çš„å€¼åªèƒ½å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œæ‰€ä»¥æœ€ä¼˜å…ƒç»„çš„æ•°é‡ä¸ºå±æ€§Aä¸­valueçš„æ•°é‡`**

   <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152100620.png" style="zoom: 67%;" />

3. å¯¹é›†åˆå¤§å°ä¸Šä¸‹é™çš„ä¼°ç®—

   **è™½ç„¶ä¸å¤Ÿç²¾ç¡®ï¼Œä½†æ˜¯æä¾›äº†ä¸Šç•Œã€‚å¯¹äº - æ“ä½œï¼Œr - s è¡¨ç¤ºé€‰å–çš„æ˜¯ r æœ‰ä½†æ˜¯ s æ²¡æœ‰çš„valueï¼Œæ˜¾ç„¶æœ€å¤§çš„size ä¸ºr**

<div align=center> <img src="http://cdn.hobbitqia.cc/202305272344670.png" width = 80%/> </div>

4. å¯¹äºå¤–éƒ¨è‡ªç„¶è¿æ¥çš„ä»£ä»·ä¼°ç®—

   ![image-20240515210506125](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152105154.png)

   > **å¤–éƒ¨è¿æ¥æ¯”è‡ªç„¶è¿æ¥å¤šå‡ºçš„æ˜¯ï¼šå‡å¦‚æ˜¯å·¦å¤–éƒ¨è¿æ¥ï¼Œé‚£ä¹ˆå·¦è¾¹çš„å…³ç³»æ²¡æœ‰è¿æ¥ä¸Šçš„éƒ¨åˆ†ï¼Œä¹Ÿè¦æ”¾å…¥åˆ°ç»“æœé›†åˆä¸­ã€‚å› æ­¤ç»“æœé›†åˆçš„ä¸Šé™ä¼°ç®—ï¼Œå°±å†åŠ ä¸Šrçš„å…ƒç»„ä¸ªæ•°ã€‚**

### 12.2.4 Estimation of Number of Distinct Values

å¯¹äºä¸­é—´ç»“æœï¼Œåœ¨æŸä¸ªå±æ€§ä¸Šä¸åŒå€¼çš„ä¸ªæ•°

> **ä¾‹å¦‚ï¼Œä¼°ç®—ä¸‹é¢è¿™ä¸ªé€‰æ‹©æ“ä½œä¸­é—´ç»“æœåœ¨Aå±æ€§ä¸Šä¸åŒå€¼çš„ä¸ªæ•°ï¼š**

Selections $\sigma_\theta(r)$, estimate $V(A,\sigma_\theta(r))$ ****

* If $\theta$ forces A to take **`a specified value`**, $V(A,\sigma_\theta(r))=1$  

  ***e.g.***, A = 3

* If $\theta$ forces A to take on one of **`a specified set of values`**: $V(A,\sigma_\theta(r))=$ number of specified values  

  ***e.g.***, (A = 1 V A = 3 V A = 4)

* If the selection condition $\theta$ is of the form A op v, $V(A,\sigma_\theta(r))=V(A,r)*s$  

  åˆ©ç”¨é€‰æ‹©ç‡ s è®¡ç®—

* In all the other cases, use approx1imate estimate: $V(A,\sigma_\theta(r))=\min(V(A,r), n_{\sigma_\theta(r)})$

  **åŸæ¥æœªç­›é€‰çš„è¡¨åœ¨Aå±æ€§ä¸Šä¸åŒå€¼çš„ä¸ªæ•°ï¼Œå’Œé€‰æ‹©å‡ºæ¥çš„ç»“æœæ¡ç›®çš„ä¸ªæ•°å–æœ€å°å€¼ã€‚**

> **ä¼°ç®—ä¸‹é¢è¿™ä¸ªè¿æ¥æ“ä½œä¸­é—´ç»“æœåœ¨Aå±æ€§ï¼ˆå¯èƒ½æ˜¯ç»„åˆå±æ€§ï¼‰ä¸Šä¸åŒå€¼çš„ä¸ªæ•°ï¼š**

joins $r\bowtie s$, estimate $V(A,r\bowtie s)$

* If all attributes in A are from r, the estimated $V(A,r\bowtie s)=\min(V(A,r), n_{r\bowtie s})$

* If A contains attributes A1 from r and A2 from s, then estimated 

  **è‹¥Aå±æ€§ä¸­åŒ…æ‹¬å±äºrçš„å±æ€§é›†åˆA1ï¼Œä¸å±äºsçš„å±æ€§é›†åˆA2ï¼š**

  $V(A,r\bowtie s)=\min(V(A1,r)*V(A2-A1,s), V(A1-A2,r)*V(A2,s), n_{r\bowtie s})$

![image-20240516100206594](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405161002635.png)

## 12.4 Choice of Evaluation Plans

Must consider the *interaction* of evaluation techniques when choosing evaluation plans

choosing the cheapest algorithm for each operation independently may not yield best overall algorithm    

ä¸ºæ¯ä¸ªæ“ä½œå•ç‹¬é€‰æ‹©æœ€ä¾¿å®œçš„ç®—æ³•å¯èƒ½ä¸ä¼šäº§ç”Ÿæœ€ä½³çš„æ•´ä½“ç®—æ³•

> ***e.g.*** merge-join may be costlier than hash-join, but may provide a sorted output which reduces the cost for an outer level aggregation.  
>
> Mergejoin ä»£ä»·é«˜ï¼Œä½†æ˜¯æœ‰ä¸ªå¥½å¤„æ˜¯ join åæ˜¯æœ‰æ¬¡åºçš„ï¼Œå¯¹ä¸Šå±‚æ“ä½œæœ‰åˆ©ã€‚
>
> nested-loop join may provide opportunity for pipelining

å¦‚æœè¦æ‰¾æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚é€šå¸¸æŒ‰ç…§ç»éªŒè§„åˆ™ã€‚  

**æˆ‘ä»¬ä¸»è¦è€ƒè™‘è¿æ¥æ“ä½œçš„ä¼˜åŒ–ã€‚**

### 12.4.1 Cost-Based Join-Order Selection

#### 12.4.1.1 Dynamic Programming

Consider finding the best join-order for $r_1\bowtie    r_2\bowtie  \ldots r_n$.  

There are $(2(n â€“ 1))!/(n â€“ 1)!$ different join orders for above expression.

> <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327235.png" width = 80%/> </div>
>
> **é€šè¿‡åŠ¨æ€è§„åˆ’çš„æ–¹å¼è¿›è¡Œè¿æ¥ã€‚æ¯”å¦‚è¦è¿æ¥äº”ä¸ªè¡¨ï¼Œç¡®å®šè¦å…ˆè¿æ¥å‰ä¸‰ä¸ªè¡¨ã€‚åœ¨å‰ä¸‰ä¸ªè¡¨ä¸­é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆï¼ˆ12é€‰1ï¼‰å¾—åˆ°ç»“æœè¡¨ï¼Œç„¶åæŠŠå‰©ä¸‹r4ï¼Œr5å’Œç»“æœè¡¨ç»„åˆåœ¨ä¸€èµ·ï¼Œå†é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆï¼ˆ12é€‰ä¸€ï¼‰è¿›è¡Œè¿æ¥ã€‚ä¸€å…±åªæœ‰24ä¸­é€‰æ‹©**

**Using dynamic programming, the least-cost join order for any subset of $\{r_1, r_2, \ldots r_n\}$ is computed only once and stored for future use.** 

**ä½¿ç”¨åŠ¨æ€è§„åˆ’ï¼Œä»»ä½•å­é›† $\{ğ‘Ÿ1,ğ‘Ÿ2,â€¦ğ‘Ÿğ‘›\} $çš„æœ€ä½æˆæœ¬è¿æ¥é¡ºåºä»…è®¡ç®—ä¸€æ¬¡å¹¶å­˜å‚¨ä»¥å¤‡å°†æ¥ä½¿ç”¨ã€‚**

> **`Join Order Optimization Algorithm`**

<div align=center> <img src="http://cdn.hobbitqia.cc/202305281658817.png" width = 80%/> </div>

å…ˆåˆ†è§£æˆä¸¤ä¸ªå°çš„é›†åˆ $S_1, S-S_1$. é€’å½’åœ°ç»†åˆ†ã€‚  

é€’å½’åˆ°æœ€åº•å±‚å°±å˜ä¸ºäº†å¯¹å•ä¸ªè¡¨çš„é€‰æ‹©æ–¹æ³•ã€‚

<div align=center> <img src="http://cdn.hobbitqia.cc/202305281700752.png" width = 80%/> </div>

**`æ¯æ¬¡å°†è¦è¿æ¥çš„è¡¨åˆ†ä¸ºä¸¤ä¸ªå­åºåˆ—ï¼Œåˆ©ç”¨åŠ¨æ€è§„åˆ’ï¼Œæ‰€æœ‰åºåˆ—é•¿åº¦å°äºå½“å‰åºåˆ—çš„é›†åˆæœ€ä½³æ’åˆ—æ–¹å¼å’Œcostéƒ½å·²çŸ¥ï¼Œä¸”ä¿ç•™ä¸‹æ¥ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¸æ–­é€šè¿‡å˜åŒ–ä¸¤ä¸ªå­åºåˆ—çš„é•¿åº¦ï¼Œè®¡ç®—å‡ºå½“å‰åºåˆ—æœ€ä½³çš„æ’åˆ—æ–¹å¼å’Œcost`**

æ—¶é—´å¤æ‚åº¦ä¸º$O(3^n)$ï¼Œç©ºé—´å¤æ‚åº¦ä¸º$O(2^n)$

#### 12.4.1.2 Left Deep Join Trees

In left-deep join trees, the right-hand-side input for each join is a relation, not the result of an intermediate join.

åœ¨å·¦æ·±è¿æ¥æ ‘ä¸­ï¼Œæ¯ä¸ªè¿æ¥çš„å³ä¾§è¾“å…¥æ˜¯ä¸€ä¸ªå…³ç³»ï¼Œè€Œä¸æ˜¯ä¸­é—´è¿æ¥çš„ç»“æœã€‚

<div align=center> <img src="http://cdn.hobbitqia.cc/202305281703232.png" width = 60%/> </div>

å·¦è¾¹å¯ä»¥æ˜¯ä¸­é—´ç»“æœï¼Œå³è¾¹å¿…é¡»æ˜¯ä¸€ä¸ªå…³ç³»ã€‚

**æ„å»ºå·¦æ·±è¿æ¥æ ‘ï¼Œå¯¹æœ€åˆå§‹çš„è¿æ¥åºåˆ—Sï¼Œæ¯æ¬¡é€‰å–æœ€åä¸€ä¸ªå…³ç³»ï¼Œå°†Såˆ†ä¸ºS-rå’Œrï¼Œè€Œä¸æ˜¯å¯¹äºSçš„ä»»æ„ä¸€ä¸ªéç©ºå­é›†è¿›è¡Œåˆ†å‰²ã€‚**

#### 12.4.1.3 Cost of Optimization

* With dynamic programming 
    * time complexity of optimization with bushy trees is $O(3^n)$.  
    * Space complexity is $O(2^n)$ 
* left-deep join tree 
    * Time complexity of finding best join order is $O(n 2^n)$
    * Space complexity remains at $O(2^n)$ 

### 12.4.2 Heuristic Optimization

**Cost-based optimization is expensive.   å¯ä»¥ç”¨å¯å‘å¼ä¼˜åŒ–**

**`Heuristic optimization`** transforms the query-tree by using a set of rules that typically (but not in all cases) improve execution performance:

å¯å‘å¼ä¼˜åŒ–é€šè¿‡ä½¿ç”¨ä¸€ç»„è§„åˆ™æ¥è½¬æ¢æŸ¥è¯¢æ ‘ï¼Œè¿™äº›è§„åˆ™é€šå¸¸ï¼ˆä½†ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼‰éƒ½ä¼šæé«˜æ‰§è¡Œæ€§èƒ½ï¼š

* Perform *selection* early (reduces the number of tuples)

  **å°½æ—©è¿›è¡Œé€‰æ‹©æ“ä½œã€‚**ï¼ˆå‡å°‘ä¸­é—´ç»“æœå…ƒç»„ä¸ªæ•°ï¼‰

* Perform *projection* early (reduces the number of attributes)

  **å°½æ—©è¿›è¡ŒæŠ•å½±æ“ä½œã€‚**ï¼ˆå‡å°‘ä¸­é—´ç»“æœå±æ€§ä¸ªæ•°ï¼‰

* Perform most restrictive selection and join operations (**i.e**. with smallest result size) before other similar operations.

  åœ¨å…¶ä»–ç±»ä¼¼æ“ä½œä¹‹å‰æ‰§è¡Œ**é™åˆ¶æ€§æœ€å¼ºçš„`é€‰æ‹©ï¼ˆselectï¼‰`å’Œ`è¿æ¥ï¼ˆjoinï¼‰`æ“ä½œ**ï¼ˆå‡å°‘ä¸­é—´ç»“æœè§„æ¨¡ï¼‰ã€‚

* Perform left-deep join order

  **åˆ©ç”¨å·¦æ·±è¿æ¥æ ‘è¿›è¡Œè¿æ¥ã€‚å³åœ¨ä¸ºè¿æ¥æ“ä½œåºåˆ—é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆçš„æ—¶å€™ï¼Œæ¯æ¬¡å°†åºåˆ—Såˆ†ä¸ºS-rä¸rï¼Œå¯¹è¿™ä¸¤ä¸ªè¡¨é€‰æ‹©æœ€ä¼˜è¿æ¥æ–¹æ¡ˆã€‚**(å‡å°‘æ—¶é—´å¤æ‚åº¦)

## 12.5 Additional Optimization Techniques

### 12.5.1 Nested Subqueries

> **ä¼˜åŒ–åµŒå¥—æŸ¥è¯¢**
>
> ![image-20240515212449543](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152124575.png)

``` SQL
select name 
from instructor 
where exists 
    (select * 
     from teaches
     where instructor.ID = teaches.ID and teaches.year = 2022)
```
**å¯¹äºæ¯ä¸€ä¸ªæ•™å¸ˆï¼ŒæŠŠæ•™å¸ˆçš„IDåœ¨teachesè¡¨ä¸­è¿›è¡Œå¾ªç¯ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ¡ä»¶æ»¡è¶³çš„è®°å½•ã€‚**

è¿™ç›¸å½“äºä¸€ä¸ª**ä¸¤é‡å¾ªç¯ã€‚**å¤–å¾ªç¯æ˜¯instructorè¡¨ï¼Œå†…å¾ªç¯æ˜¯teachesè¡¨ï¼Œæ•ˆç‡è¾ƒä½ã€‚

> `Parameters are variables from outer level query that are used in the  nested subquery; such variables are called` **correlation variablesï¼ˆç›¸å…³å˜é‡ï¼‰**  

**å‡å¦‚è¯´åµŒå¥—æŸ¥è¯¢ï¼Œæ²¡æœ‰å‡ºç°åœ¨å¤–é¢çš„è¡¨ä¸­çš„æŸä¸ªå±æ€§ï¼Œä¾‹å¦‚æ­¤å¤„çš„instructor.IDï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€å…ˆæŠŠé‡Œé¢year = 2022çš„æŸ¥è¯¢å¥½ï¼Œå†ä¸å¤–é¢çš„è¡¨è¿æ¥å³å¯**

**å³æ¥è‡ªå¤–å¾ªç¯çš„å˜é‡ã€‚å¦‚æœæ²¡æœ‰ç›¸å…³å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ‰§è¡Œå†…éƒ¨ï¼Œç„¶åå†æ‰§è¡Œå¤–éƒ¨ã€‚**

> **ä¼˜åŒ–æ–¹æ³•1ï¼šåµŒå¥—æŸ¥è¯¢æ”¹å˜ä¸ºè¿æ¥**
>
> ```
> select  name
> from   instructor, teaches
> where instructor.ID = teaches.ID and teaches.year = 2022
> ```
>
> **æŠŠåˆšåˆšé‚£ä¸ªä¾‹å­æ”¹ä¸ºä¸€ä¸ª select è¯­å¥ï¼Œé‚£ä¹ˆä¸€ä¸ªè€å¸ˆå¦‚æœå¼€äº†å¾ˆå¤šé—¨è¯¾å°±ä¼šå‡ºç°å¾ˆå¤šä¸ªåå­—ã€‚ä½†æ˜¯åŠ ä¸Š `distinct` å…³é”®è¯ååˆæ— æ³•åŒºåˆ†åŒåæƒ…å†µã€‚**

> **`æœ€ç»ˆæˆ‘ä»¬ä½¿ç”¨åŠè¿æ¥ï¼ˆsemijoinï¼‰è¿›è¡Œä¼˜åŒ–ã€‚åŠè¿æ¥çš„å«ä¹‰æ˜¯ï¼š`**
>
> $r\ltimes_\theta s$   Is a subset of r, in which every tuple $r_i$ matches at least one tuple $s_i$ in s under the condition $\theta$.
>
> **ä¿ç•™ $r$ ä¸­èƒ½ä¸ $s$ ç›¸è¿çš„å…ƒç»„ã€‚**
>
> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152134027.png" alt="image-20240304232437288"  />
> $$
> r \ltimes_{\theta} s = \prod_R(r \bowtie _{\theta} s)
> $$
>
> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152134049.png" >

æœ€ç»ˆåµŒå¥—æŸ¥è¯¢å¯ä»¥å†™ä½œï¼š

![image-20240516101201777](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405161012832.png)

```
The above relational algebra query is also equivalent to

select name
from instructor
where ID in (select teaches.ID 
				from teaches
				where teaches.year = 2022)
```



> **å¯¹åµŒå¥—æŸ¥è¯¢ä¼˜åŒ–çš„ä¸€èˆ¬å½¢å¼ï¼š**

<div align=center> <img src="http://cdn.hobbitqia.cc/202305281827478.png" width = 80%/> </div>

å…¶ä¸­$P_2^2$è¡¨ç¤ºä¸å¤–å¾ªç¯æœ‰å…³çš„å±æ€§

$P_2^1$è¡¨ç¤ºåªä¸å†…å¾ªç¯æœ‰å…³çš„å±æ€§

**æ‰€ä»¥å…ˆç”¨$\sigma_{P_2^1}(s1 \times s2 ...\times s_m)$,å…ˆè¿›è¡Œé€‰æ‹©ï¼Œç„¶åå†ç”¨ç›¸å…³å˜é‡ä½œä¸ºä½œä¸ºåŠè¿æ¥çš„è¿æ¥æ¡ä»¶**

The process of replacing a nested query by a query with a join/semijoin (possibly with a temporary relation) is called **decorrelation(å»é™¤ç›¸å…³)**



> **å¦ä¸€ä¸ªä¼˜åŒ–åµŒå¥—æŸ¥è¯¢çš„ä¾‹å­ï¼š**
>
> **Decorrelation of scalar aggregate subqueries can be done using group by/aggregation in some cases**

<div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327795.png" width = 80%/> </div>

- **å…ˆåˆ©ç”¨teaches_yearå¯¹teachesè¡¨æ ¼è¿›è¡Œç­›é€‰**
- **å†åˆ©ç”¨TIDè¿›è¡Œåˆ†ç»„ï¼Œåœ¨æ¯ä¸€ç»„ä¸­ç®—å‡ºæ•™è¯¾çš„æ•°ç›®ã€‚**
- **åŠè¿æ¥æ—¶ï¼Œå®é™…ä¸Šè¢«åŠè¿æ¥çš„è¡¨æ˜¯ä¸€ä¸ªåªæœ‰ä¸¤ä¸ªå±æ€§çš„è¡¨ï¼šTID,cntã€‚**
- **åˆ©ç”¨è¿™ä¸ªè¡¨ï¼Œå¯¹instructorçš„å…ƒç»„è¿›è¡Œç­›é€‰ï¼Œå°†åŠè¿æ¥æ¡ä»¶è®¾ç½®ä¸ºID = TID& 1 < cntã€‚å› æ­¤ï¼Œinstructorè¡¨ä¸­æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„IDæ‰€åœ¨çš„è¡Œå…ƒç»„å°±ä¼šè¢«ä¿ç•™ï¼Œä¸æ»¡è¶³çš„è¡Œå…ƒç»„ä¼šè¢«èˆå¼ƒã€‚**
- **æœ€åï¼Œå¯¹åŠè¿æ¥ç»“æœï¼ˆå³é€‰æ‹©åçš„instructorè¡¨ï¼‰è¿›è¡ŒæŠ•å½±ï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚**

### 12.4.2 Materialized Views

A **materialized view** is a view whose contents are computed and stored.  

æœ‰äº›æ•°æ®åº“é‡ŒæŠŠ view å®ä¾‹åŒ–äº†ï¼ŒçœŸæ­£å­˜å‚¨åœ¨å†…éƒ¨çš„ä¸´æ—¶è¡¨ã€‚

``` SQL
create view department_total_salary(dept_name, total_salary)as 
select dept_name, sum(salary) 
from instructor 
group by dept_name
```

> **Materializing the above view would be very useful if the total salary by department is required frequently**
>
> **Saves the effort of finding multiple tuples and adding up their amounts**
>
> **`èŠ‚çœæŸ¥æ‰¾å¤šä¸ªå…ƒç»„å¹¶å°†å…¶é‡‘é¢ç›¸åŠ çš„ç²¾åŠ›ï¼Œä½¿ç”¨å‰æå¾€å¾€æ˜¯ä¸Šè¿°è§†å›¾ä½¿ç”¨é¢‘ç¹`**
>
> **`ç¼ºç‚¹ï¼šä½†æ˜¯éœ€è¦æ—¶åˆ»ä¿æŒè¿™ä¸ªè§†å›¾å’ŒåŸè¡¨ä¸€è‡´ã€‚`**



use **incremental view maintenance(å¢é‡è§†å›¾ç»´æŠ¤)**  ï¼š**Changes to database relations are used to compute changes to the materialized view, which is then updated**

**å¯¹æ•°æ®åº“å…³ç³»çš„æ›´æ”¹ç”¨äºè®¡ç®—å¯¹ç‰©åŒ–è§†å›¾çš„æ›´æ”¹ï¼Œç„¶åæ›´æ–°ç‰©åŒ–è§†å›¾**

The changes (inserts and deletes) to a relation or expressions are referred to as its **differential(å·®åˆ†)ï¼š Set of tuples inserted to and deleted from r are denoted $i_r$ and $d_r$**



> **ä¾‹å¦‚ï¼Œæœ€åˆï¼Œä¸¤ä¸ªè¡¨è¿æ¥ç»“æœå¦‚ä¸‹ï¼š**
>
> **![img](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152149808.png)**
>
> **ç°åœ¨ï¼Œè¡¨æ ¼ræ’å…¥äº†ä¸€æ¡æ–°çš„è®°å½•ï¼š**
>
> **![æ‰‹æœºå±å¹•æˆªå›¾  ä¸­åº¦å¯ä¿¡åº¦æè¿°å·²è‡ªåŠ¨ç”Ÿæˆ](https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405152149812.png)**
>
> **é‚£ä¹ˆï¼Œéœ€è¦å°†æ–°å¢çš„è¿™æ¡è®°å½•å’Œsè¡¨åšè¿æ¥ï¼Œå¹¶å°†è¿æ¥çš„ç»“æœåŠ å…¥åˆ°ç‰©åŒ–è§†å›¾ä¸­ï¼Œä»¥ç»´æŠ¤è§†å›¾ä¿¡æ¯çš„æ­£ç¡®æ€§ã€‚**

* join: $V^{new}=V^{old}\cup (i_r\bowtie s), V^{new} = V^{old}-(d_r\bowtie s)$
    <center>
            <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327857.png" width = 80%/> </div>
      </center>
    
    
    
* select: $V^{new}=V^{old}\cup \sigma_\theta(i_r), V^{new} = V^{old}-\sigma_\theta(d_r)$

    > **å‡å¦‚ä¸æ˜¯è¿æ¥æ“ä½œï¼Œè¿™ä¸ªç‰©åŒ–è§†å›¾æ˜¯ç”±å¦ä¸€ä¸ªè¡¨rçš„é€‰æ‹©æ“ä½œå¾—å‡ºçš„ã€‚é‚£ä¹ˆå‡å¦‚è¡¨ræ’å…¥äº†ä¸€æ¡æ–°å…ƒç»„ï¼Œä¸ºäº†ç»´æŠ¤ç‰©åŒ–è§†å›¾ï¼Œåªè¦æŠŠæ’è¿›å»çš„é‚£ä¸ªå…ƒç»„åˆ©ç”¨ç›¸åŒçš„é€‰æ‹©æ¡ä»¶è¿›è¡Œé€‰æ‹©ï¼Œå¦‚æœé€‰æ‹©ä¸Šäº†ï¼Œå°±æŠŠå®ƒå¹¶åˆ°ç‰©åŒ–è§†å›¾ä¸­ã€‚**

* projection:  

  For each tuple in a projection $\Pi_A(r)$, we will keep a count of how many times it was derived.  

    * On *insert* of a tuple to r, if the resultant tuple is already in $\Pi_A(r)$ we increment its count, else we add a new tuple with count = 1

    * On *delete* of a tuple from r, we decrement the count of the corresponding tuple in $\Pi_A(r)$ 
      
      * if the count becomes 0, we delete the tuple from $\Pi_A(r)$
      
      <center>
             <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327847.png" width = 80%/> </div>
      </center>
      
      

* count $v= _Ag_{count(B)}$
    * insert: For each tuple r in $i_r$, if the corresponding group is **`already present`** in v, we` increment its count`, else we add a new tuple with count = 1
    
    * delete: for each tuple t in $i_r$.we look for the group t.A in v, and subtract 1 from the count for the group.   

      **If the count becomes 0, we delete from v the tuple for the group t.A**
    
    > **å‡å¦‚ç‰©åŒ–è§†å›¾æ˜¯ç”±å¯¹Aå±æ€§å¯¹è¡¨rè¿›è¡Œåˆ†ç»„ï¼Œç„¶åè¿›è¡Œcountè®¡ç®—å¾—åˆ°çš„ï¼Œé‚£ä¹ˆå‡è®¾è¡¨ræ–°æ’å…¥äº†ä¸€æ¡å…ƒç»„ï¼Œå‡è®¾è¿™ä¸ªå…ƒç»„çš„åˆ†ç»„å±æ€§çš„å€¼åœ¨åˆ†å¥½ç»„çš„åˆ†ç»„å±æ€§å€¼çš„é›†åˆä¸­ï¼Œé‚£ä¹ˆå°±æŠŠå¯¹åº”ç‰©åŒ–è§†å›¾çš„è¿™ä¸ªcountå€¼åŠ 1ã€‚å‡è®¾è¿™ä¸ªå…ƒç»„çš„åˆ†ç»„å±æ€§çš„å€¼ä¸åœ¨åˆ†å¥½ç»„çš„åˆ†ç»„å±æ€§å€¼ä¸­ï¼Œé‚£ä¹ˆå°±åœ¨ç‰©åŒ–è§†å›¾ä¸­æ’å…¥æ–°çš„ä¸€è¡Œï¼ŒåŒ…æ‹¬è¿™ä¸ªå…ƒç»„çš„åˆ†ç»„å±æ€§å€¼ï¼Œå¯¹åº”çš„countç½®ä¸º1ã€‚**
    
* sum $v= _Ag_{sum(B)}$

    > **ä¸countç±»ä¼¼ã€‚å½“æ’å…¥ä¸€æ¡æ–°çš„å…ƒç»„æ—¶ï¼Œæˆ‘ä»¬éœ€è¦addè¿™ä¸ªå…ƒç»„ä¸­å±æ€§Açš„value**
    >
    > **`ç”±äºå­˜åœ¨value=0çš„æƒ…å†µï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®°å½•countæ¥æ£€æŸ¥groupsä¸­æ˜¯å¦å­˜åœ¨tupleã€‚è€Œä¸èƒ½ç®€å•ä¾é sum=0è¿›è¡Œåˆ¤æ–­`**
    >
    > **To handle the case of avg, we maintain the sum and count aggregate values separately, and divide at the endã€‚`å¯¹äºå¹³å‡æ•°çš„ç»´æŠ¤ï¼Œåˆ†åˆ«ç»´æŠ¤sumå’Œcountï¼Œæœ€ç»ˆç›¸å¤„è¿›è¡Œè®¡ç®—`**

* min, maxï¼š$v = _Ag_{min(B)}(r)$

    > 1. å¯¹äºæ’å…¥çš„å¤„ç†è¾ƒä¸ºç®€å•ï¼Œæ¯”è¾ƒä¸€ä¸‹ç°æœ‰çš„minå’Œmaxå³å¯
    > 2. ç»´æŠ¤åˆ é™¤æ—¶çš„æœ€å°å€¼å’Œæœ€å¤§å€¼çš„èšåˆå€¼å¯èƒ½ä¼šæ›´æ˜‚è´µã€‚ æˆ‘ä»¬å¿…é¡»æŸ¥çœ‹åŒä¸€ç»„ä¸­çš„å…¶ä»–å…ƒç»„**ä»¥æ‰¾åˆ°æ–°çš„æœ€å°å€¼(`å¯èƒ½ä¼šæŠŠæœ€å°å€¼æˆ–è€…æœ€å¤§å€¼åˆ é™¤ï¼Œè¿™æ˜¯éœ€è¦é‡æ–°å¯»æ‰¾`)**

* set intersection: $v = r \cap s$

    > 1. **å½“ä¸€ä¸ªå…ƒç»„æ’å…¥åˆ° r ä¸­æ—¶ï¼Œæˆ‘ä»¬æ£€æŸ¥å®ƒæ˜¯å¦å­˜åœ¨äº s ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œæˆ‘ä»¬å°†å…¶æ·»åŠ åˆ° v ä¸­ã€‚**
    > 2. **å¦‚æœä» r ä¸­åˆ é™¤è¯¥å…ƒç»„ï¼Œåˆ™æˆ‘ä»¬å°†å…¶ä»äº¤é›†ä¸­åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚**

æ€ä¹ˆåˆ©ç”¨è¿™äº› view? 

* Rewriting queries to use materialized views:

     <center>
            <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405131327850.png" width = 80%/> </div>
     </center>

* Replacing a use of a materialized view by the view definition

     <center>
            <div align=center> <img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405161035196.png" width = 80%/> </div>
     </center>

    

Materialized View Selection  

æœ‰å“ªäº›æŸ¥è¯¢ï¼Ÿå„ç§æŸ¥è¯¢çš„æ¯”ä¾‹ï¼Ÿ



