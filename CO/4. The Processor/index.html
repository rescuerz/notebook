
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="rescuerz's notebook">
      
      
      
      
        <link rel="prev" href="../3.%20Arithmetic%20for%20Computer/">
      
      
        <link rel="next" href="../5.%20Large%20and%20Fast%20Exploiting%20Memory%20Hierarchy/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>四. The Processor - rescuerz's notebook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeline.css">
    
      <link rel="stylesheet" href="../../supports/css/base.css">
    
      <link rel="stylesheet" href="../../supports/css/theme.css">
    
      <link rel="stylesheet" href="../../supports/css/admonitions.css">
    
      <link rel="stylesheet" href="https://jsd.cdn.zzko.cn/npm/katex@0.16.4/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#四-the-processor" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="rescuerz&#39;s notebook" class="md-header__button md-logo" aria-label="rescuerz's notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            rescuerz's notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              四. The Processor
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/rescuerz/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    rescuerz/notebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ADS/" class="md-tabs__link">
          
  
    
  
  Computer Science

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../DB/" class="md-tabs__link">
          
  
    
  
  System

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../CV/" class="md-tabs__link">
          
  
    
  
  Artificial Intelligence

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="rescuerz&#39;s notebook" class="md-nav__button md-logo" aria-label="rescuerz's notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    rescuerz's notebook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rescuerz/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    rescuerz/notebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Home
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    更新记录
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../link/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    友链
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Computer Science
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Computer Science
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../ADS/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    高级数据结构与算法分析
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            高级数据结构与算法分析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/1.%20AVL_tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. AVL Tree &amp; Splay Tree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/2.%20Red%20Black%20Tree%20%26%20B%2B%20Tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Red Black Tree &amp; B+ Tree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/3.%20Inverted%20File%20Index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Inverted File Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/4.%20Leftist%20Heaps%20and%20Skew%20Heaps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Leftist Heap &amp; Skew Heap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/5.%20Binomial%20Queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Binomial Queue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/6.%20backtracking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Backtracking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/7.%20Divide%20%26%20Conquer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Divide &amp; Conquer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/8.%20Dynamic%20Programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Dynamic Programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/9.%20Greedy%20Algorithms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. Greedy Algorithms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/10.%20NP-Completeness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. NP-Completeness
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/11.%20Approximation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. Approximation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/12.%20Local%20Search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. Local Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/13.%20Randomized%20Algorithms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. Randomized Algorithms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/14.%20Parallel%20Algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. Parallel Algorithm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/15.%20External%20Sorting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. External Sorting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    System
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../DB/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    数据库系统
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            数据库系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/1.%20Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/2.%20Relational%20Model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Relational Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/3.%20SQL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. SQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/6.%20Entity-Relationship%20Model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Entity-Relationship Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/7.%20Relational%20Database%20Design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Relational Database Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/8.%20Physical%20Storage%20Systems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Physical Storage Systems
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/9.%20Data%20Storage%20Structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. Data Storage Structures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/10.%20Indexing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. Indexing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/11.%20Query%20Processing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. Query Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/12.%20Query%20Optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. Query Optimization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/13.%20Transaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. Transactions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/14.%20Concurrency%20Control/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. Concurrency Control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DB/15.%20Recovery%20System/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. Recovery System
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    计算机组成与设计
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            计算机组成与设计
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.%20Introduce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    一. Introduce
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2.%20Instructions%20Language%20of%20the%20Computer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    二. Instructions: Language of the Computer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3.%20Arithmetic%20for%20Computer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    三. Arithmetic for Computer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    四. The Processor
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    四. The Processor
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#41-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#42-cpu-overview" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 CPU Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#43-building-a-datapath" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Building a datapath
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 Building a datapath">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-instruction-execution-in-risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.1 Instruction execution in RISC-V
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-r型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.2 R型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#433-i型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.3 I型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#434-s型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.4 S型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#435-sb型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.5 SB型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#436-uj型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.6 UJ型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#437-u型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.7 U型指令
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#44-controller" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 controller
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-alu-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.1 ALU control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-datapath-with-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.2 Datapath with Control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#45-exception" class="md-nav__link">
    <span class="md-ellipsis">
      4.5 Exception
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5 Exception">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451-handling-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.1 Handling Exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452-risc-v-privileged" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.2 RISC-V Privileged
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#46-overview-of-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6 Overview of Pipelining
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.6 Overview of Pipelining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#461-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1 Pipelining
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.6.1 Pipelining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4611-pipeline-performance" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1.1 Pipeline Performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4612-risc-v-isa-designed-for-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1.2 RISC-V ISA designed for pipelining
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#462-risc-v-pipelined-datapath" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.2 RISC-V Pipelined Datapath
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#463-pipeline-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.3 Pipeline Control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#47-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7 Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.7 Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471-structure-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.1 Structure Hazards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472-data-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.2 Data Hazards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473-control-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.3 Control Hazards
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#48-data-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.8 Data Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.8 Data Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#481-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.1 Forwarding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#482-load-use-hazard-detection" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.2 Load-Use Hazard Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#483-stalls-and-performance" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.3 Stalls and Performance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#49-branch-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.9 Branch Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.9 Branch Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#491-stall" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.1 stall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#492-predict-untakentaken" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.2 Predict-untaken/taken
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#493-static-branch-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.3 Static branch prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#494-dynamic-branch-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.4 Dynamic Branch Prediction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#410-exception-in-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      4.10 Exception in pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.10 Exception in pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4101-single-exception" class="md-nav__link">
    <span class="md-ellipsis">
      4.10.1 Single Exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4102-multiple-exxceptions" class="md-nav__link">
    <span class="md-ellipsis">
      4.10.2 Multiple Exxceptions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5.%20Large%20and%20Fast%20Exploiting%20Memory%20Hierarchy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    五. Large and Fast: Exploiting Memory Hierarchy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6.%20Storage%2C%20Networks%20and%20Other%20Peripherals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    六. Storage, Networks and Other Peripherals
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Artificial Intelligence
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Artificial Intelligence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../CV/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Computer Vision
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Computer Vision
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture1_Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture2_Image_Classification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Image_Classification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture3_Linear_Classifiers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linear_Classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture4_Optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture5_Neural_Networks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neural Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture6_Backpropagation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backpropagation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture7_ConvolutionalNetworks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convolutional Neural Networks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture8_CNN_Architectures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CNN Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CV/Lecture9_Hardware_and_Software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware and Software
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#41-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#42-cpu-overview" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 CPU Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#43-building-a-datapath" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Building a datapath
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 Building a datapath">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-instruction-execution-in-risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.1 Instruction execution in RISC-V
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-r型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.2 R型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#433-i型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.3 I型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#434-s型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.4 S型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#435-sb型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.5 SB型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#436-uj型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.6 UJ型指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#437-u型指令" class="md-nav__link">
    <span class="md-ellipsis">
      4.3.7 U型指令
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#44-controller" class="md-nav__link">
    <span class="md-ellipsis">
      4.4 controller
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-alu-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.1 ALU control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-datapath-with-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.4.2 Datapath with Control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#45-exception" class="md-nav__link">
    <span class="md-ellipsis">
      4.5 Exception
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.5 Exception">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#451-handling-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.1 Handling Exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#452-risc-v-privileged" class="md-nav__link">
    <span class="md-ellipsis">
      4.5.2 RISC-V Privileged
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#46-overview-of-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6 Overview of Pipelining
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.6 Overview of Pipelining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#461-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1 Pipelining
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.6.1 Pipelining">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4611-pipeline-performance" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1.1 Pipeline Performance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4612-risc-v-isa-designed-for-pipelining" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.1.2 RISC-V ISA designed for pipelining
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#462-risc-v-pipelined-datapath" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.2 RISC-V Pipelined Datapath
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#463-pipeline-control" class="md-nav__link">
    <span class="md-ellipsis">
      4.6.3 Pipeline Control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#47-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7 Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.7 Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471-structure-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.1 Structure Hazards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472-data-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.2 Data Hazards
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473-control-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.7.3 Control Hazards
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#48-data-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.8 Data Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.8 Data Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#481-forwarding" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.1 Forwarding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#482-load-use-hazard-detection" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.2 Load-Use Hazard Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#483-stalls-and-performance" class="md-nav__link">
    <span class="md-ellipsis">
      4.8.3 Stalls and Performance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#49-branch-hazards" class="md-nav__link">
    <span class="md-ellipsis">
      4.9 Branch Hazards
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.9 Branch Hazards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#491-stall" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.1 stall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#492-predict-untakentaken" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.2 Predict-untaken/taken
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#493-static-branch-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.3 Static branch prediction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#494-dynamic-branch-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      4.9.4 Dynamic Branch Prediction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#410-exception-in-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      4.10 Exception in pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.10 Exception in pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4101-single-exception" class="md-nav__link">
    <span class="md-ellipsis">
      4.10.1 Single Exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4102-multiple-exxceptions" class="md-nav__link">
    <span class="md-ellipsis">
      4.10.2 Multiple Exxceptions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/rescuerz/notebook/blob/main/docs/CO/4. The Processor.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/rescuerz/notebook/raw/main/docs/CO/4. The Processor.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


<h1 id="四-the-processor">四. The Processor<a class="headerlink" href="#四-the-processor" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 8610 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13Z"/></svg></span> 预计阅读时间 43 分钟</p>
</div>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010858322.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="img" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010858322.png" /></a></p>
<h2 id="41-introduction">4.1 Introduction<a class="headerlink" href="#41-introduction" title="Permanent link">&para;</a></h2>
<ul>
<li>Instruction count
  Determined by ISA and compiler
  如同样的功能用 Intel 和 RISC-V 的处理器实现，英特尔的指令用的更少（因为更复杂）</li>
<li>CPI and Cycle time
  Determined by CPU <em>hardware</em></li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010904471.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240304082705409" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010904471.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010905243.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240228163207719" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010905243.png" /></a></p>
<blockquote>
<p><strong>唯一的性能标准是CPU Time</strong></p>
</blockquote>
<p>For every instruction, the first two steps are identical <strong><code>对于每条指令，前两个步骤都是相同的</code></strong></p>
<ul>
<li><strong>Fetch the instruction from the memory</strong>
  <strong>从内存中获取指令</strong></li>
<li><strong>Decode and read the registers</strong>
  <strong>解码和读取寄存器</strong></li>
</ul>
<p>Next steps depend on the instruction class 后续步骤取决于指令类</p>
<ul>
<li>Memory-reference 内存参考
  <code>load, store</code></li>
<li>Arithmetic-logical 算术逻辑</li>
<li>branches 分支</li>
</ul>
<blockquote>
<p>均需要ALU的参与</p>
</blockquote>
<p>Depending on instruction class</p>
<ul>
<li>
<p>Use ALU to calculate</p>
</li>
<li>
<p><strong>Arithmetic</strong> result </p>
</li>
<li>
<p>Memory address for <strong>load / store</strong></p>
</li>
<li>
<p><strong>Branch</strong> comparison</p>
</li>
<li>
<p>Access data memory for <strong>load / store</strong></p>
</li>
<li>
<p>PC <span class="arithmatex">\(\leftarrow\)</span> target address PC + 4</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010921240.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092106174" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010921240.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010922533.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092226465" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010922533.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010922678.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092242591" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010922678.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010924988.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092409910" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010924988.png" /></a></p>
<blockquote>
<p><strong>先写后读，能够实现读取最新的数据</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010925704.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092548635" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010925704.png" /></a></p>
<blockquote>
<p><strong>寄存器堆能够同时实现读取两个寄存器，和写入一个寄存器（对应R型指令）</strong></p>
<p><strong>reg_R_addr_A, reg_R_addr_B 是mux的选择信号</strong></p>
<p><strong>reg_W_addr 选择对那个寄存器进行load操作</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010929655.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092944577" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010929655.png" /></a></p>
<p><strong>Read register number 1作为 mux 的选择信号，得到对应的 Read Data</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010929988.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401092957903" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010929988.png" /></a></p>
<p><strong>Write 决定能否写入， Register number 决定哪个寄存器进行写入，双重作用AND，</strong></p>
<blockquote>
<p><strong><code>Immediate generation unit</code></strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031001567.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403100113501" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031001567.png" /></a></p>
<ul>
<li>根据指令类型（<strong><code>ImmSel</code></strong>），选取特定的bit位生成相应的立即数</li>
<li>立即数字段符号扩展为64位结果输出</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161851793.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240416185134734" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161851793.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010932724.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240401093246644" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404010932724.png" /></a></p>
<blockquote>
<p><strong>利用整个opcode，选择立即数的生成方式</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031003346.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403100335279" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031003346.png" /></a></p>
<p><code>U-type 0110111 lui rd imm {instr[31:19], 12’b0}</code></p>
<h2 id="42-cpu-overview">4.2 CPU Overview<a class="headerlink" href="#42-cpu-overview" title="Permanent link">&para;</a></h2>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161031766.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image.png" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161031766.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031013639.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403101301582" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031013639.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031013954.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403101313860" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031013954.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031016994.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403101612896" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031016994.png" /></a></p>
<p><strong>edge triggered 边沿触发</strong></p>
<p><strong>在上升沿到来时，取出state element， 后续进入combinational logic进行运算，在下一个上升沿到来后，存储state element</strong></p>
<h2 id="43-building-a-datapath">4.3 Building a datapath<a class="headerlink" href="#43-building-a-datapath" title="Permanent link">&para;</a></h2>
<ul>
<li>opcode：basic operation of the instruction.</li>
<li>rs1： the first register source operand. </li>
<li>rs2： the second register source operand. </li>
<li>rd： the register destination operand. </li>
<li>funct： function,this field selects the specific variant of the operation in the op field.  </li>
<li>Immediate: address or immediate</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031020474.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403102027388" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031020474.png" /></a>、<a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404170947212.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240417094706125" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404170947212.png" /></a></p>
<h3 id="431-instruction-execution-in-risc-v">4.3.1 Instruction execution in RISC-V<a class="headerlink" href="#431-instruction-execution-in-risc-v" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Fetch 获取</p>
</li>
<li>
<p>Take instructions from the instruction memory
    从指令存储器中获取指令</p>
</li>
<li>
<p>Modify PC to point the next instruction
    修改 PC 以指向下一条指令</p>
</li>
<li>
<p>Instruction decoding &amp; Read Operand </p>
</li>
</ul>
<p>指令解码和读取操作数：</p>
<ul>
<li>Will be translated into machine control command
    将转换为机器控制命令</li>
<li>
<p>Reading Register Operands, whether or not to use
    读取寄存器操作数，是否使用</p>
</li>
<li>
<p>Executive Control 执行控制：</p>
</li>
<li>
<p>Control the implementation of the corresponding ALU operation
    控制相应 ALU 操作的实现</p>
</li>
<li>
<p>Memory access 内存访问：</p>
</li>
<li>
<p>Write or Read data from memory
    从内存中写入或读取数据</p>
</li>
<li>
<p>Only ld/sd 只有 ld/sd</p>
</li>
<li>
<p>Write results to register 写入结果进行注册：</p>
</li>
<li>
<p>If it is R-type instructions, ALU results are written to rd
    如果是 R 型指令，则将 ALU 结果写入 rd</p>
</li>
<li>
<p>If it is I-type instructions, memory data are written to rd
    如果是 I 型指令，则内存数据将写入 rd</p>
</li>
<li>
<p><strong>Modify PC for branch instructions
  修改 PC 以获取分支说明</strong></p>
</li>
<li>
<p>Fetch</p>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031024881.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403102428818" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031024881.png" /></a></p>
<p><strong>PC地址对应的数据（指令的地址），直接进入内存读取指令，此处不需要控制read 还是 wirte</strong></p>
<blockquote>
<p>为什么PC + 4？ 因为一条指令有32位，一个字节8位</p>
</blockquote>
<h3 id="432-r型指令">4.3.2 R型指令<a class="headerlink" href="#432-r型指令" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031045218.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403104546153" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031045218.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161033499.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image.png" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161033499.png" /></a></p>
<ul>
<li>(1) 处取出指令， <code>[6:0](opcode)</code> 被送到 Control 产生对应的控制信号，我们稍后可以看到； <code>[19:15](rs1)</code> , <code>[24:20](rs2)</code> , <code>[11:7](rd)</code> 分别对应 <code>rs1</code> , <code>rs2</code> , <code>rd</code> ，被连入 Registers 这个结构，对应地 <code>Read data 1</code> 和 <code>Read data 2</code> 两处的值即变为 <code>rs1</code> , <code>rs2</code> 的值；</li>
<li>(2) 处 MUX 在 <code>ALUSrc = 0</code> 的信号作用下选择 <code>Read data 2</code> 作为 ALU 的输入与 <code>Read data 1</code> 进行运算，具体的运算由 <code>ALU control</code> 提供的信号指明（我们在 <strong>4.1.3 小节</strong> 讨论这个话题）。运算结果在 <code>ALU result</code> 中。</li>
<li><strong>(3) 处 MUX 在 <code>MemtoReg = 0</code> 的信号作用下选择 <code>ALU result</code> 作为写回 Register 的值</strong>，连到 (4) 处；在 (5) 处 <code>RegWrite = 1</code> 信号控制下，该值写入到 <code>rd</code> 寄存器中。</li>
</ul>
<h3 id="433-i型指令">4.3.3 I型指令<a class="headerlink" href="#433-i型指令" title="Permanent link">&para;</a></h3>
<p><code>addi &amp;&amp; ld</code></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031039380.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403103904297" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031039380.png" /></a></p>
<ul>
<li><strong>对于addi，在ALU前，需要添加mux，区分imm和sourse register</strong></li>
<li>对于load， 在ALU计算之后，计算出地址，进入到data memory取数据，取出来之后需要存储到rd，所以在ALU之后还需要一个mux，一个存储内存取出的data，一个是ALU直接计算的data</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161859555.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image.png" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161859555.png" /></a></p>
<p>addi:</p>
<ul>
<li>(1) 处取出指令， <code>[6:0](opcode)</code> 被送到 Control 产生对应的控制信号，我们稍后可以看到； <code>[19:15](rs1)</code>  , <code>[11:7](rd)</code> 分别对应 <code>rs1</code>, <code>rd</code> ，被连入 Registers 这个结构，对应地 <code>Read data 1</code> 的值即变为 <code>rs1</code>的值；[31:20] (imm)对应立即数，传输到Imm_Gen</li>
<li>(2) 处 MUX 在 <code>ALUSrc = 1</code> 的信号作用下选择 <code>Imm_out</code> 作为 ALU 的输入与 <code>Read data 1</code> 进行运算，具体的运算由 <code>ALU control</code> 提供的信号指明（我们在 <strong>4.1.3 小节</strong> 讨论这个话题）。运算结果在 <code>ALU result</code> 中。</li>
<li><strong>(3) 处 MUX 在 <code>MemtoReg = 0</code> 的信号作用下选择 <code>ALU result</code> 作为写回 Register 的值</strong>，连到 (4) 处；在 (5) 处 <code>RegWrite = 1</code> 信号控制下，该值写入到 <code>rd</code> 寄存器中。</li>
</ul>
<p>ld:</p>
<ul>
<li>(1) 处取出指令， <code>[6:0](opcode)</code> 被送到 Control 产生对应的控制信号，我们稍后可以看到； <code>[19:15](rs1)</code>  , <code>[11:7](rd)</code> 分别对应 <code>rs1</code>, <code>rd</code> ，被连入 Registers 这个结构，对应地 <code>Read data 1</code> 的值即变为 <code>rs1</code>的值；[31:20] (imm)对应立即数，传输到Imm_Gen</li>
<li>(2) 处 MUX 在 <code>ALUSrc = 1</code> 的信号作用下选择 <code>Imm_out</code> 作为 ALU 的输入与 <code>Read data 1</code> 进行运算，具体的运算由 <code>ALU control</code> 提供的信号指明（我们在 <strong>4.1.3 小节</strong> 讨论这个话题）。运算结果在 <code>ALU result</code> 中。</li>
<li>(3) ALU_result 计算的是 内存的地址，从 Data memory中取出data，经过（3）处MUX的选择，传输到Register File，在RegWrite = 1的控制，写入到目标寄存器</li>
</ul>
<h3 id="434-s型指令">4.3.4 S型指令<a class="headerlink" href="#434-s型指令" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031046124.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403104610056" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031046124.png" /></a></p>
<p><strong><code>注意store指令的格式，不再存在rd，func7，分别转化为imm[4:0], imm[11:5]</code></strong></p>
<p>对于store指令，sd x8，200(x9), 将x8的数据存储到指定的地址</p>
<p>write_data, 和 write_addr,连接到data memory</p>
<h3 id="435-sb型指令">4.3.5 SB型指令<a class="headerlink" href="#435-sb型指令" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031050814.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403105013711" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031050814.png" /></a></p>
<p>需要两个ALU，一个ALU计算x1和x2的差值，得到的结果zero用于mux的选择信号，选择PC+4或者PC+200</p>
<p>另一个ALU，用于计算PC+imm</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161042034.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image.png" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404161042034.png" /></a></p>
<ul>
<li>(1) 中有两个加法器，一个的结果是 PC + 4，另一个是 PC + offset，其中 offset 是来自当前 instruction 的；<strong>这两个加法器通过 MUX 送给 PC</strong></li>
<li>MUX 的控制信号来自 (2)， (2) 是一个与门，即当且仅当两个输入信号都为真时才会输出 1，从而在上述 MUX 中选择跳转。 (2) 的两个输入分别来自：</li>
<li>(5) 这个 ALU 的 Zero 信号，这是第 3 章中我们设计的可以用来实现 <code>beq</code> 的结构；我们讨论过实现 <code>beq</code> 其实就是计算 <code>rs1 - rs2</code> 判断其是否为 0，所以这里根据 Zero 是否为 0 就能判断两个寄存器是否相等</li>
<li><strong>(4) 处 Control 给出的 <code>Branch</code> 信号，即如果这个语句是跳转语句，那么对应的信号会置为 1</strong></li>
</ul>
<p><strong>也就是说，当且仅当语句确实是 <code>beq</code> 而且 <code>Zero</code> 信号的值确实为 1 时才会进行跳转。</strong></p>
<h3 id="436-uj型指令">4.3.6 UJ型指令<a class="headerlink" href="#436-uj型指令" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031057903.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403105749843" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031057903.png" /></a></p>
<p>无条件跳转，采用PC相对寻址 PC+imm</p>
<p><strong>额外部分在于将PC+4存储到x1寄存器</strong></p>
<p>扩充：PC+4在ALU之后的输出结果分为两条路，一条指向寄存器堆（<code>此处可以和data memory之前mux合并，一起选择</code>），将PC+4保存在x1，另一条和PC+imm进行mux的选择</p>
<h3 id="437-u型指令">4.3.7 U型指令<a class="headerlink" href="#437-u型指令" title="Permanent link">&para;</a></h3>
<p><strong>lui x5, imm 读取立即数的值，将imm保存到目标寄存器的高20位</strong></p>
<p>直接将imm连接到data memory前的mux合并（现在有4个选择），此处的mux输出结果连接到寄存器堆的write_data</p>
<h2 id="44-controller">4.4 controller<a class="headerlink" href="#44-controller" title="Permanent link">&para;</a></h2>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031123788.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403112327728" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031123788.png" /></a></p>
<p>7 个控制信号和一个 4 位的 <code>ALU_operation</code></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031126058.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403112615980" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031126058.png" /></a></p>
<p>蓝色表示与controller有关</p>
<h3 id="441-alu-control">4.4.1 ALU control<a class="headerlink" href="#441-alu-control" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031127361.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403112738286" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031127361.png" /></a></p>
<p><strong>先根据opcode生成两位的ALUop</strong></p>
<p><strong>再根据func3和func7[5] 生成ALU control</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031129919.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240403112911858" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031129919.png" /></a></p>
<ul>
<li>
<p>First level</p>
</li>
<li>
<p>一级解码后，可以决定除了 <code>ALU_opration</code> 以外的控制信号</p>
</li>
<li>同时我们会解码出 2 位的 <code>ALU_op</code>.</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031130208.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="img" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031130208.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031131078.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031131078.png" /></a></p>
<ul>
<li>Second level</li>
</ul>
<p>ALU operation is decided by 2-bit ALUOp derived from opcode, and funct7 &amp; funct3 fields of the instruction.</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031131793.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="img" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404031131793.png" /></a></p>
<h3 id="442-datapath-with-control">4.4.2 Datapath with Control<a class="headerlink" href="#442-datapath-with-control" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101006825.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410100609642" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101006825.png" /></a></p>
<p>右上方的第一个MUX，选择PC+4和PC+imm，执行的是branch操作，选择信号是branch</p>
<p>第二个MUX，选择branch未执行的结果（PC+4），jalr（rd+imm），PC+imm，执行的是jump操作，选择信号是jump</p>
<p><code>当然也可以仅用一个mux实现，选择PC+4，PC+imm，rs+imm，只需要满足branch和jal的选择信号是00/01，jalr的选择信号是10</code>，</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101036304.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="img" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101036304.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101025140.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410102539979" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101025140.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101027628.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410102710546" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101027628.png" /></a></p>
<ul>
<li>
<p>ld的 MemtoReg = 01，目的是将指定地址的数据写到目标寄存器</p>
</li>
<li>
<p>addi，addi x5，x6，200</p>
</li>
</ul>
<p>200    x6  fun3  x5  addi</p>
<p>ALUSrcB  = 1，选择imm。MemtoReg = 0.选择 x5 + imm。RegWrite = 1，将结果写到rd。MemRead = 0.MemWrite = 0.Branch = 0。Jump = 0.</p>
<ul>
<li>jalr， jalr x1， 200（x7)  I 型指令</li>
</ul>
<p>1     10  1   0   0   0   1   </p>
<ul>
<li>lui，imm直接连接到MemtoReg，此时MemtoReg = 11.</li>
</ul>
<p>X     11  1    0  0   0   ….</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101123315.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410112311186" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101123315.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101123107.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410112320995" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101123107.png" /></a></p>
<p>单周期的实现是指，一个指令的所有工作都在一个时钟周期内完成，也就是 CPI = 1。那么，一个时钟周期的长度就要足够最长的那个指令完成运行。</p>
<p>但是，例如 <code>load</code> 类的指令要经过 inst mem, reg file, ALU, data mem, reg file 这么多的步骤，这会使得时钟周期变得很长，导致整体性能变得很差。</p>
<p>单周期的实现违反了 <strong>common case fast</strong> 这一设计原则。</p>
<h2 id="45-exception">4.5 Exception<a class="headerlink" href="#45-exception" title="Permanent link">&para;</a></h2>
<p>The cause of changing CPU’s work flow : </p>
<ul>
<li><strong>Control instructions</strong> in program (bne/beq, jal , etc) </li>
</ul>
<p>It is foreseeable in programming flow </p>
<ul>
<li>Something happen suddenly (<code>Exception and Interruption</code>) </li>
</ul>
<p>It is unpredictable </p>
<p><strong>Call Instructions triggered by hardware</strong> </p>
<p><strong><code>Exception</code></strong> </p>
<ul>
<li><strong>Arises within the CPU（e.g., overflow, undefined opcode, syscall, …）</strong> </li>
</ul>
<p><strong><code>Interrupt</code></strong> </p>
<ul>
<li><strong>From an external I/O controller</strong> </li>
</ul>
<p>Dealing with them without sacrificing performance is hard</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101135959.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410113531896" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101135959.png" /></a></p>
<h3 id="451-handling-exceptions">4.5.1 Handling Exceptions<a class="headerlink" href="#451-handling-exceptions" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101143287.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240410114320207" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404101143287.png" /></a></p>
<p>mtvec提供基地址，根据mCAUSE计算偏移量，跳转到相应的handle</p>
<h3 id="452-risc-v-privileged">4.5.2 RISC-V Privileged<a class="headerlink" href="#452-risc-v-privileged" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150806452.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415080640378" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150806452.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150812202.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415081250146" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150812202.png" /></a></p>
<ul>
<li><strong><code>All hardware implementations must provide M-mode</code></strong></li>
</ul>
<p>最简单的RISC-V实现，仅提供 M mode</p>
<ul>
<li><strong><code>Machine mode most important task:intercept and handle interrupts/exceptions（使用CSR寄存器）</code></strong></li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150851621.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415085112553" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150851621.png" /></a></p>
<p>mechine level has the highest privileges</p>
<p><strong>CSR 指令都使用 I 型指令，其中 12 位的立即数部分表示 CSR 的地址，funct3 低 2 位用来编码读 / 改 / 写（read-modify-write）操作、高 1 位表示是否来自立即数（如果来自立即数则 rs1 部分表示一个 5 位无符号立即数），opcode 都是 SYSTEM（1110011）。</strong></p>
<blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062109770.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506210928554" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062109770.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062110532.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506211018437" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062110532.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062110394.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506211035299" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062110394.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111842.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506211106733" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111842.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111566.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506211119470" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111566.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111168.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240506211132079" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405062111168.png" /></a></p>
<p>// CSR 相关指令包括</p>
<p>// 1. csrrw 读取 CSR 寄存器的值到 rd，然后将 rs1 的值写入 CSR 寄存器</p>
<p>// 2. csrrs 读取 CSR 寄存器的值到 rd，然后将 rs1 的值与 CSR 寄存器的值进行或操作，然后写入 CSR 寄存器</p>
<p>// 3. csrrc 读取 CSR 寄存器的值到 rd，然后将 rs1 的值与 CSR 寄存器的值进行与操作，然后写入 CSR 寄存器</p>
<p>// 4. csrrwi 读取 CSR 寄存器的值到 rd，然后将 zimm 写入 CSR 寄存器</p>
<p>// 5. csrrsi 读取 CSR 寄存器的值到 rd，然后将 CSR 寄存器的值与 zimm 进行或操作，然后写入 CSR 寄存器</p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150811817.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415081150751" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150811817.png" /></a></p>
<p>CSRRW:将csr的值赋值给rd，将rs1的值写入到csr（Read and Write）</p>
<p>CSRRS：需要改动的位Set,rs1特定位置为1，其他位为0，csr = csr | rs1（Read and Set）</p>
<p>CSRRC：将指定位清零，rs1特定位置为0，其他位为1，csr = csr &amp; ~rs1（Read and Clear）</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150857089.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415085748015" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150857089.png" /></a></p>
<p><strong>MRET，mstatus需要变化，eg: mp <span class="arithmatex">\(\leftarrow\)</span> mpp, mie <span class="arithmatex">\(\leftarrow\)</span> mpie</strong></p>
<p><strong><code>MRET：用于执行完异常处理之后返回</code></strong></p>
<p><strong>wfi（wait for interrupt）</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150816386.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415081605303" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150816386.png" /></a></p>
<ol>
<li><strong>mstatus: <code>Machine Status register 机器模式状态寄存器</code></strong></li>
</ol>
<p><strong>标记中断全局使能</strong>，MIE（0011），SIE（0001），UIE（0000），高级别不理低级别，低级别响应高级别</p>
<blockquote>
<p><strong>如果MIE=0，机器模式下所有的中断都不发生，CPU干自己的事情不被打断。异常能够正常处理(因为是CPU内部问题)</strong></p>
</blockquote>
<p><code>xPIE holds the value of the interrupt enable bit active prior to the trap</code></p>
<p>xPIE表示前一个中断的interrupt enable bit的值</p>
<p><code>xPP holds the privious privilege mode</code></p>
<p>xPP表示前一个privilege mode(从哪个模式跳到哪个模式，U-&gt;M)</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150830544.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415083017474" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150830544.png" /></a></p>
<ol>
<li>
<p>mie / mip：中断的局部使能</p>
</li>
<li>
<p>MEIE、SEIE and UEIE enable <strong>external</strong> interrupt</p>
</li>
<li>MSIE、SSIE &amp; USIE enable <strong>software</strong> interrupts</li>
<li>
<p>MTIE、STIE and UTIE enable <strong>timer</strong> interrupts</p>
</li>
<li>
<p><strong><code>mtvec : Machine Trap-Vector Base-Address Register</code></strong></p>
</li>
</ol>
<p><strong>由 vector base address 和 vector mode 组成 基地址+偏移量</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150820777.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415082014745" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150820777.png" /></a></p>
<p><strong>两个模式，</strong></p>
<ul>
<li>查询模式（异常和中断，默认查询模式）：<strong>一种直接跳转到base</strong></li>
<li>
<p>向量模式（仅外部中断且Mode value = 1）：<strong>另一种和case结合，基地址+偏移量</strong></p>
</li>
<li>
<p><strong><code>mepc：Machine Exception Program Counter</code></strong></p>
</li>
</ul>
<p>异常断点PC地址</p>
<p><strong>exception(内部)： mepc $\leftarrow $ pc</strong></p>
<p><strong>interrupted（外部）: mepc <span class="arithmatex">\(\leftarrow\)</span> pc + 4</strong></p>
<p><strong>最后两位或者最后一位bit是0，保证能被4整除（PC占4字节）</strong></p>
<ol>
<li>mcause：异常原因</li>
</ol>
<p><strong>Exception Code与mtvec的向量模式相对应，在异步中断时，不同的模式会跳转到不同的入口。<code>如果是查询模式呢？都是跳转到Base地址，再根据mcause的值进行相应的处理即可</code></strong></p>
<p><strong>The Exception Code is a WLRL，Write/Read Only Legal Values</strong>
   <strong>如果写入值不合法会引发非法指令异常</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150840073.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415084053007" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150840073.png" /></a></p>
<p>interrupt = 1 表示中断， interrupt = 0， 表示异常</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042017594.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240504201701548" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042017594.png" /></a></p>
<p><strong>Instruction address misaligned PC地址没有对齐，最后一位是1</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150844890.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415084402831" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150844890.png" /></a></p>
<ol>
<li>RISC-V 中断处理——进入异常</li>
</ol>
<p>更新mcause，mepc，mtval，mstatus，停止执行当前的程序流，转而从CSR寄存器mtvec定义的PC的执行中断</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042024590.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240504202426506" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042024590.png" /></a></p>
<ol>
<li>RISC-V中断处理——异常服务程序</li>
</ol>
<p>通过查询mcause中的异常编号跳转到相应的异常服务程序</p>
<ol>
<li>RISC-V中断结构——退出异常</li>
</ol>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042024466.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240504202448402" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405042024466.png" /></a></p>
<p>mpie保存的是进入到中断处理之前的模式，中断处理完后需要返回</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150906517.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240415090615445" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404150906517.png" /></a></p>
<ol>
<li>decoder controller 在译码的时候，检查是否为illegal instruction</li>
<li>
<p>ALU计算出内存地址后，需要送到test logic中检查是否为4的倍数（前提得是load/store指令），也就是是否对齐</p>
</li>
<li>
<p>根据mcause的INT决定 mepc = pc / pc + 4</p>
</li>
</ol>
<p>mcause修改指定位（利用CSRRS）</p>
<h2 id="46-overview-of-pipelining">4.6 Overview of Pipelining<a class="headerlink" href="#46-overview-of-pipelining" title="Permanent link">&para;</a></h2>
<p>流水线：指令的执行在时间是存在重叠，前一条指令还在执行，后一条就开始执行</p>
<blockquote>
<p>Why pipelining</p>
</blockquote>
<p>对于单个工作，流水线技术并没有缩短其运行时间；但是由于多个工作可以并行地执行，流水线技术可以更好地压榨资源，使得它们被同时而不是轮流使用，在工作比较多的时候可以增加整体的 <strong>吞吐率 throughput</strong>，从而减少了完成整个任务的时间。</p>
<h3 id="461-pipelining">4.6.1 Pipelining<a class="headerlink" href="#461-pipelining" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241003011.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424100326931" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241003011.png" /></a></p>
<p>我们可以把每条指令都划分为这么几步：</p>
<ol>
<li><strong>IF</strong>: Instruction fetch from memory 从内存中获取指令</li>
<li><strong>ID</strong>: Instruction decode &amp; register read 读取寄存器、指令译码</li>
<li><strong>EX</strong>: Execute operation or calculate address 计算操作结果和/或地址</li>
<li><strong>MEM</strong>: Access data memory operand 内存存取（如果需要的话）</li>
<li><strong>WB</strong>: Write result back to register 将结果写回寄存器（如果需要的话）</li>
</ol>
<div align=center> <a class="glightbox" href="http://cdn.hobbitqia.cc/202304221628989.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="http://cdn.hobbitqia.cc/202304221628989.png" width = 80%/></a> </div>

<p><span class="arithmatex">\(CPI \approx 1\)</span></p>
<ul>
<li>One instruction will be issued (or finished) each cycle.  每个周期将发出（或完成）一条指令。</li>
<li>During any cycle, one instruction is present in each stage.  在任何周期中，每个阶段都存在一条指令。</li>
</ul>
<h4 id="4611-pipeline-performance">4.6.1.1 Pipeline Performance<a class="headerlink" href="#4611-pipeline-performance" title="Permanent link">&para;</a></h4>
<p>对于单周期 CPU, CPI 是 1, 但时钟周期会很长。    </p>
<p>假设取指令 200ps, 寄存器读 100ps, ALU 计算 200ps, 内存访问 200ps, 寄存器写 100ps.  </p>
<p>那么 <code>add</code> 需要 600ps, <code>ld</code> 需要 800ps, <code>sd</code> 需要 700ps, <code>beq</code> 需要 500ps.   </p>
<p>Longest delay determines clock period. (<code>ld</code>)  </p>
<p>最长延迟决定了时钟周期。（ <code>ld</code> ）</p>
<p>We will improve performance by pipelining.  </p>
<p>我们将通过流水线来提高性能。</p>
<div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241005325.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241005325.png" width = 100%/></a> </div>

<div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241006871.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241006871.png" width = 100%/></a> </div>

<p><strong><code>分阶段进行，每一个阶段200ps</code></strong>不同操作的时间也不同，流水线 CPU 的时钟周期为最长的操作时间。</p>
<p><strong>注意一下此处的Reg，分别表示从寄存器堆中读取和写入，我们将读取放在单个时钟周期的后半部分，写入放在单个时钟周期的前半部分。（先读后写）</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241013143.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424101316073" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241013143.png" /></a></p>
<p><strong><code>各阶段时间均匀，得到的加速效果最好</code></strong></p>
<blockquote>
<p><strong>流水线可以提高吞吐量(throughput)，但是latency不会减少 （<code>反而会增加</code>）。</strong> </p>
<p><strong>但是单条指令在流水线的执行时间比在单周期CPU中的执行时间长，因为流水线每一阶段中间都需要流水线寄存器传输值，造成时间的浪费</strong></p>
</blockquote>
<h4 id="4612-risc-v-isa-designed-for-pipelining">4.6.1.2 RISC-V ISA designed for pipelining<a class="headerlink" href="#4612-risc-v-isa-designed-for-pipelining" title="Permanent link">&para;</a></h4>
<p>RISC-V 适合流水线设计。  </p>
<ul>
<li>All instructions are 32-bits（<strong>指令定长，指令的fetch和decode时间相近</strong>）</li>
</ul>
<p>Easier to fetch and decode in one cycle</p>
<ul>
<li>Few and regular instruction formats  （<strong>指令格式较少</strong>）</li>
</ul>
<p>Can decode and read registers in one step</p>
<ul>
<li>Load/store addressing   </li>
</ul>
<p>Can calculate address in 3rd stage, access memory in 4th stage</p>
<h3 id="462-risc-v-pipelined-datapath">4.6.2 RISC-V Pipelined Datapath<a class="headerlink" href="#462-risc-v-pipelined-datapath" title="Permanent link">&para;</a></h3>
<p>不同阶段之间，我们需要寄存器来保存之前阶段得到的值。  </p>
<p><strong><code>竞争只会发生在从右往左的阶段(寄存器的写回，指令PC的跳转)。</code></strong></p>
<div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241020554.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241020554.png" width = 100%/></a> </div>

<p>注意到，第五个阶段写回时，写寄存器号应该是从 MEM/WB 中的，而不是 IF 出的寄存器号。</p>
<ul>
<li><em>Single-clock-cycle pipeline diagram</em>: Shows pipeline usage in a single cycle; Highlight resources used</li>
</ul>
<p>一个周期一个周期地看</p>
<ul>
<li><em>multi-clock-cycle diagram</em>: Graph of operation over time</li>
</ul>
<p>多个周期将多条指令从上到下放置比较</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241031280.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424103104214" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241031280.png" /></a></p>
<p>为流水线寄存器取名字，前后两个阶段的名字（IF/ID, ID/EX）</p>
<p>如IF/ID，需要保存PC（64位），instruction（32位）</p>
<p>ID/EX，需要保存PC（64），Rs1_data,Rs2_data（64），Imm（64）</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241038280.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424103805221" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241038280.png" /></a></p>
<p>阶段不是划分的越多越好，延迟会增加</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241040898.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241040898.png" /></a></p>
<p>Imbalance有一个阶段的时间特别长（浮点数计算的执行）</p>
<p>overhead流水线寄存器传输数据需要时间</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241043003.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424104351879" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241043003.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241044614.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424104411497" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241044614.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241044343.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424104440226" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241044343.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241045520.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424104501413" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241045520.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241045674.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424104513561" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241045674.png" /></a></p>
<p><strong><code>ID阶段的rd需要向后传递</code></strong>，一直到写回WB阶段，将rd传回到Register File，这样才能正确的写回寄存器</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051424168.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505142422075" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051424168.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051428184.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505142841125" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051428184.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051426474.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505142631408" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051426474.png" /></a></p>
<h3 id="463-pipeline-control">4.6.3 Pipeline Control<a class="headerlink" href="#463-pipeline-control" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051432185.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505142931088" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051432185.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051432139.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505143221042" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051432139.png" /></a></p>
<p>从Control中获得的control信号首先区分分别用于那个阶段，然后依次向后传导到指定阶段</p>
<blockquote>
<p><strong>最终版本</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051436559.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505143637455" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051436559.png" /></a></p>
<h2 id="47-hazards">4.7 Hazards<a class="headerlink" href="#47-hazards" title="Permanent link">&para;</a></h2>
<p>冒险/竞争  ： <strong><code>Situations that prevent starting the next instruction in the next cycle</code></strong></p>
<p><strong><code>阻止在下一个周期中启动下一条指令的情况</code></strong></p>
<p>当前这条指令不能进入下一个阶段，要等待。  </p>
<ul>
<li>Structure hazards   </li>
</ul>
<p>A required resource is busy.  </p>
<ul>
<li>Data hazard  </li>
</ul>
<p>Need to wait for previous instruction to complete its data read/write.  </p>
<ul>
<li>Control hazard  </li>
</ul>
<p>Deciding on control action depends on previous 
  instruction.  </p>
<h3 id="471-structure-hazards">4.7.1 Structure Hazards<a class="headerlink" href="#471-structure-hazards" title="Permanent link">&para;</a></h3>
<p><strong>如果只有一块内存</strong>，但 IF 和 MEM 阶段都需要使用这块内存，那么 IF 就会被 stall 暂停，造成一个 bubble. (即流水线内有一个时刻是清空的，因为没有我们没有去取指令)</p>
<p><strong><code>IF需要从内存中取出指令，load/store操作需要在MEM阶段将数据写入到内存或者从内存中读取数据</code></strong></p>
<blockquote>
<p><strong>Pipelined datapaths require separate instruction/data memories. (Or separate instruction/data caches)</strong></p>
<p><strong>因此，你会发现instruction memory和data memory是分开的</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241128550.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424112814464" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241128550.png" /></a></p>
<p><strong>需要同时使用Reg，分别是将数据写入到目标寄存器和读取目标寄存器，先写后读，上升沿写，下降沿读（double bump）</strong></p>
<p><strong>需要相隔三条指令</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241128435.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424112847359" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241128435.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241136147.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424113636057" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241136147.png" /></a></p>
<p><strong>停顿以解决hazard，可以插入空指令或者将后面的指令全部暂停</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241138476.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240424113801401" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241138476.png" /></a></p>
<h3 id="472-data-hazards">4.7.2 Data Hazards<a class="headerlink" href="#472-data-hazards" title="Permanent link">&para;</a></h3>
<p>An instruction depends on completion of data access by a previous instruction.  <strong>指令取决于先前指令完成数据访问</strong></p>
<blockquote>
<p><strong>Example</strong></p>
</blockquote>
<p><center>
        <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001304.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001304.png" width = 100%/></a> </div>
   </center></p>
<p><strong>注意这里 WB 是在前半个周期将数据写入寄存器, ID 是在后半个周期将数据从寄存器中取出。<code>时钟周期下降沿写入，上升沿读取</code></strong>  </p>
<blockquote>
<p><strong>此处的bubble相当于NOP，什么都不执行，拖延两个时钟周期使得WB和ID在同一个时钟周期，但是写入在下降沿，读取在上升沿，读取建立在写入之后，从而解决data hazards</strong></p>
</blockquote>
<p><strong>但实际上我们要用的结果在 EX 时已经产生了，且为了性能考虑，不允许使用两个bubble，于是使用一下的forward。</strong></p>
<ul>
<li><strong>Forwarding(Bypassing)</strong>  </li>
</ul>
<p>Use result when it is computed  </p>
<div class="highlight"><pre><span></span><code>* Don’t wait for it to be stored in a register
* Requires extra connections in the datapath
</code></pre></div>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041659100.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041659100.png" /></a></p>
<p><strong><code>如上所示，add指令中x1的结果在EX阶段就产生，sub指令中x1在EX阶段被使用，我们只需要在数据通路中进行额外的连接，将add指令EX阶段产生的结果直接传输给sub指令EX阶段即可，这样一个bubble都不需要</code></strong></p>
<p><strong><code>硬件上，ALU的数据来源需要增加，可能来源于前一条指令的ALU_result（对应EX/MEM寄存器），同时由于不加额外数据通路时，需要停两个bubble，所以还会受前一条指令的前一条指令的ALU_result影响（也就是MEM/WB寄存器）。所以ALU的数据来源一共包含：Register， Imm， EX/MEM， MEM/WB，相应的控制信号需要扩充，称之为Forward A/B</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041659921.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240504165938879" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041659921.png" /></a></p>
<p><strong><code>Load指令无法避免bubble，因为load指令只有将结果写入到目标寄存器后（或者说从内存中取出来）才能在下一条指令中得到使用，也就是说sub指令的x1需要在ld指令完成MEM阶段后才能使用。所以需要插入一个bubble，使得上一条的MEM和下一条的EX处于前后关系，再利用额外的数据通路进行传输</code></strong></p>
<p>流水线的 CPI 不可能等于 1, 因为上图这种情况一定会发生(<code>ld</code> 无法避免)。  </p>
<p>可以把后续与这些寄存器无关的指令先拿到这里执行。（乱序执行）</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041700753.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240504170058689" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405041700753.png" /></a></p>
<p>修改前，<code>ld x2, 8(x31)</code>需要一个bubble之后才能执行<code>add x3, x1, x2</code></p>
<p>修改后, <code>ld x2, 8(x0)</code> 后续添加一条与当前发生指令无关的指令，代替原先的bubble，之后直接将x2传输给add指令的EX阶段 <code>add x3, x1, x2</code> 中去。</p>
<h3 id="473-control-hazards">4.7.3 Control Hazards<a class="headerlink" href="#473-control-hazards" title="Permanent link">&para;</a></h3>
<p>Branch determines flow of control</p>
<ul>
<li><strong>Fetching next instruction depends on branch outcome</strong></li>
</ul>
<p><strong>获取下一条指令取决于branch结果</strong></p>
<ul>
<li>Pipeline can’t always fetch correct instruction</li>
</ul>
<p>流水线不能总是获取正确的指令</p>
<p><strong><code>解决方法：1.将比较提前到ID阶段。2.预测是PC+4还是PC+imm</code></strong></p>
<blockquote>
<ol>
<li><strong>将比较提前到ID阶段，并且使用bubble</strong></li>
</ol>
</blockquote>
<p><center>
    <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051409976.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051409976.png" width = 100%/></a> </div>
</center></p>
<p><strong><code>此处判断跳转与否（也就是下一条指令的PC），需要在branch指令完成比较判断之后，这一过程发生在ID阶段。所以下一台指令的instruction fetch需要发生在Reg之后，中间就需要使用一个bubble</code></strong></p>
<blockquote>
<ol>
<li><strong>Branch Prediction 预测是PC+4还是PC+imm</strong>  </li>
</ol>
</blockquote>
<p>更长的流水线不能很早地决定分支结果。  </p>
<p>可以预测 branch 命中或者不命中。  </p>
<ul>
<li><em>Static</em> branch prediction  </li>
</ul>
<p>假设总是命中/不命中</p>
<ul>
<li><em>Dynamic</em> branch prediction  </li>
</ul>
<p>记录上次跑到这里是否命中，然后下次按照之前的结果预测。  </p>
<blockquote>
<p><strong>Summary</strong></p>
<ul>
<li><strong>Pipelining improves performance by increasing instruction throughput</strong>  </li>
</ul>
<p><code>流水线通过提高指令吞吐量来提高性能</code></p>
<ul>
<li>
<p><strong>Executes multiple instructions in parallel</strong></p>
<p>并行执行多条指令</p>
</li>
<li>
<p><strong>Each instruction has the same latency</strong></p>
<p>每条指令具有相同的延迟</p>
</li>
<li>
<p><strong>Subject to hazards(Structure, data, control)</strong></p>
<p><code>易受竞争harzards</code></p>
</li>
<li>
<p><strong>Instruction set design affects complexity of pipeline implementation</strong></p>
</li>
</ul>
<p>指令集设计影响流水线实现的复杂性</p>
</blockquote>
<h2 id="48-data-hazards">4.8 Data Hazards<a class="headerlink" href="#48-data-hazards" title="Permanent link">&para;</a></h2>
<h3 id="481-forwarding">4.8.1 Forwarding<a class="headerlink" href="#481-forwarding" title="Permanent link">&para;</a></h3>
<p><center>
    <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001185.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001185.png" width = 100%/></a> </div>
    <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081025414.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081025414.png" width = 100%/></a> </div>
</center></p>
<p><strong><code>根据上面的多周期指令流程图，你会发现x2在重复使用，范式涉及到从右往左的都会发生data hazards。如果不添加额外的数据通路（上一条指令EX结束之后直接将结果传送到下一条指令EX开始之前，ld指令需要一个bubble，普通R型指令不需要bubble），需要使用两个bubble，恰好能够在下降沿写入数据，上升沿读取数据</code></strong></p>
<blockquote>
<p><strong>如何判断是否需要前递？</strong> </p>
<p><strong>判断当前指令所需读取的rs寄存器是不是上一条指令和上一条的上一条指令需要写入的rd寄存器</strong></p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051505584.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505150545477" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051505584.png" /></a></p>
<p>Data hazards when</p>
<ol>
<li>
<ul>
<li><code>EX/MEM.RegisterRd = ID/EX.RegisterRs1</code>  </li>
</ul>
<p>在第四个时钟周期时把 EX/MEM 的寄存器值送到 ALU. </p>
</li>
<li>
<p><code>EX/MEM.RegisterRd = ID/EX.RegisterRs2</code></p>
</li>
<li>
<p><code>MEM/WB.RegisterRd = ID/EX.RegisterRs1</code></p>
</li>
<li>
<p><code>MEM/WB.RegisterRd = ID/EX.RegisterRs2</code></p>
</li>
<li>
<p><strong>只有在我们要使用在前面指令值发生改变的寄存器的值的时候，data hazard才会发生</strong>（有些指令可能根本就不会写回寄存器，没有有效的 Rd）   </p>
</li>
</ol>
<p><strong><code>EX/MEM.RegWrite, MEM/WB.RegWrite = 1</code>.</strong>  </p>
<ol>
<li>此外 <code>EX/MEM.RegisterRd, MEM/WB.RegisterRd</code> 也不能为 0. </li>
</ol>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051516032.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505151614901" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051516032.png" /></a></p>
<p><strong><code>Forwarding unit用于detect data hazards，所以需要读入ID/EX的Rs1，Rs2，EX/MEM和MEM/WB的Rd，同时还需要EX/MEM的RegWrite，MEM/WB的RegWrite。</code></strong></p>
<p><strong>如果Rs1/Rs2都不等于上述两个Rd，意味着不发生data hazard，所以forwardA = 00，表示选取register file或者imm</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">Mux control</th>
<th>Source</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>ForwardA = 00</code></td>
<td>ID/EX</td>
<td>The first ALU operand comes from the <strong>register file</strong>.</td>
</tr>
<tr>
<td style="text-align: left;"><code>ForwardA = 10</code></td>
<td>EX/MEM</td>
<td>The first ALU operand is forwarded <strong>from the prior ALU result</strong>.</td>
</tr>
<tr>
<td style="text-align: left;"><code>ForwardA = 01</code></td>
<td>MEM/WB</td>
<td>The first ALU operand is forwarded from <strong>data memory or an earlier ALU result</strong>.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Example "Double Data Hazard"</strong></p>
</blockquote>
<p><strong><code>既有可能EX/MEM.RegisterRd = ID/EX.RegisterRs1，又有可能MEM/WB.RegisterRd = ID/EX.RegisterRs1</code></strong></p>
<p><center>
        <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001199.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001199.png" width = 50%/></a> </div>
</center>
<strong><code>第三条指令的rs和前两条指令的rd都相等。那优先选择最新的结果，也就是上一条指令的ALU_result，所以需要优先判断EX/MEM RegisterRd是不是等于ID/EX RegisterRs</code></strong></p>
<p>我们前递时要加一个条件，<strong>只有在 EX/MEM 的条件不成立时</strong>，才能查看 MEM/WB 的条件。</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051533089.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505153307985" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051533089.png" /></a></p>
<div class="highlight"><pre><span></span><code>MEM hazard
if( MEM/WB.RegWrite == 1
    and MEM/WB.RegisterRd != 0
    and MEM/WB.RegisterRd == ID/EX.Register1/2
    and (EX/MEM.RegWrite == 0 or EX/MEM.RegisterRd == 0 or EX/MEM.RegisterRd != ID/EX.RegisterRs1/2))
</code></pre></div>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051534498.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505153407393" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051534498.png" /></a></p>
<blockquote>
<p><strong><code>与ALU相关的data hazard，添加一个forwarding unit，更新ALU的mux</code></strong></p>
<p><strong><code>store相关的data harzard，add x5，x2，x3  store x5, 0(x6).store指令执行MEM阶段时，EX/MEM只能计算出store的地址，但是store的值x5还没有写入到x5，所以需要添加forward（额外数据通路），将MEM/WB的ALU_result传递给MEM的write_data.</code></strong></p>
<p><strong><code>相应的Store相关的data hazard，也需要一个forwarding unit，并且在data memory的write_data前面加上mux。data hazard的条件是 memWrite = 1， 且EX/MEM的Register Rs2与上一条指令MEM/WB的rd相等</code></strong></p>
</blockquote>
<h3 id="482-load-use-hazard-detection">4.8.2 Load-Use Hazard Detection<a class="headerlink" href="#482-load-use-hazard-detection" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051535148.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505153548018" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051535148.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051537581.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505153726497" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051537581.png" /></a></p>
<hr />
<hr />
<p><strong><code>为什么是ID/EX.RegisterRd = IF/ID.RegisterRs1呢？因为load指令存在WB环节，RegisterRd需要在load指令中层层传递一直到WB环节将RegisterRd传回到后面指令的IF/ID阶段（在该阶段完成目标寄存器的写入）。一旦发生ID/EX.RegisterRd = IF/ID.RegisterRs,说明当前指令的源寄存器与上一条指令的目标寄存器存在数据冲突</code></strong></p>
<p><strong>如果我们在 ld 指令 EX/MEM 时暂停，此时 ld 后面有两条指令需要暂停，其实我们可以更早的发现这个问题（也就是ID/EX阶段）。</strong></p>
<div class="highlight"><pre><span></span><code>Load-use hazard when

    (ID/EX.MemRead == 1)
    and ((ID/EX.RegisterRd = IF/ID.RegisterRs1) 
    or (ID/EX.RegisterRd = IF/ID.RegisterRs2))`
</code></pre></div>
<p>If detected, stall and insert bubble</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081101555.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508110113437" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081101555.png" /></a></p>
<p>第一条指令和第二条指令之间必须添加一个Bubble</p>
<p>第一条指令和第三条指令之间通过forward实现（流水线，前提是没有bubble）</p>
<p>第一条指令和第四条指令之间刚好（隔两条指令），Reg先写后读</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051540550.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505154013491" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051540550.png" /></a></p>
<hr />
<p><strong>加加条件检查load的hazard</strong></p>
<p><strong><code>插入bubble意味着bubble指令不执行任何操作，于是让所有在ID/EX Register中的控制信号为0，IF/ID 寄存器不变，这样后续EX，MEM，WB阶段都不执行任何操作</code></strong></p>
<p><strong><code>同时还需要防止更新PC和IF/ID寄存器，重新获取load指令后面的那一条指令，重新decode</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051554908.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051554908.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051556413.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240505155609175" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405051556413.png" /></a></p>
<p><strong><code>添加一个Hazard detection unit，输入ID/EX.MemRead（区分R型指令，增加了从内存中读取数据的MEM阶段）, ID/EX.RegisterRd, IF/ID.RegisterRs1/2</code></strong></p>
<p><strong><code>输出结果包括PCWrite控制PC是否改变，IF/ID Write控制下一条指令是否decode，另外一个控制信号输送到ID/EX寄存器前的Mux，一旦发生data hazard，就把ID/EX寄存器中的控制信号全部置为0</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081117181.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508111708115" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081117181.png" /></a></p>
<h3 id="483-stalls-and-performance">4.8.3 Stalls and Performance<a class="headerlink" href="#483-stalls-and-performance" title="Permanent link">&para;</a></h3>
<ul>
<li>Stalls reduce performance<ul>
<li>But are required to get correct results</li>
</ul>
</li>
<li>Compiler can arrange code to avoid hazards and stalls</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081118268.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081118268.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081119457.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508111935386" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081119457.png" /></a></p>
<ol>
<li>double bump 寄存器先写后读</li>
<li>forward 前递</li>
<li>compiler scheduling 编译器调度，调整指令的顺序，减少出现stall</li>
<li>Stall</li>
</ol>
<h2 id="49-branch-hazards">4.9 Branch Hazards<a class="headerlink" href="#49-branch-hazards" title="Permanent link">&para;</a></h2>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130828981.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240513082830891" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130828981.png" /></a></p>
<p><strong><code>决定是否跳转发生在MEM环节，此环节Branch控制信号和ALU_zero信号共同决定PC是否等于PC+imm。</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130830838.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240513083027755" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130830838.png" /></a></p>
<p><strong><code>观察上图发现，branch指令在MEM阶段决定是否跳转，决定PC是否等于PC+imm。真正发生跳转已经达到WB阶段（执行最新的PC指令），那么对应的中间就相隔三条指令，意味着这三条指令应当不能执行，需要将它flush掉，</code></strong></p>
<p><strong><code>设置所有的控制信号为0.中间的三条指令是否产生影响，关键在于是否改变了寄存器，是否在内存中发生了写入</code></strong></p>
<ul>
<li>最朴素的方法是无视这种情况，因为前三个阶段并不涉及对寄存器和内存修改，即使我们预测后续不执行这些指令也不会带来影响。但这样可能带来 CPI 的显著增加。</li>
</ul>
<p><strong><code>此处是想说明：当Branch执行到MEM阶段时，后面三条指令执行到的阶段分别为EX，ID，IF，并不会发生修改内存中的数据（MEM）和修改寄存器的值（WB）的操作，所以并不会带来什么负面影响，</code></strong></p>
<ul>
<li>一种方法是在 ID 级决定是否跳转（此时已经有了两个源操作数和立即数）</li>
</ul>
<p><center>
        <div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001287.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001287.png" width = 100%/></a> </div>
   </center>
这样我们只可能多余一条指令，插入 bubble 即可。但是这样也不可接受。</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081125777.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508112523683" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081125777.png" /></a></p>
<h3 id="491-stall">4.9.1 stall<a class="headerlink" href="#491-stall" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081135789.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508113501685" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081135789.png" /></a></p>
<ul>
<li>Flushing the pipeline</li>
</ul>
<p><strong><code>让后面三条指令的控制信号为0即可，stall</code></strong></p>
<ul>
<li>
<blockquote>
<p>problem：With a 30% branch frequency and an ideal CPI of 1, how much the
performance is by inserting stalls ?</p>
<p>Answer: <span class="arithmatex">\(CPI = 1+ 0.3 \times 3＝1.9\)</span></p>
</blockquote>
</li>
</ul>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081137016.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508113718874" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081137016.png" /></a>、<a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081137695.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508113736477" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081137695.png" /></a></p>
<h3 id="492-predict-untakentaken">4.9.2 Predict-untaken/taken<a class="headerlink" href="#492-predict-untakentaken" title="Permanent link">&para;</a></h3>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081138228.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508113847122" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081138228.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081140314.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114050262" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081140314.png" /></a></p>
<p><strong>假定始终不跳转，发现错误后，将额外执行的三条指令冲掉</strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081140491.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114030417" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081140491.png" /></a></p>
<p>最新的CPI就是，只需要计算跳转的branch指令带来的额外CPI
$$
CPI = 1 + br\% \times take \% \times 3
$$</p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081141470.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114141380" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081141470.png" /></a></p>
<p><strong><code>branch_signal计算提前到ID阶段，添加ALU计算出跳转地址，比较Rs1和Rs2的值</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081145540.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114519473" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081145540.png" /></a></p>
<p><strong><code>提前计算branch_signal，原先决定是否跳转发生在MEM阶段，现在决定是否跳转发生在ID阶段，减少了中间的EX和MEM阶段，这意味着两个指令能够得到释放，只需要添加一个bubble，减少branch的delay</code></strong></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081146689.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114605609" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081146689.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081146750.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508114618696" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081146750.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130928620.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240513092817559" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405130928620.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081154401.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240508115433332" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405081154401.png" /></a></p>
<div class="highlight"><pre><span></span><code>ld  x1, addr
add x4, x5, x6
beq stalled
beq x1, x4, target
</code></pre></div>
<p><strong>需要在beq指令之前添加一个stall。因为beq指令需要的源寄存器是ld指令的目标寄存器。所以需要等到ld完成WB之后才能进行beq的instruction decoder。</strong></p>
<p><strong>因此ld指令的WB阶段和beq指令的ID阶段对应，执行先写后读的操作。两者需要相差MEM，EX阶段，对应的就需要两条指令作为间隔，除去add指令外，还需要一个bubble</strong></p>
<div class="highlight"><pre><span></span><code>ld  x1, addr
beq stalled
beq stalled
beq x1, x4, target
</code></pre></div>
<p><strong><code>load和branch挨着，需要停两个bubble</code></strong></p>
<h3 id="493-static-branch-prediction">4.9.3 Static branch prediction<a class="headerlink" href="#493-static-branch-prediction" title="Permanent link">&para;</a></h3>
<p>一般用于for循环，直接假设所有的branch指令都不跳转或者都跳转。</p>
<h3 id="494-dynamic-branch-prediction">4.9.4 Dynamic Branch Prediction<a class="headerlink" href="#494-dynamic-branch-prediction" title="Permanent link">&para;</a></h3>
<p>In deeper and superscalar(多发射) pipelines, branch penalty is more significant.  </p>
<p>Use <strong>dynamic prediction</strong>.  </p>
<ul>
<li>Branch prediction buffer (aka branch history table)   </li>
</ul>
<p>记录前几次是否命中</p>
<ul>
<li>
<p>Indexed by recent branch instruction addresses</p>
</li>
<li>
<p>Stores outcome (taken/not taken)</p>
</li>
<li>
<p>To execute a branch</p>
<ul>
<li>Check table, expect the same outcome</li>
<li>Start fetching from fall-through or target</li>
<li>If wrong, flush pipeline and flip prediction</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>动态预测，看前一次branch是否taken，如果发生就预测本次也发生，不发生就预测本次也不发生。可以处理 for 循环的预测。</strong></p>
<p><strong>建立一个branchprediction buffer，跳转预测缓冲区，用最近的branch指令地址为索引，存储taken或者not taken。当执行branch指令时，检查table，取最近的branch结果作为预测。</strong>  </p>
<p>Note "1-Bit Predictor"</p>
<p>但也存在问题，对于双层循环，当内层循环要结束时会错两次。</p>
<p><strong><code>对应情形为：在内循环的最后一次操作，按照前一次的预测，需要继续跳转，但是实际上应当返回到外循环（也就是顺序执行i=i+1），预测错误。之后需要从外循环跳转到内循环，按照前一次的预测，不执行跳转，但是实际上应该跳转，所以预测错误。发生两次预测错误</code></strong></p>
</blockquote>
<div align=center> <a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001363.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202404241001363.png" width = 45%/></a> </div>

<ul>
<li>Mispredict as taken on last iteration of inner loop</li>
</ul>
<p>错误预测，如内循环的最后一次迭代</p>
<ul>
<li>Then mispredict as not taken on first iteration of inner loop next time around</li>
</ul>
<p><strong>可以修改预测方式：只有连续错误两次才会修改我们的预测。即 2-Bit Predictor.</strong> </p>
<div align=center> <a class="glightbox" href="http://cdn.hobbitqia.cc/202305020908092.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="http://cdn.hobbitqia.cc/202305020908092.png" width = 60%/></a> </div>

<blockquote>
<p><strong>Calculating the Branch Target</strong></p>
</blockquote>
<p>即使 branch 命中了，我们也有一个时钟的 bubble 来计算地址。  </p>
<p><strong>但 branch 要跳转的地址其实是可以存下来的</strong>。  </p>
<p>Branch target buffer</p>
<ul>
<li>Cache of target addresses</li>
</ul>
<p><strong><code>存储最近最新用到的，老的会被删除</code></strong></p>
<ul>
<li>Indexed by PC when instruction fetched  获取指令时由 PC 索引</li>
</ul>
<p>If hit and instruction is branch predicted taken, can fetch target immediately</p>
<p>如果命中并预测分支采取指令，则可以立即获取目标</p>
<h2 id="410-exception-in-pipeline">4.10 Exception in pipeline<a class="headerlink" href="#410-exception-in-pipeline" title="Permanent link">&para;</a></h2>
<h3 id="4101-single-exception">4.10.1 Single Exception<a class="headerlink" href="#4101-single-exception" title="Permanent link">&para;</a></h3>
<blockquote>
<p><strong>流水线的异常类似于Control Hazards，流水线的异常需要flush掉异常发生时所有会改变内存或者寄存器的指令。</strong></p>
</blockquote>
<p>如果overflow发生在add指令的EX阶段（add x1，x2，x1），该怎么办？</p>
<ul>
<li>Prevent x1 from being clobbered 防止 x1 value发生改变</li>
<li>Complete previous instructions 完成add指令之前的指令</li>
<li>Flush add and subsequent instructions 将add指令和add指令之后的指令全部flush掉</li>
<li>Set Cause and SEPC register values 设置Scause和SCEP，进入异常解决</li>
<li>Transfer control to handler 将控制权交给处理程序</li>
</ul>
<blockquote>
<ol>
<li>
<p><strong>Pipeline can flush the instruction</strong></p>
</li>
<li>
<p><strong>Handler executes, then returns to the instruction</strong></p>
</li>
<li><strong>Refetched and executed from scratch  从头开始重新获取和执行</strong></li>
</ol>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142041256.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240514204111143" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142041256.png" /></a></p>
<p><strong><code>发现PC是从ID/EX寄存器传输给SEPC的，说明PC随着流水线依次传递。因为此时add处于EX阶段，说明add的下一条指令位于ID阶段，再下一条指令位于IF阶段，存在Branch指令的可能，PC的值变为PC+imm，此时如果PC不依次传递，无法通过当前PC的值计算出add对应的PC值</code></strong></p>
<blockquote>
<p>example</p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142046130.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240514204651080" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142046130.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142047037.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240514204738003" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142047037.png" /></a></p>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142048701.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240514204817651" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142048701.png" /></a></p>
<p><strong>一旦异常发生，首先你会看到PC的mux增加了一个输入，1C090000，也就是解决程序的初始地址，需要跳转到该地址。</strong></p>
<p><strong>执行flush操作，将add指令和后面的sub，ld指令全部变为bubble。or指令在add指令之前所以依然执行。将add指令的地址4C存到SEPC中。</strong></p>
<blockquote>
<p><strong><code>指令非法在IF阶段就可以判别进行处理，外部中断的话，将流水线的所有指令处理完毕之后再处理中断</code></strong></p>
</blockquote>
<h3 id="4102-multiple-exxceptions">4.10.2 Multiple Exxceptions<a class="headerlink" href="#4102-multiple-exxceptions" title="Permanent link">&para;</a></h3>
<p>Pipelining overlaps multiple instructions </p>
<ul>
<li>Could have multiple exceptions at once</li>
</ul>
<p><strong><code>五级流水线，包含多条指令，存在多条指令同时发生异常的情况</code></strong></p>
<p>Simple approach: deal with exception from earliest instruction</p>
<ul>
<li>
<p>Flush subsequent instructions</p>
</li>
<li>
<p>“Precise” exceptions</p>
</li>
</ul>
<p><strong><code>解决方法：精确处理。优先解决最早发生的指令的异常（指令的完成顺序和发生顺序相同），flush掉异常指令后续的指令（异常也随之解决）。</code></strong></p>
<p>In complex pipelines</p>
<ul>
<li>
<p>Multiple instructions issued per cycle</p>
</li>
<li>
<p>Out-of-order completion</p>
</li>
<li>
<p>Maintaining precise exceptions is difficult!</p>
</li>
</ul>
<p><strong><code>但是复杂流水线中，存在着一个时间周期存在多条指令，以及指令的乱序完成（完成顺序不依照开始执行顺序），导致prrcise exception的解决方法很难执行</code></strong></p>
<blockquote>
<p>此时只能执行 imprecise Exception</p>
</blockquote>
<p><a class="glightbox" href="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142104801.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240514210414764" src="https://zn-typora-image.oss-cn-hangzhou.aliyuncs.com/typora_image/202405142104801.png" /></a></p>
<p><strong>发生中断时，怎么处理由中断处理程序决定，这就导致硬件部分得到简化，但是软件部分复杂化</strong></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy 2024 rescuerz
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.expand", "navigation.top", "search.highlight", "search.share", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../supports/js/xlink.js"></script>
      
        <script src="../../supports/js/katex.js"></script>
      
        <script src="https://jsd.cdn.zzko.cn/npm/katex@0.16.4/dist/katex.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>